<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mage Knight Companion â€” Draw / End Round Fixed</title>
  <style>
    :root{
      --bg:#f4f4f4; --panel:#ececec; --card:#ffffff; --cell:#e8e8e8;
      --rep-min:44px; --overlay: rgba(0,0,0,0.45);
      --gold:#ffd700; --yellow:#ffeb99; --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:#111;padding:12px}
    h1{font-size:18px;margin:0 0 12px;text-align:center}
    .container{max-width:980px;margin:0 auto;display:flex;flex-direction:column;gap:12px}
    .panel{background:var(--panel);border-radius:10px;padding:10px}
    .panel-inner{background:var(--card);border-radius:8px;padding:12px;display:flex;flex-direction:column;gap:10px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type=number]{width:120px;padding:8px;border-radius:6px;border:1px solid #ccc;text-align:center}
    .smallbtn{padding:6px 10px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer}
    .muted{color:#666;font-size:13px}

    /* Reputation track */
    .rep-wrap{display:flex;flex-direction:column;gap:8px;align-items:center}
    .rep-row{display:flex;gap:8px;justify-content:center;align-items:center}
    .rep-cell{min-width:var(--rep-min);padding:6px 10px;background:var(--cell);border-radius:6px;text-align:center;cursor:pointer;user-select:none}
    .rep-row.top .rep-cell.selected{background:var(--gold);font-weight:700;color:#111}
    .rep-row.mid .rep-cell.selected{background:var(--yellow);font-weight:700;color:#111}
    .rep-row.bot .rep-cell.selected{background:var(--danger);font-weight:700;color:#fff}

    /* Levels Achieved */
    .levels-list{background:#fff;padding:8px;border-radius:6px;min-height:36px;display:flex;gap:6px;flex-wrap:wrap}
    .level-pill{background:#eef;padding:6px 8px;border-radius:999px;font-weight:600;font-size:13px}

    .output{background:#fff;padding:8px;border-radius:6px;min-height:36px;font-size:14px}

    .center{display:flex;align-items:center;justify-content:center;gap:8px}
    .center-column{display:flex;flex-direction:column;align-items:center;gap:6px}

    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:var(--overlay);z-index:60}
    .modal{background:#fff;border-radius:10px;padding:16px;max-width:520px;width:92%;box-shadow:0 8px 30px rgba(0,0,0,0.25)}
    .modal h3{margin:0 0 8px 0;font-size:16px}
    .modal p{margin:8px 0;font-size:14px;white-space:pre-wrap}
    .choice-row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .choice-btn{padding:8px 10px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer}
    .choice-btn.selected{background:#eef6e9;border-color:#9fd49f}

    footer{display:flex;justify-content:center;padding:8px 0}
    @media (max-width:700px){ input[type=number]{width:90px} :root{--rep-min:34px} }
  </style>
</head>
<body>
  <h1>Mage Knight Companion</h1>

  <div class="container">

    <!-- Reputation -->
    <section class="panel" aria-labelledby="rep-title">
      <div class="panel-inner">
        <h2 id="rep-title">Reputation Track</h2>
        <div id="rep-wrap" class="rep-wrap" aria-label="Reputation track"></div>
      </div>
    </section>

    <!-- Fame + Levels Achieved -->
    <section class="panel" aria-labelledby="fame-title">
      <div class="panel-inner">
        <h2 id="fame-title">Fame Track</h2>

        <div class="center-column" style="width:100%">
          <div class="center" style="width:100%;margin-bottom:6px">
            <div style="text-align:center">
              <label style="font-weight:700;display:block;margin-bottom:6px">Player Fame</label>
              <input id="fame-input" type="number" min="0" max="119" value="0" aria-label="Fame value" />
            </div>

            <div style="width:18px"></div>

            <div style="text-align:center">
              <label style="font-weight:700;display:block;margin-bottom:6px">Player Level</label>
              <div id="player-level" class="output" style="min-width:80px;text-align:center">1</div>
            </div>
          </div>

          <div class="center" style="width:100%">
            <div>
              <button class="smallbtn fame-inc" data-inc="1">+1 Fame</button>
              <button class="smallbtn fame-inc" data-inc="2">+2 Fame</button>
              <button class="smallbtn fame-inc" data-inc="3">+3 Fame</button>
              <button class="smallbtn fame-inc" data-inc="5">+5 Fame</button>
              <button class="smallbtn fame-inc" data-inc="10">+10 Fame</button>
            </div>
          </div>
        </div>

        <div style="width:100%;margin-top:10px">
          <h3 style="margin:8px 0 6px 0">Levels Achieved</h3>
          <div id="levels-list" class="levels-list" aria-live="polite">None yet</div>
        </div>
      </div>
    </section>

    <!-- Dummy player area (crystals/cards/ deck) -->
    <section class="panel" aria-labelledby="dummy-title">
      <div class="panel-inner">
        <h2 id="dummy-title">Dummy Player</h2>

        <div class="row" style="gap:18px">
          <div>
            <h3 style="margin:0 0 6px 0">Crystals</h3>
            <div class="row" style="align-items:center">
              <div>ðŸ”´ <strong id="red">0</strong></div>
              <div><button class="smallbtn" data-crystal="red" data-act="inc">+</button><button class="smallbtn" data-crystal="red" data-act="dec">âˆ’</button></div>
              <div style="width:12px"></div>
              <div>ðŸ”µ <strong id="blue">0</strong></div>
              <div><button class="smallbtn" data-crystal="blue" data-act="inc">+</button><button class="smallbtn" data-crystal="blue" data-act="dec">âˆ’</button></div>
              <div style="width:12px"></div>
              <div>ðŸŸ¢ <strong id="green">0</strong></div>
              <div><button class="smallbtn" data-crystal="green" data-act="inc">+</button><button class="smallbtn" data-crystal="green" data-act="dec">âˆ’</button></div>
              <div style="width:12px"></div>
              <div>âšª <strong id="white">0</strong></div>
              <div><button class="smallbtn" data-crystal="white" data-act="inc">+</button><button class="smallbtn" data-crystal="white" data-act="dec">âˆ’</button></div>
            </div>
          </div>

          <div>
            <h3 style="margin:0 0 6px 0">Cards</h3>
            <div class="row" style="align-items:center;gap:12px">
              <div>ðŸ”´ <strong id="card-red">4</strong></div>
              <div><button class="smallbtn card-btn" data-color="Red" data-act="inc">+</button><button class="smallbtn card-btn" data-color="Red" data-act="dec">âˆ’</button></div>

              <div>ðŸ”µ <strong id="card-blue">4</strong></div>
              <div><button class="smallbtn card-btn" data-color="Blue" data-act="inc">+</button><button class="smallbtn card-btn" data-color="Blue" data-act="dec">âˆ’</button></div>

              <div>ðŸŸ¢ <strong id="card-green">4</strong></div>
              <div><button class="smallbtn card-btn" data-color="Green" data-act="inc">+</button><button class="smallbtn card-btn" data-color="Green" data-act="dec">âˆ’</button></div>

              <div>âšª <strong id="card-white">4</strong></div>
              <div><button class="smallbtn card-btn" data-color="White" data-act="inc">+</button><button class="smallbtn card-btn" data-color="White" data-act="dec">âˆ’</button></div>
            </div>

            <div style="margin-top:8px" class="muted">Cards in deck: <strong id="deck-count">0</strong></div>
          </div>
        </div>

        <div style="margin-top:10px" class="row">
          <button id="draw-btn" class="smallbtn">Draw</button>
          <div id="dummy-output" class="output" style="flex:1;margin-left:8px">Drawn symbols appear here</div>
        </div>

        <div style="margin-top:8px">
          <div id="discard-output" class="output">Discard pile is empty.</div>
          <div style="margin-top:8px;display:flex;justify-content:center">
            <button id="reshuffle-btn" class="smallbtn">Reshuffle Deck</button>
          </div>
        </div>
      </div>
    </section>

    <footer>
      <button id="new-game" class="smallbtn">New Game</button>
    </footer>
  </div>

  <!-- End round modal for choosing crystal/card when end of round occurs -->
  <div id="endround-modal" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="endround-title">
      <h3 id="endround-title">End Round â€” Choose Additions</h3>
      <p>Choose one crystal and one card to add to the dummy player. This will then reshuffle the discard into the deck</p>

      <div style="margin-top:8px">
        <div style="font-weight:600;margin-bottom:6px">Choose crystal</div>
        <div id="crystal-choices" class="choice-row">
          <button class="choice-btn" data-val="red">ðŸ”´</button>
          <button class="choice-btn" data-val="blue">ðŸ”µ</button>
          <button class="choice-btn" data-val="green">ðŸŸ¢</button>
          <button class="choice-btn" data-val="white">âšª</button>
        </div>
      </div>

      <div style="margin-top:8px">
        <div style="font-weight:600;margin-bottom:6px">Choose card</div>
        <div id="card-choices" class="choice-row">
          <button class="choice-btn" data-val="Red">ðŸ”´</button>
          <button class="choice-btn" data-val="Blue">ðŸ”µ</button>
          <button class="choice-btn" data-val="Green">ðŸŸ¢</button>
          <button class="choice-btn" data-val="White">âšª</button>
        </div>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="endround-cancel" class="smallbtn">Cancel</button>
        <button id="endround-confirm" class="smallbtn" disabled>Confirm</button>
      </div>
    </div>
  </div>

  <!-- Level modal (combined prompts) -->
  <div id="level-modal" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="lvl-title">
      <h3 id="lvl-title">Level Up</h3>
      <p id="level-message"></p>
      <div style="display:flex;justify-content:flex-end;margin-top:12px">
        <button id="level-ok" class="smallbtn">OK</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'mk_companion_state_v1';
    const DEFAULT_CARDS = { Red: 4, Blue: 4, Green: 4, White: 4 };
    const DEFAULT_CRYSTALS = { red: 0, blue: 0, green: 0, white: 0 };

    const REP_TOP = ["0","+1","+1","+2","+2","+3","+5"];
    const REP_MID = ["0"];
    const REP_BOT = ["0","-1","-1","-2","-3","-5","X"];

    const FAME_LEVELS = [
      {level:1, min:0,  max:2},
      {level:2, min:3,  max:7},
      {level:3, min:8,  max:14},
      {level:4, min:15, max:23},
      {level:5, min:24, max:34},
      {level:6, min:35, max:47},
      {level:7, min:48, max:62},
      {level:8, min:63, max:79},
      {level:9, min:80, max:98},
      {level:10,min:99, max:119}
    ];

    const LEVEL_PROMPTS = {
      2: "Draw skill and advanced action",
      3: "Flip level token to command token",
      4: "Draw skill and advanced action",
      5: "Flip level token to command token",
      6: "Draw skill and advanced action",
      7: "Flip level token to command token",
      8: "Draw skill and advanced action",
      9: "Flip level token to command token",
      10: "Draw skill and advanced action"
    };

    const COLOR_SYMBOL = { Red:'ðŸ”´', Blue:'ðŸ”µ', Green:'ðŸŸ¢', White:'âšª', red:'ðŸ”´', blue:'ðŸ”µ', green:'ðŸŸ¢', white:'âšª' };

    // State
    let fame = 0;
    let crystals = { ...DEFAULT_CRYSTALS };
    let cardCounts = { ...DEFAULT_CARDS };
    let dummyDeck = [];
    let discardPile = [];
    let endRoundFlag = false;
    let achievedLevels = []; // chronological
    let repSelection = null;

    // DOM
    const repWrap = document.getElementById('rep-wrap');
    const fameInput = document.getElementById('fame-input');
    const playerLevelEl = document.getElementById('player-level');
    const levelsList = document.getElementById('levels-list');
    const levelModal = document.getElementById('level-modal');
    const levelMessage = document.getElementById('level-message');
    const levelOk = document.getElementById('level-ok');
    const newGameBtn = document.getElementById('new-game');
    const drawBtn = document.getElementById('draw-btn');
    const dummyOutput = document.getElementById('dummy-output');
    const discardOutput = document.getElementById('discard-output');
    const reshuffleBtn = document.getElementById('reshuffle-btn');

    const endroundModal = document.getElementById('endround-modal');
    const crystalChoices = document.getElementById('crystal-choices');
    const cardChoices = document.getElementById('card-choices');
    const endroundConfirm = document.getElementById('endround-confirm');
    const endroundCancel = document.getElementById('endround-cancel');

    let selectedCrystal = null;
    let selectedCard = null;

    // Helpers
    function clampInt(v,min,max){ const n=Math.floor(Number(v)||0); return Math.max(min,Math.min(max,n)); }
    function getFameLevel(v){
      const val = clampInt(v,0,119);
      for (const b of FAME_LEVELS) if (val >= b.min && val <= b.max) return b.level;
      return 1;
    }

    // Persistence
    function saveState(){
      try {
        const s = { fame, crystals, cardCounts, dummyDeck, discardPile, endRoundFlag, achievedLevels, repSelection };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
      } catch(e){}
    }
    function loadState(){
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return false;
        const s = JSON.parse(raw);
        fame = typeof s.fame === 'number' ? s.fame : fame;
        crystals = s.crystals || crystals;
        cardCounts = s.cardCounts || cardCounts;
        dummyDeck = Array.isArray(s.dummyDeck) ? s.dummyDeck : dummyDeck;
        discardPile = Array.isArray(s.discardPile) ? s.discardPile : discardPile;
        endRoundFlag = !!s.endRoundFlag;
        achievedLevels = Array.isArray(s.achievedLevels) ? s.achievedLevels : achievedLevels;
        repSelection = s.repSelection || repSelection;
        return true;
      } catch(e){ return false; }
    }
    function clearSavedState(){ try { localStorage.removeItem(STORAGE_KEY); } catch(e){} }

    // Reputation UI
    function buildRepRows(){
      repWrap.innerHTML = '';
      const top=document.createElement('div'); top.className='rep-row top';
      REP_TOP.forEach((label,i)=>{ const c=document.createElement('div'); c.className='rep-cell'; c.textContent=label;
        c.addEventListener('click', ()=>{ selectRepCell({row:'top',index:i}); saveState(); }); top.appendChild(c);
      });
      const mid=document.createElement('div'); mid.className='rep-row mid';
      REP_MID.forEach((label,i)=>{ const c=document.createElement('div'); c.className='rep-cell'; c.textContent=label;
        c.addEventListener('click', ()=>{ selectRepCell({row:'mid',index:i}); saveState(); }); mid.appendChild(c);
      });
      const bot=document.createElement('div'); bot.className='rep-row bot';
      REP_BOT.forEach((label,i)=>{ const c=document.createElement('div'); c.className='rep-cell'; c.textContent=label;
        c.addEventListener('click', ()=>{ selectRepCell({row:'bot',index:i}); saveState(); }); bot.appendChild(c);
      });
      repWrap.appendChild(top); repWrap.appendChild(mid); repWrap.appendChild(bot);
      if (repSelection) applyRepSelection(repSelection);
      else { const midCell = repWrap.querySelector('.rep-row.mid .rep-cell'); if (midCell) { midCell.classList.add('selected'); repSelection={row:'mid',index:0}; } }
    }
    function selectRepCell(sel){
      const all = repWrap.querySelectorAll('.rep-cell'); all.forEach(c=>c.classList.remove('selected'));
      const rowEl = repWrap.querySelector(`.rep-row.${sel.row}`); if(!rowEl) return;
      const cells = rowEl.querySelectorAll('.rep-cell'); if(cells[sel.index]){ cells[sel.index].classList.add('selected'); repSelection={...sel}; }
    }
    function applyRepSelection(sel){ if(!sel) return; const rowEl=repWrap.querySelector(`.rep-row.${sel.row}`); if(!rowEl) return;
      const cells=rowEl.querySelectorAll('.rep-cell'); if(cells[sel.index]) cells[sel.index].classList.add('selected');
    }

    // Levels UI
    function renderLevels(){
      levelsList.innerHTML='';
      if(!achievedLevels || achievedLevels.length===0){ levelsList.textContent='None yet'; return; }
      achievedLevels.forEach(L=>{
        const pill=document.createElement('div'); pill.className='level-pill';
        const prompt = LEVEL_PROMPTS[L] ? ` â€” ${LEVEL_PROMPTS[L]}` : '';
        pill.textContent = `Level ${L}${prompt}`;
        levelsList.appendChild(pill);
      });
    }

    // Fame UI and prompt handling
    function handleLevelPrompts(prevLevel,newLevel){
      const messages=[];
      for(let L=prevLevel+1; L<=newLevel; L++) if(LEVEL_PROMPTS[L]) messages.push(`Level ${L}: ${LEVEL_PROMPTS[L]}`);
      if(messages.length===0) return;
      levelMessage.textContent = messages.join('\n');
      levelModal.style.display='flex'; levelModal.setAttribute('aria-hidden','false');
    }

    function updateFameUI(prevFame=null){
      const prevLevel = prevFame !== null ? getFameLevel(prevFame) : null;
      const level = getFameLevel(fame);
      playerLevelEl.textContent = level;
      fameInput.value = fame;
      // ensure Level 1 present
      if(!achievedLevels || achievedLevels.length===0) achievedLevels = [1];
      if(prevLevel !== null && level > prevLevel){
        for(let L=prevLevel+1; L<=level; L++){
          if(!achievedLevels.includes(L)) achievedLevels.push(L);
        }
      }
      renderLevels();
      if(prevLevel !== null && level > prevLevel) handleLevelPrompts(prevLevel, level);
      saveState();
    }

    // Deck & draw
    function rebuildDeckFromCounts(){
      dummyDeck = [];
      Object.keys(cardCounts).forEach(color => { for(let i=0;i<cardCounts[color];i++) dummyDeck.push(`${color} Card`); });
      shuffle(dummyDeck); updateDeckCount(); saveState();
    }
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
    function updateDeckCount(){ document.getElementById('deck-count').textContent = dummyDeck.length; }
    function updateDiscardUI(){ if(!discardPile||discardPile.length===0) discardOutput.textContent='Discard pile is empty.'; else {
      const syms = discardPile.map(c=>COLOR_SYMBOL[c.split(' ')[0]]||c); discardOutput.textContent = `Discard (${discardPile.length}): ${syms.join(' ')}`; } }

    // Draw behaviour:
    // - Draw up to 3 cards or until deck empty
    // - If last drawn card has color and crystals give extra draws, draw those (from remaining deck)
    // - If cannot draw (deck empty at start), set endRoundFlag and change button to 'End Round'
    function drawCardsOnce(){
      if (dummyDeck.length === 0) {
        // nothing to draw => enter end of round
        endRoundFlag = true;
        drawBtn.textContent = 'End Round';
        dummyOutput.textContent = 'No cards to draw. End of round pending.';
        saveState();
        return;
      }

      const drawn = [];
      for (let i = 0; i < 3 && dummyDeck.length > 0; i++) {
        drawn.push(dummyDeck.pop());
      }

      // apply extra draws if last drawn color and crystals provide extra
      const last = drawn[drawn.length - 1];
      if (last) {
        const color = last.split(' ')[0].toLowerCase();
        const extra = crystals[color] || 0;
        for (let i = 0; i < extra && dummyDeck.length > 0; i++) drawn.push(dummyDeck.pop());
      }

      if (drawn.length === 0) {
        endRoundFlag = true;
        drawBtn.textContent = 'End Round';
        dummyOutput.textContent = 'No cards drawn. End of round pending.';
        saveState();
        return;
      }

      discardPile.push(...drawn);
      const syms = drawn.map(c => COLOR_SYMBOL[c.split(' ')[0]] || c);
      dummyOutput.textContent = syms.join(' ');
      updateDeckCount();
      updateDiscardUI();

      // If deck is now empty after drawing, prepare for end of round (button becomes End Round)
      if (dummyDeck.length === 0) {
        endRoundFlag = true;
        drawBtn.textContent = 'End Round';
      }

      saveState();
    }

    function onDrawClick(){
      if (endRoundFlag) {
        // open end round modal to choose crystal and card
        openEndRoundModal();
        return;
      }
      // normal draw
      drawCardsOnce();
    }

    // End round modal functions
    function openEndRoundModal(){
      selectedCrystal = null;
      selectedCard = null;
      endroundConfirm.disabled = true;
      endroundModal.style.display = 'flex';
      endroundModal.setAttribute('aria-hidden', 'false');
      // reset selection UI
      Array.from(crystalChoices.querySelectorAll('.choice-btn')).forEach(b => b.classList.remove('selected'));
      Array.from(cardChoices.querySelectorAll('.choice-btn')).forEach(b => b.classList.remove('selected'));
    }
    function closeEndRoundModal(){
      endroundModal.style.display = 'none';
      endroundModal.setAttribute('aria-hidden', 'true');
    }

    crystalChoices.addEventListener('click', (e) => {
      const btn = e.target.closest('.choice-btn');
      if (!btn) return;
      selectedCrystal = btn.dataset.val;
      Array.from(crystalChoices.querySelectorAll('.choice-btn')).forEach(b => b.classList.toggle('selected', b === btn));
      endroundConfirm.disabled = !(selectedCrystal && selectedCard);
    });

    cardChoices.addEventListener('click', (e) => {
      const btn = e.target.closest('.choice-btn');
      if (!btn) return;
      selectedCard = btn.dataset.val;
      Array.from(cardChoices.querySelectorAll('.choice-btn')).forEach(b => b.classList.toggle('selected', b === btn));
      endroundConfirm.disabled = !(selectedCrystal && selectedCard);
    });

    endroundCancel.addEventListener('click', () => {
      closeEndRoundModal();
    });

    endroundConfirm.addEventListener('click', () => {
      if (!selectedCrystal || !selectedCard) return;
      // apply chosen crystal and card
      changeCrystal(selectedCrystal, 1);
      changeCard(selectedCard, 1);

      // move discard into deck and reshuffle
      if (discardPile.length > 0) {
        dummyDeck.push(...discardPile);
        discardPile = [];
        shuffle(dummyDeck);
      }

      updateDeckCount();
      updateDiscardUI();

      // reset end round
      endRoundFlag = false;
      drawBtn.textContent = 'Draw';
      dummyOutput.textContent = `End Round: added ${COLOR_SYMBOL[selectedCard] || selectedCard} and ${COLOR_SYMBOL[selectedCrystal] || selectedCrystal}. Deck reshuffled.`;

      saveState();
      closeEndRoundModal();
    });

    // Reshuffle: put discard into deck and reshuffle (button under discard)
    function reshuffleDeck(){
      if (!discardPile || discardPile.length === 0) {
        // no-op if empty
        dummyOutput.textContent = 'Discard pile is empty. Nothing to reshuffle.';
        return;
      }
      dummyDeck.push(...discardPile);
      discardPile = [];
      shuffle(dummyDeck);
      updateDeckCount();
      updateDiscardUI();
      endRoundFlag = false;
      drawBtn.textContent = 'Draw';
      dummyOutput.textContent = 'Deck reshuffled from discard.';
      saveState();
    }

    // crystals & cards
    function changeCrystal(color,delta){
      crystals[color] = Math.max(0,(crystals[color]||0)+delta);
      document.getElementById(color).textContent = crystals[color];
      saveState();
    }
    function changeCard(color,delta){
      cardCounts[color] = Math.max(0,(cardCounts[color]||0)+delta);
      document.getElementById(`card-${color.toLowerCase()}`).textContent = cardCounts[color];
      if(delta>0){
        const name=`${color} Card`;
        const pos=Math.floor(Math.random()*(dummyDeck.length+1));
        dummyDeck.splice(pos,0,name);
      } else {
        const name=`${color} Card`;
        const idx=dummyDeck.indexOf(name);
        if(idx!==-1) dummyDeck.splice(idx,1);
        else {
          const dj=discardPile.indexOf(name);
          if(dj!==-1) discardPile.splice(dj,1);
        }
      }
      updateDeckCount();
      updateDiscardUI();
      saveState();
    }

    // fame setters
    function setFameOverride(value){
      const prev = fame;
      fame = clampInt(value,0,119);
      updateFameUI(prev);
    }
    function addFame(delta){
      const prev = fame; fame = clampInt(fame + delta, 0, 119); updateFameUI(prev);
    }

    // new game
    function newGame(){
      if (!confirm('Start a new game? This will reset saved progress and values to defaults.')) return;
      clearSavedState();
      fame = 0;
      crystals = { ...DEFAULT_CRYSTALS };
      cardCounts = { ...DEFAULT_CARDS };
      dummyDeck = []; discardPile = []; endRoundFlag = false;
      achievedLevels = [1];
      repSelection = null;
      rebuildDeckFromCounts(); updateDiscardUI();
      buildRepRows();
      const midCell = repWrap.querySelector('.rep-row.mid .rep-cell'); if(midCell){ midCell.classList.add('selected'); repSelection={row:'mid',index:0}; }
      document.getElementById('red').textContent = crystals.red;
      document.getElementById('blue').textContent = crystals.blue;
      document.getElementById('green').textContent = crystals.green;
      document.getElementById('white').textContent = crystals.white;
      document.getElementById('card-red').textContent = cardCounts.Red;
      document.getElementById('card-blue').textContent = cardCounts.Blue;
      document.getElementById('card-green').textContent = cardCounts.Green;
      document.getElementById('card-white').textContent = cardCounts.White;
      updateFameUI(null); renderLevels(); saveState();
    }

    // init wiring
    window.addEventListener('load', ()=>{
      buildRepRows();
      const ok = loadState();
      if(!achievedLevels || achievedLevels.length===0) achievedLevels = [1];
      document.getElementById('red').textContent = crystals.red || 0;
      document.getElementById('blue').textContent = crystals.blue || 0;
      document.getElementById('green').textContent = crystals.green || 0;
      document.getElementById('white').textContent = crystals.white || 0;
      document.getElementById('card-red').textContent = cardCounts.Red;
      document.getElementById('card-blue').textContent = cardCounts.Blue;
      document.getElementById('card-green').textContent = cardCounts.Green;
      document.getElementById('card-white').textContent = cardCounts.White;
      if(!ok){ rebuildDeckFromCounts(); achievedLevels = [1]; saveState(); }
      else { if(!Array.isArray(dummyDeck) || dummyDeck.length===0) rebuildDeckFromCounts(); }
      updateDeckCount(); updateDiscardUI(); updateFameUI(null); renderLevels();

      // fame input override behavior
      fameInput.addEventListener('change', ()=> setFameOverride(fameInput.value));
      fameInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); setFameOverride(fameInput.value); fameInput.blur(); } });

      // fame inc buttons
      document.querySelectorAll('.fame-inc').forEach(btn=> btn.addEventListener('click', ()=> addFame(Number(btn.dataset.inc||0))));

      // crystals buttons
      document.querySelectorAll('[data-crystal]').forEach(b => b.addEventListener('click', ()=>{
        const color = b.dataset.crystal; const act = b.dataset.act; changeCrystal(color, act==='inc'?1:-1);
      }));

      // card buttons
      document.querySelectorAll('.card-btn').forEach(b => b.addEventListener('click', ()=>{
        const color = b.dataset.color; const act = b.dataset.act; changeCard(color, act==='inc'?1:-1);
      }));

      // draw, reshuffle, new game
      drawBtn.addEventListener('click', onDrawClick);
      reshuffleBtn.addEventListener('click', reshuffleDeck);
      newGameBtn.addEventListener('click', newGame);

      // endround modal buttons wired earlier; level modal ok
      levelOk.addEventListener('click', ()=>{ levelModal.style.display='none'; levelModal.setAttribute('aria-hidden','true'); });

      // save on unload
      window.addEventListener('beforeunload', saveState);
    });

    // expose for debug
    window._mk_save = saveState;
    window._mk_load = loadState;
    window._mk_newGame = newGame;
  </script>
</body>
</html>
