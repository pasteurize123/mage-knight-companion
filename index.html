<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mage Knight Companion â€” Dummy End Round (symbol-only modal, restored GV)</title>
<style>
  :root{
    --bg:#f4f4f4; --panel:#ececec; --card:#fff; --muted:#666;
    --accent:#b00020; --pill:#f7f7f7; --gold:#ffd700;
    --font:system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  }
  *{box-sizing:border-box}
  body{margin:12px;font-family:var(--font);background:var(--bg);color:#111}
  h1{font-size:18px;text-align:center;margin:0 0 12px}
  .container{max-width:980px;margin:0 auto;display:flex;flex-direction:column;gap:12px;padding:0 10px}
  .panel{background:var(--panel);border-radius:10px;padding:10px}
  .panel-inner{background:var(--card);border-radius:8px;padding:12px;display:flex;flex-direction:column;gap:10px}
  .smallbtn{padding:6px 10px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer}
  .btn-ghost{background:transparent;border:1px dashed #ccc}
  .output{background:#fff;padding:8px;border-radius:6px;min-height:36px}
  .muted{color:var(--muted);font-size:0.95rem}

  .rep-wrap{display:flex;flex-direction:column;gap:8px;align-items:stretch;padding:6px}
  .rep-row{display:flex;align-items:center;gap:8px;padding:6px 0;width:100%;flex-wrap:nowrap}
  .rep-row.top .rep-cell,
  .rep-row.bot .rep-cell{flex:0 0 calc((100% - 6 * 8px) / 7);min-height:40px;padding:6px;border-radius:6px;background:#e8e8e8;text-align:center;font-size:14px}
  .rep-row.mid .rep-cell{flex:1 1 auto;min-height:40px;padding:6px;border-radius:6px;background:#e8e8e8;text-align:center;font-size:14px}
  .rep-cell{display:flex;align-items:center;justify-content:center;box-sizing:border-box;cursor:pointer}
  .rep-cell.selected{box-shadow:0 0 0 3px rgba(127,177,255,0.28) inset}

  .dummy-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:start}
  .section-card{background:var(--card);border-radius:8px;padding:10px;border:1px solid #eee}
  .crystal-row,.card-row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .pill{display:flex;align-items:center;justify-content:center;gap:8px;background:var(--pill);padding:8px;border-radius:8px;border:1px solid #eee;min-width:56px;height:44px;font-weight:700}
  .controls-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

  /* End-round modal */
  #endround-modal{display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:60}
  .modal-card{background:#fff;border-radius:10px;padding:16px;max-width:520px;width:96%;max-height:92vh;overflow:auto}
  .modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
  .modal-section{display:flex;flex-direction:column;gap:8px;align-items:center}
  .symbol-btn{font-size:22px;width:52px;height:52px;border-radius:8px;border:1px solid #ddd;background:#fff;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
  .symbol-btn.chosen{outline:3px solid #7fb1ff}
  .modal-foot{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
  .prompt{font-weight:700;text-align:center}
  @media (max-width:640px){ .dummy-grid{grid-template-columns:1fr} .modal-grid{grid-template-columns:1fr} }
</style>
</head>
<body>
  <h1>Mage Knight Companion</h1>

  <div class="container">
    <section class="panel" aria-labelledby="rep-title">
      <div class="panel-inner">
        <h2 id="rep-title">Reputation</h2>
        <div id="rep-wrap" class="rep-wrap" aria-label="Reputation track" role="group"></div>
      </div>
    </section>

    <section class="panel" aria-labelledby="fame-title">
      <div class="panel-inner">
        <h2 id="fame-title">Fame</h2>
        <div style="display:flex;gap:12px;align-items:center">
          <div>
            <label style="font-weight:700;display:block">Player Fame</label>
            <input id="fame-input" type="number" min="0" value="0" style="width:120px;padding:6px;border-radius:6px;border:1px solid #ccc;text-align:center" />
          </div>
          <div style="margin-left:auto;text-align:center">
            <div style="font-weight:700">Player Level</div>
            <div id="player-level-num" style="min-width:64px;padding:8px;border-radius:6px;background:#fff;border:1px solid #eee;font-weight:700;text-align:center">1</div>
          </div>
        </div>

        <div style="margin-top:8px">
          <div class="levels-wrapper" id="levels-wrapper" aria-expanded="false">
            <button id="levels-trigger" class="levels-trigger" aria-controls="levels-list" aria-haspopup="true">Levels Achieved</button>
            <div id="levels-list" class="levels-list" role="list" aria-hidden="true" style="display:none;margin-top:6px;border-radius:6px;border:1px solid #eee;background:#fff;padding:8px;max-height:220px;overflow:auto"></div>
          </div>
        </div>
      </div>
    </section>

    <section class="panel" aria-labelledby="dummy-title">
      <div class="panel-inner" id="dummy-module">
        <h2 id="dummy-title">Dummy Player</h2>

        <div class="dummy-grid">
          <div class="section-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div style="font-weight:600">Crystals</div>
              <div style="font-size:12px;color:var(--muted)">Adjust available crystals</div>
            </div>

            <div class="crystal-row" id="crystal-row">
              <div class="pill">ðŸ”´ <span id="red">0</span></div>
              <div class="pill">ðŸ”µ <span id="blue">0</span></div>
              <div class="pill">ðŸŸ¢ <span id="green">0</span></div>
              <div class="pill">âšª <span id="white">0</span></div>
            </div>

            <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
              <button class="smallbtn crystal-man" data-color="red" data-act="inc">+ðŸ”´</button>
              <button class="smallbtn crystal-man" data-color="red" data-act="dec">âˆ’ðŸ”´</button>
              <button class="smallbtn crystal-man" data-color="blue" data-act="inc">+ðŸ”µ</button>
              <button class="smallbtn crystal-man" data-color="blue" data-act="dec">âˆ’ðŸ”µ</button>
              <button class="smallbtn crystal-man" data-color="green" data-act="inc">+ðŸŸ¢</button>
              <button class="smallbtn crystal-man" data-color="green" data-act="dec">âˆ’ðŸŸ¢</button>
              <button class="smallbtn crystal-man" data-color="white" data-act="inc">+âšª</button>
              <button class="smallbtn crystal-man" data-color="white" data-act="dec">âˆ’âšª</button>
            </div>
          </div>

          <div class="section-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div style="font-weight:600">Cards</div>
              <div style="font-size:12px;color:var(--muted)">Deck composition</div>
            </div>

            <div class="card-row" id="card-row">
              <div class="pill">ðŸ”´ <span id="card-red">4</span></div>
              <div class="pill">ðŸ”µ <span id="card-blue">4</span></div>
              <div class="pill">ðŸŸ¢ <span id="card-green">4</span></div>
              <div class="pill">âšª <span id="card-white">4</span></div>
            </div>

            <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
              <button class="smallbtn adv-man" data-color="Red" data-act="inc" id="add-adv-red">+AdvðŸ”´</button>
              <button class="smallbtn adv-man" data-color="Red" data-act="dec" id="rem-adv-red">âˆ’AdvðŸ”´</button>
              <button class="smallbtn adv-man" data-color="Blue" data-act="inc" id="add-adv-blue">+AdvðŸ”µ</button>
              <button class="smallbtn adv-man" data-color="Blue" data-act="dec" id="rem-adv-blue">âˆ’AdvðŸ”µ</button>
              <button class="smallbtn adv-man" data-color="Green" data-act="inc" id="add-adv-green">+AdvðŸŸ¢</button>
              <button class="smallbtn adv-man" data-color="Green" data-act="dec" id="rem-adv-green">âˆ’AdvðŸŸ¢</button>
              <button class="smallbtn adv-man" data-color="White" data-act="inc" id="add-adv-white">+Advâšª</button>
              <button class="smallbtn adv-man" data-color="White" data-act="dec" id="rem-adv-white">âˆ’Advâšª</button>
            </div>

            <div style="margin-top:10px" class="muted">Cards in deck: <strong id="deck-count">0</strong></div>
          </div>

          <div class="section-card" style="grid-column:1 / -1">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div style="font-weight:600">Actions</div>
              <div style="font-size:12px;color:var(--muted)">Draw, discard and reshuffle</div>
            </div>

            <div class="controls-row" style="margin-bottom:8px">
              <button id="draw-btn" class="smallbtn">Draw</button>
              <button id="reshuffle-btn" class="smallbtn">Reshuffle Deck</button>
              <div style="flex:1"></div>
              <div class="muted" style="font-size:13px">Discard: <strong id="discard-count">0</strong></div>
            </div>

            <div id="dummy-output" class="output">Drawn symbols appear here</div>
            <div id="discard-output" class="output" style="margin-top:8px">Discard pile is empty.</div>
          </div>
        </div>
      </div>
    </section>

    <section class="panel" aria-labelledby="gv-title">
      <div class="panel-inner" id="gv-module">
        <h2 id="gv-title">General Volkare</h2>

        <div style="display:flex;gap:18px;flex-wrap:wrap">
          <div style="flex:1;min-width:260px">
            <h3 style="margin:0 0 6px 0;font-size:1rem">Deck Composition</h3>
            <div style="display:flex;flex-direction:column;gap:8px">
              <div class="gv-pile" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                <div class="gv-pill">Advanced Actions</div>
                <div class="gv-pill"><span class="symbol">ðŸ”´</span><span class="symbol">ðŸ”µ</span><span class="symbol">ðŸŸ¢</span><span class="symbol">âšª</span></div>
              </div>

              <div class="gv-pile" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                <div class="gv-pill">Spells</div>
                <div class="gv-pill"><span class="symbol spell">ðŸ”´</span><span class="symbol spell">ðŸ”µ</span><span class="symbol spell">ðŸŸ¢</span><span class="symbol spell">âšª</span></div>
              </div>

              <div style="display:flex;align-items:center;gap:12px">
                <div>
                  <div style="font-weight:600;margin-bottom:6px">Wounds</div>
                  <div class="wound-box" aria-live="polite" style="display:inline-flex;flex-direction:column;align-items:center;padding:6px;border-radius:6px;background:#fff;border:1px solid #eee">
                    <div class="wound-num"><strong id="gv-wounds">0</strong></div>
                    <div style="font-size:20px;line-height:1">ðŸ©¸</div>
                  </div>
                </div>

                <div style="display:flex;gap:8px;align-items:center;margin-left:8px">
                  <button class="smallbtn gv-wound-btn" data-act="dec">âˆ’</button>
                  <button class="smallbtn gv-wound-btn" data-act="inc">+</button>
                </div>

                <div style="margin-left:16px" class="muted">Deck size: <strong id="deck-count-gv">0</strong></div>
              </div>

              <div id="gv-frenzy-desc" class="gv-desc" aria-live="polite" style="display:none;color:var(--accent);margin-top:6px">Frenzy â€” Volkare will act as if a spell was drawn.</div>
            </div>
          </div>

          <div style="flex:1;min-width:200px">
            <h3 style="margin:0 0 6px 0;font-size:1rem">Controls</h3>
            <div style="display:flex;flex-direction:column;gap:8px">
              <button id="draw-btn-gv" class="smallbtn">Draw</button>
              <button id="reshuffle-btn-gv" class="smallbtn">Reshuffle Deck</button>
            </div>
          </div>
        </div>

        <div style="margin-top:10px">
          <div id="dummy-output-gv" class="output">Drawn cards appear here (symbols)</div>
        </div>

        <div style="margin-top:8px">
          <div id="discard-output-gv" class="output">Discard pile is empty.</div>
        </div>
      </div>
    </section>

    <footer style="display:flex;justify-content:center">
      <button id="new-game" class="smallbtn">New Game</button>
    </footer>
  </div>

  <!-- End-round modal: symbol-only choices, simplified prompt -->
  <div id="endround-modal" role="dialog" aria-modal="true" style="display:none">
    <div class="modal-card" aria-labelledby="endround-title">
      <div id="endround-title" class="prompt">Select 1 crystal and 1 card.</div>

      <div class="modal-grid" style="margin-top:12px">
        <div class="modal-section" aria-labelledby="crystal-section">
          <div id="crystal-section" style="font-weight:700">Crystal</div>
          <div style="display:flex;gap:10px">
            <button class="symbol-btn" data-type="crystal" data-val="red" aria-label="Red crystal">ðŸ”´</button>
            <button class="symbol-btn" data-type="crystal" data-val="blue" aria-label="Blue crystal">ðŸ”µ</button>
            <button class="symbol-btn" data-type="crystal" data-val="green" aria-label="Green crystal">ðŸŸ¢</button>
            <button class="symbol-btn" data-type="crystal" data-val="white" aria-label="White crystal">âšª</button>
          </div>
        </div>

        <div class="modal-section" aria-labelledby="card-section">
          <div id="card-section" style="font-weight:700">Card</div>
          <div style="display:flex;gap:10px">
            <button class="symbol-btn" data-type="card" data-val="Adv-Red" aria-label="Advanced Red">ðŸ”´</button>
            <button class="symbol-btn" data-type="card" data-val="Adv-Blue" aria-label="Advanced Blue">ðŸ”µ</button>
            <button class="symbol-btn" data-type="card" data-val="Adv-Green" aria-label="Advanced Green">ðŸŸ¢</button>
            <button class="symbol-btn" data-type="card" data-val="Adv-White" aria-label="Advanced White">âšª</button>
          </div>
        </div>
      </div>

      <div class="modal-foot">
        <button id="endround-cancel" class="smallbtn btn-ghost">Cancel</button>
        <button id="endround-confirm" class="smallbtn" disabled>Confirm</button>
      </div>
    </div>
  </div>

<script>
/* Complete app JS:
   - Dummy module with end-round behavior (Draw -> End Round when deck empty)
   - Symbol-only modal; prompt text exactly "Select 1 crystal and 1 card."
   - Only Advanced Actions available for card choice; no spells
   - On Confirm: add chosen crystal, add chosen Adv card to dummy deck, reshuffle discard into deck, close modal, reset Draw button
   - GV module restored and unchanged in behavior
   - Reputation rows + fame levels + Levels Achieved list restored
   - localStorage persistence for dummy and gv
*/

/* Utilities */
const STORAGE_KEY = 'mk_companion_symbol_endround_v2';
const SYMBOL = { Red:'ðŸ”´', Blue:'ðŸ”µ', Green:'ðŸŸ¢', White:'âšª', Wound:'ðŸ©¸' };
const DEFAULT_CARDS = { Red:4, Blue:4, Green:4, White:4 };
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

/* Fame / levels */
const FAME_LEVELS = [
  {level:1, min:0,  max:2},{level:2, min:3,  max:7},{level:3, min:8,  max:14},
  {level:4, min:15, max:23},{level:5, min:24, max:34},{level:6, min:35, max:47},
  {level:7, min:48, max:62},{level:8, min:63, max:79},{level:9, min:80, max:98},
  {level:10,min:99, max:119}
];
const LEVEL_PROMPTS = {
  1: "Command Token",2: "Skill + Advanced Action",3: "Command Token",
  4: "Skill + Advanced Action",5: "Command Token",6: "Skill + Advanced Action",
  7: "Command Token",8: "Skill + Advanced Action",9: "Command Token",10: "Skill + Advanced Action"
};
let fame = 0;
function getFameLevel(val){
  const v = Math.max(0, Number(val) || 0);
  for(const b of FAME_LEVELS) if(v>=b.min && v<=b.max) return b.level;
  return 10;
}

/* ---------------- Dummy Module ---------------- */
function DummyModule(){
  const SKEY = `${STORAGE_KEY}_main`;
  let crystals = { red:0, blue:0, green:0, white:0 };
  let cardCounts = { ...DEFAULT_CARDS };
  let deck = [];
  let discard = [];
  let endRoundFlag = false;

  function save(){
    try{ localStorage.setItem(SKEY, JSON.stringify({crystals,cardCounts,deck,discard,endRoundFlag})); }catch(e){}
  }
  function load(){
    try{
      const raw = localStorage.getItem(SKEY);
      if(!raw) return false;
      const s = JSON.parse(raw);
      crystals = s.crystals || crystals;
      cardCounts = s.cardCounts || cardCounts;
      deck = Array.isArray(s.deck)?s.deck:deck;
      discard = Array.isArray(s.discard)?s.discard:discard;
      endRoundFlag = !!s.endRoundFlag;
      return true;
    }catch(e){ return false; }
  }

  function rebuildDeck(){
    deck = [];
    Object.keys(cardCounts).forEach(color=>{
      for(let i=0;i<cardCounts[color];i++) deck.push(`${color} Card`);
    });
    shuffle(deck);
    save();
    renderDeckAndDiscard();
    updateDrawButtonState();
  }

  function renderDeckAndDiscard(){
    document.getElementById('red').textContent = crystals.red;
    document.getElementById('blue').textContent = crystals.blue;
    document.getElementById('green').textContent = crystals.green;
    document.getElementById('white').textContent = crystals.white;

    document.getElementById('card-red').textContent = cardCounts.Red;
    document.getElementById('card-blue').textContent = cardCounts.Blue;
    document.getElementById('card-green').textContent = cardCounts.Green;
    document.getElementById('card-white').textContent = cardCounts.White;

    document.getElementById('deck-count').textContent = deck.length;
    document.getElementById('discard-count').textContent = discard.length;
    document.getElementById('discard-output').textContent = discard.length === 0 ? 'Discard pile is empty.' : `Discard (${discard.length}): ${discard.map(formatCard).join(' ')}`;
  }

  function formatCard(code){
    if(!code) return '';
    if(code.endsWith('Card')) return SYMBOL[code.split(' ')[0]] || code;
    if(code.startsWith('Adv-')) return SYMBOL[code.split('-')[1]] || code;
    if(code.startsWith('Spell-')) return 'S' + (SYMBOL[code.split('-')[1]] || code);
    return code;
  }

  function updateDrawButtonState(){
    const btn = document.getElementById('draw-btn');
    if(!btn) return;
    if(deck.length === 0){
      btn.textContent = 'End Round';
      endRoundFlag = true;
    } else {
      btn.textContent = 'Draw';
      endRoundFlag = false;
    }
    save();
  }

  function draw(){
    const out = document.getElementById('dummy-output');
    if(deck.length === 0){
      endRoundFlag = true;
      updateDrawButtonState();
      if(out) out.textContent = 'Deck empty. End Round available.';
      return;
    }
    const drawn = [];
    for(let i=0;i<3 && deck.length>0;i++) drawn.push(deck.pop());
    const last = drawn[drawn.length-1];
    if(last && last.endsWith('Card')){
      const color = last.split(' ')[0].toLowerCase();
      const extra = crystals[color] || 0;
      for(let i=0;i<extra && deck.length>0;i++) drawn.push(deck.pop());
    }
    discard.push(...drawn);
    renderDeckAndDiscard();
    updateDrawButtonState();
    if(out) out.textContent = drawn.map(formatCard).join(' ');
    save();
  }

  function reshuffle(){
    const out = document.getElementById('dummy-output');
    if(discard.length === 0){
      if(out) out.textContent = 'Discard pile is empty. Nothing to reshuffle.';
      return;
    }
    deck.push(...discard);
    discard = [];
    shuffle(deck);
    endRoundFlag = false;
    updateDrawButtonState();
    renderDeckAndDiscard();
    save();
    if(out) out.textContent = 'Deck reshuffled from discard.';
  }

  function changeCrystal(col, delta){
    crystals[col] = Math.max(0,(crystals[col]||0)+delta);
    save(); renderDeckAndDiscard(); updateDrawButtonState();
  }

  function changeCardCount(color, delta){
    cardCounts[color] = Math.max(0,(cardCounts[color]||0)+delta);
    if(delta > 0){
      for(let i=0;i<delta;i++){
        const name = `${color} Card`;
        const pos = Math.floor(Math.random()*(deck.length+1));
        deck.splice(pos,0,name);
      }
    } else {
      let toRemove = -delta;
      while(toRemove>0){
        const name = `${color} Card`;
        const idx = deck.indexOf(name);
        if(idx !== -1){ deck.splice(idx,1); toRemove--; continue; }
        const dj = discard.indexOf(name);
        if(dj !== -1){ discard.splice(dj,1); toRemove--; continue; }
        break;
      }
    }
    save(); renderDeckAndDiscard(); updateDrawButtonState();
  }

  function openEndRoundModal(){
    if(!(deck.length === 0 || endRoundFlag)) return;
    document.getElementById('endround-modal').style.display = 'flex';
    pendingSelections.crystal = null;
    pendingSelections.card = null;
    refreshModalUI();
    // focus first crystal for accessibility
    const first = document.querySelector('.symbol-btn[data-type="crystal"]');
    if(first) first.focus();
  }

  load();
  return { save, load, rebuildDeck, draw, reshuffle, changeCrystal, changeCardCount, updateDrawButtonState, openEndRoundModal, renderDeckAndDiscard };
}

/* ---------------- GV Module (restored) ---------------- */
function GVModule(){
  const SKEY = `${STORAGE_KEY}_gv`;
  let deck = [];
  let discard = [];
  let wounds = 0;

  function save(){ try{ localStorage.setItem(SKEY, JSON.stringify({deck,discard,wounds})); }catch(e){} }
  function load(){
    try{
      const raw = localStorage.getItem(SKEY);
      if(!raw) return false;
      const s = JSON.parse(raw);
      deck = Array.isArray(s.deck)?s.deck:deck;
      discard = Array.isArray(s.discard)?s.discard:discard;
      wounds = typeof s.wounds === 'number'?s.wounds:wounds;
      updateCounts();
      updateDrawButtonState();
      return true;
    }catch(e){ return false; }
  }

  function buildDefaultDeck(){
    deck = [];
    ['Red','Blue','Green','White'].forEach(c=>{ for(let i=0;i<4;i++) deck.push(`Adv-${c}`); });
    ['Red','Blue','Green','White'].forEach(c=> deck.push(`Spell-${c}`));
    shuffle(deck);
    wounds = 0;
    save(); updateCounts(); updateDrawButtonState();
  }

  function displayGVCard(code){
    if(!code) return '';
    if(code.startsWith('Adv-')) return SYMBOL[code.split('-')[1]] || code;
    if(code.startsWith('Spell-')) return 'S' + (SYMBOL[code.split('-')[1]] || code);
    if(code === 'Wound') return SYMBOL.Wound;
    return code;
  }

  function updateCounts(){
    const elDeck = document.getElementById('deck-count-gv');
    if(elDeck) elDeck.textContent = deck.length;
    const elW = document.getElementById('gv-wounds');
    if(elW) elW.textContent = wounds;
    const out = document.getElementById('discard-output-gv');
    if(out) out.textContent = discard.length === 0 ? 'Discard pile is empty.' : `Discard (${discard.length}): ${discard.map(displayGVCard).join(' ')}`;
  }

  function updateDrawButtonState(){
    const btn = document.getElementById('draw-btn-gv');
    const desc = document.getElementById('gv-frenzy-desc');
    if(!btn) return;
    if(deck.length === 0){
      btn.textContent = 'Frenzy';
      if(desc) desc.style.display = 'block';
    } else {
      btn.textContent = 'Draw';
      if(desc) desc.style.display = 'none';
    }
  }

  function drawOnce(){
    const out = document.getElementById('dummy-output-gv');
    if(deck.length === 0){
      updateDrawButtonState();
      if(out) out.textContent = 'Deck empty â€” Frenzy ready. Volkare will act as if a spell was drawn.';
      return;
    }
    const card = deck.pop();
    discard.push(card);
    if(out){
      if(card.startsWith('Spell-')){
        out.innerHTML = `<span class="symbol spell">${SYMBOL[card.split('-')[1]]}</span>`;
      } else if(card === 'Wound'){
        out.innerHTML = `<span class="wound-symbol">${SYMBOL.Wound}</span>`;
      } else {
        out.textContent = SYMBOL[card.split('-')[1]] || card;
      }
    }
    updateCounts(); save(); updateDrawButtonState();
  }

  function reshuffle(){
    const out = document.getElementById('dummy-output-gv');
    if(discard.length === 0){
      if(out) out.textContent = 'Discard pile is empty. Nothing to reshuffle.';
      return;
    }
    deck.push(...discard); discard = []; shuffle(deck); updateCounts(); if(out) out.textContent = 'Deck reshuffled from discard.'; save();
    updateDrawButtonState();
  }

  function changeWounds(delta){
    const newW = Math.max(0,wounds+delta);
    const diff = newW - wounds;
    wounds = newW;
    if(diff>0){ for(let i=0;i<diff;i++){ const pos=Math.floor(Math.random()*(deck.length+1)); deck.splice(pos,0,'Wound'); } }
    else if(diff<0){ let toRemove=-diff; while(toRemove>0){ const idx = deck.indexOf('Wound'); if(idx!==-1){ deck.splice(idx,1); toRemove--; continue; } const dj = discard.indexOf('Wound'); if(dj!==-1){ discard.splice(dj,1); toRemove--; continue; } break; } }
    updateCounts(); save(); updateDrawButtonState();
  }

  load();
  return { load, save, buildDefaultDeck, updateCounts, drawOnce, reshuffle, changeWounds, updateDrawButtonState };
}

/* ---------------- App wiring ---------------- */
const mainModule = DummyModule();
const gvModule = GVModule();

/* rep rows */
function buildRepRows(){
  const repWrap = document.getElementById('rep-wrap');
  repWrap.innerHTML = '';
  const REP_TOP = ["0","+1","+1","+2","+2","+3","+5"];
  const REP_MID = ["0"];
  const REP_BOT = ["0","-1","-1","-2","-3","-5","X"];

  const top=document.createElement('div'); top.className='rep-row top';
  REP_TOP.forEach((label,i)=>{
    const c=document.createElement('div'); c.className='rep-cell'; c.textContent=label; c.tabIndex=0;
    c.addEventListener('click', ()=>{ selectRepCell({row:'top',index:i}); saveMeta(); });
    c.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); selectRepCell({row:'top',index:i}); saveMeta(); }});
    top.appendChild(c);
  });
  const mid=document.createElement('div'); mid.className='rep-row mid';
  REP_MID.forEach((label,i)=>{
    const c=document.createElement('div'); c.className='rep-cell'; c.textContent=label; c.tabIndex=0;
    c.addEventListener('click', ()=>{ selectRepCell({row:'mid',index:i}); saveMeta(); });
    c.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); selectRepCell({row:'mid',index:i}); saveMeta(); }});
    mid.appendChild(c);
  });
  const bot=document.createElement('div'); bot.className='rep-row bot';
  REP_BOT.forEach((label,i)=>{
    const c=document.createElement('div'); c.className='rep-cell'; c.textContent=label; c.tabIndex=0;
    c.addEventListener('click', ()=>{ selectRepCell({row:'bot',index:i}); saveMeta(); });
    c.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); selectRepCell({row:'bot',index:i}); saveMeta(); }});
    bot.appendChild(c);
  });

  repWrap.appendChild(top); repWrap.appendChild(mid); repWrap.appendChild(bot);
  if(!window._repSelection) window._repSelection = { row:'mid', index:0 };
  applyRepSelection(window._repSelection);
}
function selectRepCell(sel){
  document.querySelectorAll('.rep-cell').forEach(c=>c.classList.remove('selected'));
  const rowEl = document.querySelector(`.rep-row.${sel.row}`);
  if(!rowEl) return;
  const cells = rowEl.querySelectorAll('.rep-cell');
  if(cells[sel.index]){ cells[sel.index].classList.add('selected'); window._repSelection = {...sel}; }
}
function applyRepSelection(sel){ if(!sel) return; const rowEl = document.querySelector(`.rep-row.${sel.row}`); if(!rowEl) return; const cells = rowEl.querySelectorAll('.rep-cell'); if(cells[sel.index]) cells[sel.index].classList.add('selected'); }

/* Levels achieved rendering */
function renderLevelsAchieved(){
  const listEl = document.getElementById('levels-list');
  if(!listEl) return;
  listEl.innerHTML = '';
  const level = getFameLevel(fame);
  if(!level || level < 1){ const div=document.createElement('div'); div.className='level-line'; div.textContent = 'None yet'; listEl.appendChild(div); return; }
  for(let L=1; L<=level; L++){
    const div=document.createElement('div'); div.className='level-line';
    const desc = LEVEL_PROMPTS[L] || '';
    if(desc){
      const prefix = document.createElement('span'); prefix.style.fontWeight='700'; prefix.textContent = `Level ${L}:`;
      const d = document.createElement('span'); d.style.fontWeight='400'; d.textContent = ` ${desc}`;
      div.appendChild(prefix); div.appendChild(d);
    } else { div.textContent = `Level ${L}`; }
    listEl.appendChild(div);
  }
}

/* Modal state and helpers */
const pendingSelections = { crystal: null, card: null };
function refreshModalUI(){
  document.querySelectorAll('.symbol-btn').forEach(b=>{
    const type = b.dataset.type;
    const val = b.dataset.val;
    if(type === 'crystal') b.classList.toggle('chosen', pendingSelections.crystal === val);
    if(type === 'card') b.classList.toggle('chosen', pendingSelections.card === val);
  });
  document.getElementById('endround-confirm').disabled = !(pendingSelections.crystal && pendingSelections.card);
}

/* Modal interactions */
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('.symbol-btn');
  if(!btn) return;
  const type = btn.dataset.type;
  const val = btn.dataset.val;
  if(type === 'crystal'){
    pendingSelections.crystal = val;
  } else if(type === 'card'){
    pendingSelections.card = val;
  }
  refreshModalUI();
});

/* Modal controls: Cancel / Confirm */
document.getElementById('endround-cancel').addEventListener('click', ()=>{
  document.getElementById('endround-modal').style.display = 'none';
  pendingSelections.crystal = null; pendingSelections.card = null;
  refreshModalUI();
});

document.getElementById('endround-confirm').addEventListener('click', ()=>{
  if(!(pendingSelections.crystal && pendingSelections.card)) return;
  // Apply crystal
  mainModule.changeCrystal && mainModule.changeCrystal(pendingSelections.crystal, 1);
  // Apply Advanced Action card (increase count and add to deck)
  const color = pendingSelections.card.split('-')[1];
  mainModule.changeCardCount && mainModule.changeCardCount(color, 1);
  // After applying, reshuffle discard into deck to prepare next round
  mainModule.reshuffle && mainModule.reshuffle();
  // Close modal
  document.getElementById('endround-modal').style.display = 'none';
  pendingSelections.crystal = null; pendingSelections.card = null;
  refreshModalUI();
});

/* Draw button behavior */
document.getElementById('draw-btn').addEventListener('click', ()=>{
  const btn = document.getElementById('draw-btn');
  if(btn.textContent.trim() === 'End Round'){
    mainModule.openEndRoundModal();
    return;
  }
  mainModule.draw();
  mainModule.updateDrawButtonState();
});

/* Reshuffle button */
document.getElementById('reshuffle-btn').addEventListener('click', ()=> mainModule.reshuffle());

/* GV wiring */
document.getElementById('draw-btn-gv').addEventListener('click', ()=> gvModule.drawOnce());
document.getElementById('reshuffle-btn-gv').addEventListener('click', ()=> gvModule.reshuffle());
document.querySelectorAll('.gv-wound-btn').forEach(b=> b.addEventListener('click', ()=>{ gvModule.changeWounds(b.dataset.act === 'inc' ? 1 : -1); }));

/* Crystal manual adjustments */
document.querySelectorAll('.crystal-man').forEach(b=>{
  b.addEventListener('click', ()=> mainModule.changeCrystal(b.dataset.color, b.dataset.act === 'inc' ? 1 : -1));
});

/* Advanced action manual adjustments */
document.querySelectorAll('.adv-man').forEach(b=>{
  b.addEventListener('click', ()=> mainModule.changeCardCount(b.dataset.color, b.dataset.act === 'inc' ? 1 : -1));
});

/* Levels trigger / UI toggles */
const wrapper = document.getElementById('levels-wrapper');
const trigger = document.getElementById('levels-trigger');
const list = document.getElementById('levels-list');
if(trigger && wrapper && list){
  trigger.addEventListener('click', ()=>{
    const expanded = wrapper.getAttribute('aria-expanded') === 'true';
    wrapper.setAttribute('aria-expanded', expanded ? 'false' : 'true');
    list.style.display = expanded ? 'none' : 'block';
  });
  document.addEventListener('click', (ev)=>{ if(!wrapper.contains(ev.target)){ wrapper.setAttribute('aria-expanded','false'); list.style.display='none'; }});
  document.addEventListener('keydown', (ev)=>{ if(ev.key === 'Escape'){ wrapper.setAttribute('aria-expanded','false'); list.style.display='none'; }});
}

/* Fame input */
document.getElementById('fame-input').addEventListener('change', (e)=>{
  fame = Math.max(0, Math.floor(Number(e.target.value) || 0));
  document.getElementById('player-level-num').textContent = getFameLevel(fame);
  renderLevelsAchieved();
});

/* New game */
document.getElementById('new-game').addEventListener('click', ()=>{
  if(!confirm('Start a new game? This will reset saved progress and values to defaults.')) return;
  try{ localStorage.removeItem(`${STORAGE_KEY}_main`); localStorage.removeItem(`${STORAGE_KEY}_gv`); localStorage.removeItem(STORAGE_KEY + '_meta'); }catch(e){}
  fame = 0;
  mainModule.load(); mainModule.rebuildDeck();
  gvModule.buildDefaultDeck();
  mainModule.renderDeckAndDiscard && mainModule.renderDeckAndDiscard();
  gvModule.updateCounts && gvModule.updateCounts();
  mainModule.updateDrawButtonState();
  renderLevelsAchieved();
});

/* Persistence of rep/fame meta */
function saveMeta(){ try{ localStorage.setItem(STORAGE_KEY + '_meta', JSON.stringify({ fame, rep: window._repSelection || null })); }catch(e){} }
function loadMeta(){ try{ const raw = localStorage.getItem(STORAGE_KEY + '_meta'); if(!raw) return false; const m = JSON.parse(raw); fame = typeof m.fame === 'number' ? m.fame : fame; window._repSelection = m.rep || window._repSelection; return true; }catch(e){ return false; } }

/* Init on load */
window.addEventListener('load', ()=>{
  buildRepRows();
  loadMeta();
  if(window._repSelection) applyRepSelection(window._repSelection);
  renderLevelsAchieved();

  mainModule.load();
  mainModule.rebuildDeck();
  mainModule.renderDeckAndDiscard && mainModule.renderDeckAndDiscard();
  mainModule.updateDrawButtonState();

  gvModule.load();
  gvModule.buildDefaultDeck();
  gvModule.updateCounts && gvModule.updateCounts();
  gvModule.updateDrawButtonState && gvModule.updateDrawButtonState();

  refreshModalUI();

  // periodic save
  setInterval(()=>{ mainModule.save && mainModule.save(); gvModule.save && gvModule.save(); saveMeta(); }, 2000);
});
</script>
</body>
</html>
