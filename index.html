<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mage Knight Companion â€” Full Rewrite</title>
  <style>
    :root{
      --bg:#f4f4f4; --panel:#ececec; --card:#ffffff; --cell:#e8e8e8;
      --rep-min:44px; --overlay: rgba(0,0,0,0.45);
      --gold:#ffd700; --yellow:#ffeb99; --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:#111;padding:12px}
    h1{font-size:18px;margin:0 0 12px;text-align:center}
    .container{max-width:980px;margin:0 auto;display:flex;flex-direction:column;gap:12px}
    .panel{background:var(--panel);border-radius:10px;padding:10px}
    .panel-inner{background:var(--card);border-radius:8px;padding:12px;display:flex;flex-direction:column;gap:10px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type=number]{width:120px;padding:8px;border-radius:6px;border:1px solid #ccc}
    .smallbtn{padding:6px 10px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer}
    .muted{color:#666;font-size:13px}

    /* Reputation track */
    .rep-wrap{display:flex;flex-direction:column;gap:8px;align-items:center}
    .rep-row{display:flex;gap:8px;justify-content:center;align-items:center}
    .rep-cell{min-width:var(--rep-min);padding:6px 10px;background:var(--cell);border-radius:6px;text-align:center;cursor:pointer;user-select:none}
    .rep-row.top .rep-cell.selected{background:var(--gold);font-weight:700;color:#111}
    .rep-row.mid .rep-cell.selected{background:var(--yellow);font-weight:700;color:#111}
    .rep-row.bot .rep-cell.selected{background:var(--danger);font-weight:700;color:#fff}

    /* Levels achieved */
    .levels-list{background:#fff;padding:8px;border-radius:6px;min-height:36px;display:flex;gap:6px;flex-wrap:wrap}
    .level-pill{background:#eef;padding:6px 8px;border-radius:999px;font-weight:600;font-size:13px}

    /* Output boxes */
    .output{background:#fff;padding:8px;border-radius:6px;min-height:36px;font-size:14px}

    /* Modal */
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:var(--overlay);z-index:60}
    .modal{background:#fff;border-radius:10px;padding:16px;max-width:520px;width:92%;box-shadow:0 8px 30px rgba(0,0,0,0.25)}
    .modal h3{margin:0 0 8px 0;font-size:16px}
    .modal p{margin:8px 0;font-size:14px;white-space:pre-wrap}

    footer{display:flex;justify-content:center;padding:8px 0}
    @media (max-width:700px){ input[type=number]{width:90px} :root{--rep-min:34px} }
  </style>
</head>
<body>
  <h1>Mage Knight Companion</h1>

  <div class="container">

    <!-- Reputation -->
    <section class="panel" aria-labelledby="rep-title">
      <div class="panel-inner">
        <h2 id="rep-title">Reputation Track</h2>
        <div id="rep-wrap" class="rep-wrap" aria-label="Reputation track"></div>
      </div>
    </section>

    <!-- Fame + Levels Achieved -->
    <section class="panel" aria-labelledby="fame-title">
      <div class="panel-inner">
        <h2 id="fame-title">Fame Track</h2>

        <div class="row" style="align-items:center">
          <label style="font-weight:600;margin-right:8px">Fame</label>
          <input id="fame-input" type="number" min="0" max="119" value="0" aria-label="Fame value" />
          <div id="fame-result" class="output" style="min-width:120px">Level: <strong id="fame-level">1</strong></div>

          <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap">
            <button class="smallbtn fame-inc" data-inc="1">+1</button>
            <button class="smallbtn fame-inc" data-inc="2">+2</button>
            <button class="smallbtn fame-inc" data-inc="3">+3</button>
            <button class="smallbtn fame-inc" data-inc="5">+5</button>
            <button class="smallbtn fame-inc" data-inc="10">+10</button>
          </div>
        </div>

        <div>
          <h3 style="margin:8px 0 6px 0">Levels Achieved</h3>
          <div id="levels-list" class="levels-list" aria-live="polite">None yet</div>
        </div>
      </div>
    </section>

    <!-- Dummy player area (crystals/cards/ deck) -->
    <section class="panel" aria-labelledby="dummy-title">
      <div class="panel-inner">
        <h2 id="dummy-title">Dummy Player</h2>

        <div class="row" style="gap:18px">
          <div>
            <h3 style="margin:0 0 6px 0">Crystals</h3>
            <div class="row" style="align-items:center">
              <div>ðŸ”´ <strong id="red">0</strong></div>
              <div><button class="smallbtn" data-crystal="red" data-act="inc">+</button><button class="smallbtn" data-crystal="red" data-act="dec">âˆ’</button></div>
              <div style="width:12px"></div>
              <div>ðŸ”µ <strong id="blue">0</strong></div>
              <div><button class="smallbtn" data-crystal="blue" data-act="inc">+</button><button class="smallbtn" data-crystal="blue" data-act="dec">âˆ’</button></div>
              <div style="width:12px"></div>
              <div>ðŸŸ¢ <strong id="green">0</strong></div>
              <div><button class="smallbtn" data-crystal="green" data-act="inc">+</button><button class="smallbtn" data-crystal="green" data-act="dec">âˆ’</button></div>
              <div style="width:12px"></div>
              <div>âšª <strong id="white">0</strong></div>
              <div><button class="smallbtn" data-crystal="white" data-act="inc">+</button><button class="smallbtn" data-crystal="white" data-act="dec">âˆ’</button></div>
            </div>
          </div>

          <div>
            <h3 style="margin:0 0 6px 0">Cards</h3>
            <div class="row" style="align-items:center;gap:12px">
              <div>ðŸ”´ <strong id="card-red">4</strong></div>
              <div><button class="smallbtn card-btn" data-color="Red" data-act="inc">+</button><button class="smallbtn card-btn" data-color="Red" data-act="dec">âˆ’</button></div>

              <div>ðŸ”µ <strong id="card-blue">4</strong></div>
              <div><button class="smallbtn card-btn" data-color="Blue" data-act="inc">+</button><button class="smallbtn card-btn" data-color="Blue" data-act="dec">âˆ’</button></div>

              <div>ðŸŸ¢ <strong id="card-green">4</strong></div>
              <div><button class="smallbtn card-btn" data-color="Green" data-act="inc">+</button><button class="smallbtn card-btn" data-color="Green" data-act="dec">âˆ’</button></div>

              <div>âšª <strong id="card-white">4</strong></div>
              <div><button class="smallbtn card-btn" data-color="White" data-act="inc">+</button><button class="smallbtn card-btn" data-color="White" data-act="dec">âˆ’</button></div>
            </div>

            <div style="margin-top:8px" class="muted">Cards in deck: <strong id="deck-count">0</strong></div>
          </div>
        </div>

        <div style="margin-top:10px" class="row">
          <button id="draw-btn" class="smallbtn">Draw</button>
          <div id="dummy-output" class="output" style="flex:1;margin-left:8px">Drawn symbols appear here</div>
        </div>

        <div style="margin-top:8px">
          <div id="discard-output" class="output">Discard pile is empty.</div>
        </div>
      </div>
    </section>

    <footer>
      <button id="new-game" class="smallbtn">New Game</button>
    </footer>
  </div>

  <!-- Level modal (shows combined prompts when multiple levels gained) -->
  <div id="level-modal" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="level-title">
      <h3 id="level-title">Level Up</h3>
      <p id="level-message"></p>
      <div style="display:flex;justify-content:flex-end;margin-top:12px">
        <button id="level-ok" class="smallbtn">OK</button>
      </div>
    </div>
  </div>

  <script>
    /*
      Full rewrite implementing:
      - Reputation track (top/mid/bottom rows as requested)
      - Fame input overrides current fame on change / Enter
      - Increment buttons add to current fame
      - When fame jumps multiple levels, show all relevant prompts together in single modal
      - "Levels Achieved" list under Fame persists and shows every level reached (no duplicates)
      - Persistent save via localStorage for full game state
      - New Game button resets to defaults (including crystals and cards)
      - Dummy player draw/discard simplified functioning included
    */

    const STORAGE_KEY = 'mk_companion_state_v1';

    // Defaults
    const DEFAULT_CARDS = { Red: 4, Blue: 4, Green: 4, White: 4 };
    const DEFAULT_CRYSTALS = { red: 0, blue: 0, green: 0, white: 0 };

    // Reputation rows content
    const REP_TOP = ["0","+1","+1","+2","+2","+3","+5"];
    const REP_MID = ["0"];
    const REP_BOT = ["0","-1","-1","-2","-3","-5","X"];

    // Fame level thresholds
    const FAME_LEVELS = [
      {level:1, min:0,  max:2},
      {level:2, min:3,  max:7},
      {level:3, min:8,  max:14},
      {level:4, min:15, max:23},
      {level:5, min:24, max:34},
      {level:6, min:35, max:47},
      {level:7, min:48, max:62},
      {level:8, min:63, max:79},
      {level:9, min:80, max:98},
      {level:10,min:99, max:119}
    ];

    const LEVEL_PROMPTS = {
      2: "Draw skill and advanced action",
      3: "Flip level token to command token",
      4: "Draw skill and advanced action",
      5: "Flip level token to command token",
      6: "Draw skill and advanced action",
      7: "Flip level token to command token",
      8: "Draw skill and advanced action",
      9: "Flip level token to command token",
      10: "Draw skill and advanced action"
    };

    const COLOR_SYMBOL = { Red:'ðŸ”´', Blue:'ðŸ”µ', Green:'ðŸŸ¢', White:'âšª', red:'ðŸ”´', blue:'ðŸ”µ', green:'ðŸŸ¢', white:'âšª' };

    // State
    let fame = 0;
    let crystals = { ...DEFAULT_CRYSTALS };
    let cardCounts = { ...DEFAULT_CARDS };
    let dummyDeck = [];
    let discardPile = [];
    let endRoundFlag = false;
    let achievedLevels = []; // chronological list of levels reached (no duplicates)
    let repSelection = null; // { row: 'top'|'mid'|'bot', index: n }

    // DOM refs
    const repWrap = document.getElementById('rep-wrap');
    const fameInput = document.getElementById('fame-input');
    const fameLevelEl = document.getElementById('fame-level');
    const fameResult = document.getElementById('fame-result');
    const levelsList = document.getElementById('levels-list');
    const newGameBtn = document.getElementById('new-game');
    const levelModal = document.getElementById('level-modal');
    const levelMessage = document.getElementById('level-message');
    const levelOk = document.getElementById('level-ok');
    const drawBtn = document.getElementById('draw-btn');
    const dummyOutput = document.getElementById('dummy-output');
    const discardOutput = document.getElementById('discard-output');

    // Utility helpers
    function clampInt(v, min, max){ const n = Math.floor(Number(v)||0); return Math.max(min, Math.min(max, n)); }
    function getFameLevel(v){
      const val = clampInt(v, 0, 119);
      for (const b of FAME_LEVELS) if (val >= b.min && val <= b.max) return b.level;
      return 1;
    }

    // Persistence
    function saveState(){
      try {
        const s = {
          fame, crystals, cardCounts, dummyDeck, discardPile,
          endRoundFlag, achievedLevels, repSelection
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
      } catch(e){ /* ignore */ }
    }

    function loadState(){
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return false;
        const s = JSON.parse(raw);
        fame = typeof s.fame === 'number' ? s.fame : fame;
        crystals = s.crystals || crystals;
        cardCounts = s.cardCounts || cardCounts;
        dummyDeck = Array.isArray(s.dummyDeck) ? s.dummyDeck : dummyDeck;
        discardPile = Array.isArray(s.discardPile) ? s.discardPile : discardPile;
        endRoundFlag = !!s.endRoundFlag;
        achievedLevels = Array.isArray(s.achievedLevels) ? s.achievedLevels : achievedLevels;
        repSelection = s.repSelection || repSelection;
        return true;
      } catch(e){ return false; }
    }

    function clearSavedState(){ try { localStorage.removeItem(STORAGE_KEY); } catch(e){} }

    // Reputation UI
    function buildRepRows(){
      repWrap.innerHTML = '';
      const top = document.createElement('div'); top.className='rep-row top';
      REP_TOP.forEach((label, i) => {
        const c = document.createElement('div'); c.className='rep-cell'; c.textContent = label;
        c.addEventListener('click', ()=>{ selectRepCell({row:'top',index:i}); saveState(); });
        top.appendChild(c);
      });
      const mid = document.createElement('div'); mid.className='rep-row mid';
      REP_MID.forEach((label,i)=>{ const c=document.createElement('div'); c.className='rep-cell'; c.textContent=label;
        c.addEventListener('click', ()=>{ selectRepCell({row:'mid',index:i}); saveState(); }); mid.appendChild(c);
      });
      const bot = document.createElement('div'); bot.className='rep-row bot';
      REP_BOT.forEach((label,i)=>{ const c=document.createElement('div'); c.className='rep-cell'; c.textContent=label;
        c.addEventListener('click', ()=>{ selectRepCell({row:'bot',index:i}); saveState(); }); bot.appendChild(c);
      });
      repWrap.appendChild(top); repWrap.appendChild(mid); repWrap.appendChild(bot);

      // apply selection from state or default
      if (repSelection) applyRepSelection(repSelection);
      else {
        // default: select middle 0
        const midCell = repWrap.querySelector('.rep-row.mid .rep-cell');
        if (midCell) { midCell.classList.add('selected'); repSelection = {row:'mid',index:0}; }
      }
    }

    function selectRepCell(sel){
      // sel = {row:'top'|'mid'|'bot', index:n}
      const all = repWrap.querySelectorAll('.rep-cell');
      all.forEach(c=>c.classList.remove('selected'));
      const rowEl = repWrap.querySelector(`.rep-row.${sel.row}`);
      if (!rowEl) return;
      const cells = rowEl.querySelectorAll('.rep-cell');
      if (cells[sel.index]) {
        cells[sel.index].classList.add('selected');
        repSelection = { ...sel };
      }
    }

    function applyRepSelection(sel){
      if (!sel) return;
      const rowEl = repWrap.querySelector(`.rep-row.${sel.row}`);
      if (!rowEl) return;
      const cells = rowEl.querySelectorAll('.rep-cell');
      if (cells[sel.index]) {
        cells[sel.index].classList.add('selected');
      }
    }

    // Levels Achieved UI
    function renderLevels(){
      levelsList.innerHTML = '';
      if (!achievedLevels || achievedLevels.length === 0) {
        levelsList.textContent = 'None yet';
        return;
      }
      achievedLevels.forEach(L => {
        const pill = document.createElement('div');
        pill.className='level-pill';
        const prompt = LEVEL_PROMPTS[L] ? ` â€” ${LEVEL_PROMPTS[L]}` : '';
        pill.textContent = `Level ${L}${prompt}`;
        levelsList.appendChild(pill);
      });
    }

    // Fame updates and prompts
    function handleLevelPrompts(prevLevel, newLevel){
      const messages = [];
      for (let L = prevLevel + 1; L <= newLevel; L++){
        if (LEVEL_PROMPTS[L]) messages.push(`Level ${L}: ${LEVEL_PROMPTS[L]}`);
      }
      if (messages.length === 0) return;
      // show combined modal
      levelMessage.textContent = messages.join('\n');
      levelModal.style.display = 'flex';
      levelModal.setAttribute('aria-hidden','false');
    }

    function updateFameUI(prevFame = null){
      const prevLevel = prevFame !== null ? getFameLevel(prevFame) : null;
      const level = getFameLevel(fame);
      fameLevelEl.textContent = level;
      fameInput.value = fame;
      fameResult.innerHTML = `Level: <strong id="fame-level">${level}</strong>`;
      // record achieved levels
      if (prevLevel !== null && level > prevLevel) {
        for (let L = prevLevel + 1; L <= level; L++){
          if (!achievedLevels.includes(L)) achievedLevels.push(L);
        }
        renderLevels();
      }
      // if prevLevel provided and level increased, show prompts
      if (prevLevel !== null && level > prevLevel) handleLevelPrompts(prevLevel, level);
      saveState();
    }

    // Deck, draw, discard
    function rebuildDeckFromCounts(){
      dummyDeck = [];
      Object.keys(cardCounts).forEach(color => {
        for (let i=0;i<cardCounts[color];i++) dummyDeck.push(`${color} Card`);
      });
      shuffle(dummyDeck);
      updateDeckCount();
      saveState();
    }

    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

    function updateDeckCount(){ document.getElementById('deck-count').textContent = dummyDeck.length; }

    function updateDiscardUI(){
      if (!discardPile || discardPile.length === 0) discardOutput.textContent = 'Discard pile is empty.';
      else {
        const syms = discardPile.map(c => COLOR_SYMBOL[c.split(' ')[0]] || c);
        discardOutput.textContent = `Discard (${discardPile.length}): ${syms.join(' ')}`;
      }
    }

    function onDrawClick(){
      if (endRoundFlag) {
        // end round behavior simplified: trigger adding and re-shuffle handled elsewhere
        dummyOutput.textContent = 'End round pending â€” use New Game or actions to continue.';
        return;
      }
      const drawn = [];
      for (let i=0;i<3 && dummyDeck.length>0;i++) drawn.push(dummyDeck.pop());
      const last = drawn[drawn.length-1];
      if (last){
        const color = last.split(' ')[0].toLowerCase();
        const extra = crystals[color] || 0;
        for (let i=0;i<extra && dummyDeck.length>0;i++) drawn.push(dummyDeck.pop());
      }
      if (drawn.length === 0){
        endRoundFlag = true;
        drawBtn.textContent = 'End Round';
        dummyOutput.textContent = 'No cards drawn. End of round.';
        saveState();
        return;
      }
      discardPile.push(...drawn);
      const syms = drawn.map(c=>COLOR_SYMBOL[c.split(' ')[0]] || c);
      dummyOutput.textContent = syms.join(' ');
      updateDeckCount();
      updateDiscardUI();
      saveState();
    }

    // Crystals and Cards change
    function changeCrystal(color, delta){
      crystals[color] = Math.max(0, (crystals[color]||0) + delta);
      document.getElementById(color).textContent = crystals[color];
      saveState();
    }

    function changeCard(color, delta){
      cardCounts[color] = Math.max(0, (cardCounts[color]||0) + delta);
      document.getElementById(`card-${color.toLowerCase()}`).textContent = cardCounts[color];
      if (delta > 0){
        // add one card into deck at random position
        const name = `${color} Card`;
        const pos = Math.floor(Math.random() * (dummyDeck.length + 1));
        dummyDeck.splice(pos, 0, name);
      } else {
        // remove one card preferentially from deck, else discard
        const name = `${color} Card`;
        const idx = dummyDeck.indexOf(name);
        if (idx !== -1) dummyDeck.splice(idx,1);
        else {
          const dj = discardPile.indexOf(name);
          if (dj !== -1) discardPile.splice(dj,1);
        }
      }
      updateDeckCount();
      updateDiscardUI();
      saveState();
    }

    // Fame change handlers
    function setFameOverride(value){
      const prevFame = fame;
      fame = clampInt(value, 0, 119);
      updateFameUI(prevFame);
    }

    function addFame(delta){
      const prevFame = fame;
      fame = clampInt(fame + delta, 0, 119);
      updateFameUI(prevFame);
    }

    // New Game reset
    function newGame(){
      clearSavedState();
      fame = 0;
      crystals = { ...DEFAULT_CRYSTALS };
      cardCounts = { ...DEFAULT_CARDS };
      dummyDeck = [];
      discardPile = [];
      endRoundFlag = false;
      achievedLevels = [];
      repSelection = null;
      rebuildDeckFromCounts();
      updateDiscardUI();
      buildRepRows();
      // apply default rep selection to middle
      const midCell = repWrap.querySelector('.rep-row.mid .rep-cell');
      if (midCell) { midCell.classList.add('selected'); repSelection = {row:'mid',index:0}; }
      // update UI values
      document.getElementById('red').textContent = crystals.red;
      document.getElementById('blue').textContent = crystals.blue;
      document.getElementById('green').textContent = crystals.green;
      document.getElementById('white').textContent = crystals.white;
      document.getElementById('card-red').textContent = cardCounts.Red;
      document.getElementById('card-blue').textContent = cardCounts.Blue;
      document.getElementById('card-green').textContent = cardCounts.Green;
      document.getElementById('card-white').textContent = cardCounts.White;
      updateFameUI(null);
      renderLevels();
      saveState();
    }

    // Init UI wiring
    window.addEventListener('load', ()=>{
      // build rep rows & try loading state
      buildRepRows();
      const ok = loadState();

      // reflect crystals/cards
      document.getElementById('red').textContent = crystals.red || 0;
      document.getElementById('blue').textContent = crystals.blue || 0;
      document.getElementById('green').textContent = crystals.green || 0;
      document.getElementById('white').textContent = crystals.white || 0;

      document.getElementById('card-red').textContent = cardCounts.Red;
      document.getElementById('card-blue').textContent = cardCounts.Blue;
      document.getElementById('card-green').textContent = cardCounts.Green;
      document.getElementById('card-white').textContent = cardCounts.White;

      if (!ok) {
        // fresh start
        rebuildDeckFromCounts();
        achievedLevels = [];
        repSelection = repSelection || {row:'mid', index:0};
        saveState();
      } else {
        // ensure deck exists
        if (!Array.isArray(dummyDeck) || dummyDeck.length === 0) rebuildDeckFromCounts();
      }

      updateDeckCount();
      updateDiscardUI();
      updateFameUI(null); // use null so no prompts on load
      renderLevels();

      // wire fame input
      fameInput.addEventListener('change', ()=> setFameOverride(fameInput.value));
      fameInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter'){ e.preventDefault(); setFameOverride(fameInput.value); fameInput.blur(); } });

      // inc buttons
      document.querySelectorAll('.fame-inc').forEach(btn=>{
        btn.addEventListener('click', ()=> addFame(Number(btn.dataset.inc||0)));
      });

      // crystals buttons (delegated)
      document.querySelectorAll('[data-crystal]').forEach(b=>{
        b.addEventListener('click', ()=> {
          const color = b.dataset.crystal;
          const act = b.dataset.act;
          changeCrystal(color, act === 'inc' ? 1 : -1);
        });
      });

      // card buttons
      document.querySelectorAll('.card-btn').forEach(b=>{
        b.addEventListener('click', ()=>{
          const color = b.dataset.color;
          const act = b.dataset.act;
          changeCard(color, act === 'inc' ? 1 : -1);
        });
      });

      // Draw button
      drawBtn.addEventListener('click', onDrawClick);

      // Level modal ok
      levelOk.addEventListener('click', ()=> {
        levelModal.style.display = 'none';
        levelModal.setAttribute('aria-hidden','true');
      });

      // New Game
      newGameBtn.addEventListener('click', ()=> {
        if (confirm('Start a new game? This will reset saved progress and values to defaults.')) newGame();
      });

      // Save on page unload (best-effort)
      window.addEventListener('beforeunload', saveState);
    });

    // expose small helpers for debugging (optional)
    window._mk_saveState = saveState;
    window._mk_loadState = loadState;
    window._mk_newGame = newGame;
  </script>
</body>
</html>
