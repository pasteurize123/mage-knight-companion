<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mage Knight Companion â€” Dummy Player</title>
  <style>
    :root{
      --bg:#f4f4f4;
      --panel-bg:#ececec;
      --box-bg:#ffffff;
      --cell:#e8e8e8;
      --sel-rep:#bfe7c7;
      --sel-fame:#ffdca3;
      --gap:10px;
      --rep-min:44px;
      --overlay-bg: rgba(0,0,0,0.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      background:var(--bg);
      color:#111;
      padding:12px;
    }
    h1{font-size:18px;margin:0 0 12px;text-align:center}
    .container{display:flex;flex-direction:column;gap:12px;max-width:900px;margin:0 auto}

    .boxed { background:var(--panel-bg); border-radius:10px; padding:10px; }
    .box-inner { background:var(--box-bg); border-radius:8px; padding:10px; display:flex; flex-direction:column; gap:10px; }
    h2{font-size:14px;margin:0}

    .rep-wrap{display:flex;flex-direction:column;gap:8px;width:100%;align-items:center}
    .rep-row{display:flex;gap:8px;align-items:center;justify-content:center}
    .rep-row .rep-cell{flex:0 0 auto;min-width:var(--rep-min);padding:6px 10px;background:var(--cell);border-radius:6px;text-align:center;cursor:pointer;font-size:13px;user-select:none}
    .rep-cell.selected{background:var(--sel-rep);font-weight:700}

    .fame-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .fame-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    select, input[type=number]{width:120px;padding:8px;border-radius:6px;border:1px solid #ccc;font-size:14px}
    .fame-result{font-weight:700;font-size:16px;padding:6px 8px;background:#fff;border-radius:6px}
    .fame-btn{padding:6px 10px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer;font-size:14px}

    .combined-grid{display:flex;flex-direction:column;gap:8px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .cols{display:flex;gap:8px;align-items:flex-start;flex-wrap:wrap}
    .col{background:var(--box-bg);border-radius:8px;padding:8px;min-width:160px;flex:1}
    .col h3{font-size:13px;margin:0 0 6px 0}
    .smallbtn{font-size:13px;padding:6px 8px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer}
    .output{background:#fff;padding:8px;border-radius:6px;min-height:36px;font-size:13px;overflow:hidden}
    .stat{font-weight:700}

    .inline-item{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:8px}

    /* modal / overlay */
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:var(--overlay-bg);z-index:50}
    .modal{background:#fff;border-radius:10px;padding:16px;max-width:420px;width:92%;box-shadow:0 8px 30px rgba(0,0,0,0.25)}
    .modal h3{margin:0 0 8px 0;font-size:16px}
    .choice-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .choice-btn{padding:8px 10px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer;font-size:16px}
    .choice-btn.selected{background:#eef6e9;border-color:#9fd49f}
    .modal-foot{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    @media (max-width:820px){ .cols{flex-direction:column} .col{min-width:0} }
    @media (max-width:420px){
      :root{--rep-min:32px}
      select, input[type=number]{width:90px;padding:6px}
      .fame-result{font-size:14px}
      .rep-cell{font-size:12px;padding:5px 6px}
      .smallbtn{font-size:12px;padding:5px 6px}
    }
  </style>
</head>
<body>
  <h1>Mage Knight Companion</h1>

  <div class="container">

    <section class="boxed" aria-labelledby="rep-section">
      <div class="box-inner">
        <h2 id="rep-section">Reputation Track</h2>

        <div class="rep-wrap" id="rep-wrap" aria-label="Reputation three rows"></div>

        <div style="text-align:center;font-size:13px">Selected: <strong id="rep-display">0</strong></div>
      </div>
    </section>

    <section class="boxed" aria-labelledby="fame-section">
      <div class="box-inner">
        <h2 id="fame-section">Fame Track</h2>

        <div class="fame-row" role="group" aria-label="Fame input">
          <div class="fame-controls" style="flex:1">
            <!-- Manual numeric input still available -->
            <label for="fame-input" style="font-size:13px">Tracked Fame</label>
            <input id="fame-input" type="number" min="0" max="119" value="0" aria-label="Fame value" />
            <div class="fame-result" id="fame-result" aria-live="polite">Level 1</div>
            <div style="margin-left:auto;font-size:13px">Fame: <strong id="fame-display">0</strong></div>
          </div>

          <!-- New controls: select increment and add/subtract buttons -->
          <div style="display:flex;align-items:center;gap:8px">
            <label for="fame-increment" style="font-size:13px">Amount</label>
            <select id="fame-increment" aria-label="Fame increment">
              <option value="1">+1</option>
              <option value="2">+2</option>
              <option value="3">+3</option>
              <option value="5">+5</option>
              <option value="10">+10</option>
            </select>
            <button id="fame-add" class="fame-btn" title="Add selected amount to tracked fame">Add</button>
            <button id="fame-sub" class="fame-btn" title="Subtract selected amount from tracked fame">Subtract</button>
          </div>
        </div>

      </div>
    </section>

    <section class="boxed" aria-labelledby="combined-section">
      <div class="box-inner">
        <h2 id="combined-section">Dummy Player</h2>

        <div class="combined-grid">
          <div class="cols">
            <!-- Crystals now belong to the Dummy Player -->
            <div class="col" aria-labelledby="crystal-title">
              <h3 id="crystal-title">Crystals</h3>
              <div class="inline-item">
                <div style="font-size:18px">ðŸ”´ <span class="stat" id="red">0</span></div>
                <div><button class="smallbtn" onclick="changeCrystal('red',1)">+</button><button class="smallbtn" onclick="changeCrystal('red',-1)">âˆ’</button></div>

                <div style="width:12px"></div>

                <div style="font-size:18px">ðŸ”µ <span class="stat" id="blue">0</span></div>
                <div><button class="smallbtn" onclick="changeCrystal('blue',1)">+</button><button class="smallbtn" onclick="changeCrystal('blue',-1)">âˆ’</button></div>
              </div>

              <div class="inline-item">
                <div style="font-size:18px">ðŸŸ¢ <span class="stat" id="green">0</span></div>
                <div><button class="smallbtn" onclick="changeCrystal('green',1)">+</button><button class="smallbtn" onclick="changeCrystal('green',-1)">âˆ’</button></div>

                <div style="width:12px"></div>

                <div style="font-size:18px">âšª <span class="stat" id="white">0</span></div>
                <div><button class="smallbtn" onclick="changeCrystal('white',1)">+</button><button class="smallbtn" onclick="changeCrystal('white',-1)">âˆ’</button></div>
              </div>
            </div>

            <div class="col" aria-labelledby="cards-title">
              <h3 id="cards-title">Cards</h3>
              <div class="inline-item">
                <div style="font-size:18px">ðŸ”´ <span class="stat" id="card-red">4</span></div>
                <div><button class="smallbtn" onclick="changeCard('Red',1)">+</button><button class="smallbtn" onclick="changeCard('Red',-1)">âˆ’</button></div>

                <div style="width:12px"></div>

                <div style="font-size:18px">ðŸ”µ <span class="stat" id="card-blue">4</span></div>
                <div><button class="smallbtn" onclick="changeCard('Blue',1)">+</button><button class="smallbtn" onclick="changeCard('Blue',-1)">âˆ’</button></div>
              </div>

              <div class="inline-item">
                <div style="font-size:18px">ðŸŸ¢ <span class="stat" id="card-green">4</span></div>
                <div><button class="smallbtn" onclick="changeCard('Green',1)">+</button><button class="smallbtn" onclick="changeCard('Green',-1)">âˆ’</button></div>

                <div style="width:12px"></div>

                <div style="font-size:18px">âšª <span class="stat" id="card-white">4</span></div>
                <div><button class="smallbtn" onclick="changeCard('White',1)">+</button><button class="smallbtn" onclick="changeCard('White',-1)">âˆ’</button></div>
              </div>
            </div>

            <div class="col">
              <div style="margin-top:8px;font-size:13px">Cards in deck: <strong id="deck-count">0</strong></div>
            </div>
          </div>

          <div class="row" style="margin-top:6px;align-items:center">
            <button id="draw-btn" class="smallbtn" onclick="onDrawClick()">Draw</button>
            <div id="dummy-output" class="output" style="flex:1;margin-left:8px">Drawn symbols will appear here.</div>
          </div>

          <div style="margin-top:6px">
            <div id="discard-output" class="output">Discard pile is empty.</div>

            <div style="margin-top:8px;display:flex;justify-content:center">
              <button class="smallbtn" onclick="resetDeck()">Reset Deck</button>
            </div>
          </div>

        </div>
      </div>
    </section>

  </div>

  <!-- Modal used when End Round triggered -->
  <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <h3 id="modal-title">End Round â€” Choose Additions</h3>

      <div style="margin-bottom:6px">Choose one crystal to add to the dummy player</div>
      <div class="choice-row" id="crystal-choices">
        <button class="choice-btn" data-val="red">ðŸ”´</button>
        <button class="choice-btn" data-val="blue">ðŸ”µ</button>
        <button class="choice-btn" data-val="green">ðŸŸ¢</button>
        <button class="choice-btn" data-val="white">âšª</button>
      </div>

      <div style="margin-top:8px;margin-bottom:6px">Choose one card to add to the dummy player</div>
      <div class="choice-row" id="card-choices">
        <button class="choice-btn" data-val="Red">ðŸ”´</button>
        <button class="choice-btn" data-val="Blue">ðŸ”µ</button>
        <button class="choice-btn" data-val="Green">ðŸŸ¢</button>
        <button class="choice-btn" data-val="White">âšª</button>
      </div>

      <div class="modal-foot">
        <button class="smallbtn" id="modal-cancel">Cancel</button>
        <button class="smallbtn" id="modal-confirm" disabled>Confirm</button>
      </div>
    </div>
  </div>

  <script>
    // State
    let fame = 0; // tracked fame value
    // crystals belong to the dummy player
    let crystals = { red: 0, blue: 0, green: 0, white: 0 };
    let cardCounts = { Red: 4, Blue: 4, Green: 4, White: 4 };
    let dummyDeck = [];
    let discardPile = [];
    let endRoundFlag = false; // true when next action should be End Round flow

    const repPositive = ["+1","+1","+2","+2","+3","+5"];
    const repNeutral = ["0","0","0"];
    const repNegative = ["-1","-1","-2","-3","-5","X"];

    const fameLevels = [
      {level:1, min:0,  max:2},
      {level:2, min:3,  max:7},
      {level:3, min:8,  max:14},
      {level:4, min:15, max:23},
      {level:5, min:24, max:34},
      {level:6, min:35, max:47},
      {level:7, min:48, max:62},
      {level:8, min:63, max:79},
      {level:9, min:80, max:98},
      {level:10,min:99, max:119}
    ];

    const colorSymbol = {
      Red: 'ðŸ”´', Blue: 'ðŸ”µ', Green: 'ðŸŸ¢', White: 'âšª',
      red: 'ðŸ”´', blue: 'ðŸ”µ', green: 'ðŸŸ¢', white: 'âšª'
    };

    // DOM refs
    const repWrap = document.getElementById('rep-wrap');
    const repDisplayEl = document.getElementById('rep-display');
    const fameInput = document.getElementById('fame-input');
    const fameResult = document.getElementById('fame-result');
    const fameDisplayEl = document.getElementById('fame-display');
    const fameIncrement = document.getElementById('fame-increment');
    const fameAddBtn = document.getElementById('fame-add');
    const fameSubBtn = document.getElementById('fame-sub');

    const dummyOutput = document.getElementById('dummy-output');
    const discardOutput = document.getElementById('discard-output');
    const drawBtn = document.getElementById('draw-btn');

    const overlay = document.getElementById('overlay');
    const crystalChoices = document.getElementById('crystal-choices');
    const cardChoices = document.getElementById('card-choices');
    const modalConfirm = document.getElementById('modal-confirm');
    const modalCancel = document.getElementById('modal-cancel');

    let selectedCrystal = null;
    let selectedCardColor = null;

    // Build reputation rows
    function buildRepRows() {
      repWrap.innerHTML = '';
      const topRow = document.createElement('div'); topRow.className = 'rep-row';
      repPositive.forEach(label => {
        const el = document.createElement('div'); el.className = 'rep-cell'; el.textContent = label;
        el.addEventListener('click', () => selectRep(el, label));
        topRow.appendChild(el);
      });
      const midRow = document.createElement('div'); midRow.className = 'rep-row';
      repNeutral.forEach(label => {
        const el = document.createElement('div'); el.className = 'rep-cell'; el.textContent = label;
        el.addEventListener('click', () => selectRep(el, label));
        midRow.appendChild(el);
      });
      const botRow = document.createElement('div'); botRow.className = 'rep-row';
      repNegative.forEach(label => {
        const el = document.createElement('div'); el.className = 'rep-cell'; el.textContent = label;
        el.addEventListener('click', () => selectRep(el, label));
        botRow.appendChild(el);
      });
      repWrap.appendChild(topRow);
      repWrap.appendChild(midRow);
      repWrap.appendChild(botRow);
    }

    function clearRepSelection() {
      Array.from(repWrap.querySelectorAll('.rep-cell')).forEach(c => c.classList.remove('selected'));
    }
    function selectRep(el, label) {
      clearRepSelection();
      el.classList.add('selected');
      repDisplayEl.textContent = label;
    }

    // Fame helpers
    function getFameLevel(v) {
      const val = Math.max(0, Math.min(119, Math.floor(Number(v) || 0)));
      for (const b of fameLevels) if (val >= b.min && val <= b.max) return b.level;
      return 1;
    }
    function updateFameUI() {
      const level = getFameLevel(fame);
      fameResult.textContent = `Level ${level}`;
      fameDisplayEl.textContent = fame;
      fameInput.value = fame;
    }
    function setFame(v) {
      fame = Math.max(0, Math.min(119, Math.floor(Number(v) || 0)));
      updateFameUI();
    }

    // wired to numeric input
    fameInput.addEventListener('input', () => {
      setFame(fameInput.value);
    });

    // Add/subtract using selected increment
    fameAddBtn.addEventListener('click', () => {
      const inc = Math.max(1, parseInt(fameIncrement.value || "1", 10));
      setFame(fame + inc);
    });
    fameSubBtn.addEventListener('click', () => {
      const inc = Math.max(1, parseInt(fameIncrement.value || "1", 10));
      setFame(fame - inc);
    });

    // Crystals change (dummy player's crystals)
    function changeCrystal(color, amount) {
      const key = color.toLowerCase();
      crystals[key] = Math.max(0, (crystals[key] || 0) + amount);
      document.getElementById(key).textContent = crystals[key];
    }

    // Card counts: update counts and immediately add/remove from live deck
    function changeCard(color, amount) {
      // update stored counts
      cardCounts[color] = Math.max(0, (cardCounts[color] || 0) + amount);
      document.getElementById(`card-${color.toLowerCase()}`).textContent = cardCounts[color];

      // when incrementing: add one card of that color to the deck (insert at random position)
      if (amount > 0) {
        const cardName = `${color} Card`;
        const idx = Math.floor(Math.random() * (dummyDeck.length + 1));
        dummyDeck.splice(idx, 0, cardName);
      }

      // when decrementing: remove one card of that color from deck or discard if present
      if (amount < 0) {
        const cardName = `${color} Card`;
        const i = dummyDeck.findIndex(c => c === cardName);
        if (i !== -1) {
          dummyDeck.splice(i, 1);
        } else {
          const j = discardPile.findIndex(c => c === cardName);
          if (j !== -1) discardPile.splice(j, 1);
        }
      }

      updateDeckCount();
      updateDiscard();
    }

    function rebuildDeckFromCounts() {
      dummyDeck = [];
      Object.keys(cardCounts).forEach(color => {
        for (let i=0;i<cardCounts[color];i++) dummyDeck.push(`${color} Card`);
      });
      shuffle(dummyDeck);
      updateDeckCount();
    }

    // initialize/reset deck
    function initializeDeck() {
      rebuildDeckFromCounts();
      discardPile = [];
      endRoundFlag = false;
      updateDrawButton();
      updateDiscard();
      dummyOutput.textContent = 'Deck initialized and shuffled.';
      setFame(0); // optional: keep tracked fame initialised (remove if undesired)
    }
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

    function resetDeck(){ initializeDeck(); }

    function updateDrawButton(){ drawBtn.textContent = endRoundFlag ? 'End Round' : 'Draw'; }

    // DRAW flow
    function onDrawClick(){
      if(endRoundFlag){
        // End Round selected -> open modal forcing crystal + card addition, then reshuffle discard into deck
        openEndRoundModal();
        return;
      }

      // Normal draw logic
      const drawn = [];
      for(let i=0;i<3 && dummyDeck.length>0;i++){
        drawn.push(dummyDeck.pop());
      }

      // extra draws based on crystals matching last drawn color
      const last = drawn[drawn.length-1];
      if(last){
        const color = last.split(' ')[0].toLowerCase();
        const extra = crystals[color] || 0;
        for(let i=0;i<extra && dummyDeck.length>0;i++) drawn.push(dummyDeck.pop());
      }

      // If this draw produced zero drawn cards -> switch to End Round mode
      if(drawn.length === 0){
        endRoundFlag = true;
        updateDrawButton();
        dummyOutput.textContent = 'No cards drawn. End of round announced.';
        return;
      }

      // Otherwise, put drawn into discard and show symbols
      discardPile.push(...drawn);
      const drawnSymbols = drawn.map(c => {
        const color = c.split(' ')[0];
        return colorSymbol[color] || c;
      });
      dummyOutput.textContent = drawnSymbols.join(' ');

      updateDeckCount();
      updateDiscard();
      // If deck emptied here, keep button as Draw; only a subsequent Draw that yields 0 will set endRoundFlag.
    }

    // Modal flow for End Round
    function openEndRoundModal(){
      selectedCrystal = null;
      selectedCardColor = null;
      modalConfirm.disabled = true;
      overlay.style.display = 'flex';
      overlay.setAttribute('aria-hidden', 'false');
      Array.from(crystalChoices.querySelectorAll('.choice-btn')).forEach(b => b.classList.remove('selected'));
      Array.from(cardChoices.querySelectorAll('.choice-btn')).forEach(b => b.classList.remove('selected'));
    }
    function closeModal(){ overlay.style.display = 'none'; overlay.setAttribute('aria-hidden', 'true'); }

    crystalChoices.addEventListener('click', (e) => {
      const btn = e.target.closest('.choice-btn');
      if(!btn) return;
      selectedCrystal = btn.dataset.val;
      Array.from(crystalChoices.querySelectorAll('.choice-btn')).forEach(b => b.classList.toggle('selected', b === btn));
      modalConfirm.disabled = !(selectedCrystal && selectedCardColor);
    });

    cardChoices.addEventListener('click', (e) => {
      const btn = e.target.closest('.choice-btn');
      if(!btn) return;
      selectedCardColor = btn.dataset.val;
      Array.from(cardChoices.querySelectorAll('.choice-btn')).forEach(b => b.classList.toggle('selected', b === btn));
      modalConfirm.disabled = !(selectedCrystal && selectedCardColor);
    });

    modalCancel.addEventListener('click', () => {
      // keep endRoundFlag true, just close modal
      closeModal();
    });

    modalConfirm.addEventListener('click', () => {
      if(!selectedCrystal || !selectedCardColor) return;
      // 1) add one crystal to the dummy player
      changeCrystal(selectedCrystal, 1);
      // 2) add one card of selected color to counts and immediately to deck
      changeCard(selectedCardColor, 1);
      // 3) reshuffle discard into deck and clear discard
      if(discardPile.length > 0){
        dummyDeck.push(...discardPile);
        discardPile = [];
        shuffle(dummyDeck);
      }
      // update UI
      updateDeckCount();
      updateDiscard();
      dummyOutput.textContent = `End Round: added ${colorSymbol[selectedCardColor] || selectedCardColor} and ${colorSymbol[selectedCrystal] || selectedCrystal}. Deck reshuffled.`;
      endRoundFlag = false;
      updateDrawButton();
      closeModal();
    });

    function updateDeckCount(){ document.getElementById('deck-count').textContent = dummyDeck.length; }
    function updateDiscard(){
      if(discardPile.length===0){
        discardOutput.textContent = 'Discard pile is empty.';
        return;
      }
      const syms = discardPile.map(c => {
        const color = c.split(' ')[0];
        return colorSymbol[color] || c;
      });
      discardOutput.textContent = `Discard (${discardPile.length}): ${syms.join(' ')}`;
    }

    // Init
    window.addEventListener('load', ()=>{
      buildRepRows();
      document.getElementById('card-red').textContent = cardCounts.Red;
      document.getElementById('card-blue').textContent = cardCounts.Blue;
      document.getElementById('card-green').textContent = cardCounts.Green;
      document.getElementById('card-white').textContent = cardCounts.White;
      initializeDeck();
      const midCells = repWrap.querySelectorAll('.rep-row')[1]?.querySelectorAll('.rep-cell');
      if(midCells && midCells[1]) midCells[1].click();
    });

    // expose for buttons
    window.changeCrystal = changeCrystal;
    window.changeCard = changeCard;
    window.resetDeck = resetDeck;
    window.onDrawClick = onDrawClick;
    window.drawDummyCards = onDrawClick;
  </script>
</body>
</html>
