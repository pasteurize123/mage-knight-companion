<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mage Knight Companion ‚Äî Phone (Reputation scroll)</title>
  <style>
    :root{
      --bg:#071226;
      --card:#0b1220;
      --muted:#9aa4b2;
      --accent:#c7924f;
      --glass: rgba(255,255,255,0.03);
      --radius:14px;
      --phone-width:380px;
      --red:#d9534f;
      --blue:#4aa3e0;
      --green:#6ac38a;
      --white:#f0f4f8;
      --yellow:#f6d365;
      --gold:#c7924f;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:linear-gradient(180deg,#071028 0%,#061226 100%);color:#e6eef6;-webkit-font-smoothing:antialiased}
    .shell{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}
    .frame{width:var(--phone-width);max-width:94vw;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.02));border-radius:18px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,0.6);display:flex;flex-direction:column;gap:10px}
    header{position:fixed;left:50%;transform:translateX(-50%);top:12px;width:var(--phone-width);max-width:94vw;text-align:center;pointer-events:none}
    header h1{margin:0;font-size:13px;color:var(--muted);pointer-events:auto}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.015));border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.03)}
    .card-title{font-size:15px;margin:0;color:#fff;font-weight:700}
    .card-sub{font-size:12px;color:var(--muted);margin-top:6px}
    .row{display:flex;gap:8px;align-items:center}
    .muted{color:var(--muted);font-size:13px}
    .stat-large{font-weight:800;font-size:22px;color:var(--accent)}
    .btn{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.01);color:#eaf2ff;cursor:pointer;font-size:14px}
    .btn.primary{background:linear-gradient(180deg,rgba(199,146,79,0.12),rgba(199,146,79,0.06));border:1px solid rgba(199,146,79,0.18);color:#ffdcb3;font-weight:600}
    input[type="number"]{width:110px;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.01);color:#eaf2ff;font-size:16px;text-align:center;-moz-appearance:textfield}
    .level-badge{position:relative;min-width:160px;padding:8px 10px;border-radius:10px;background:rgba(255,255,255,0.02);color:var(--muted);text-align:center;font-weight:700;border:1px solid rgba(255,255,255,0.04);cursor:pointer}
    .level-badge.level-1{color:#e6eef6;background:rgba(0,0,0,0.12)}
    .level-tooltip{position:absolute;top:-6px;left:50%;transform:translate(-50%,-100%);min-width:220px;max-width:320px;background:linear-gradient(180deg,rgba(10,10,10,0.95),rgba(20,20,20,0.95));color:#fff;border-radius:10px;padding:10px;border:1px solid rgba(255,255,255,0.06);box-shadow:0 10px 30px rgba(0,0,0,0.6);z-index:50;font-size:13px;display:none}
    .level-tooltip.visible{display:block}
    .tooltip-list{display:flex;flex-direction:column;gap:6px;max-height:220px;overflow:auto;padding-right:6px}
    .tooltip-item{display:flex;gap:8px;align-items:center;padding:6px 8px;border-radius:6px;background:rgba(255,255,255,0.02);color:var(--muted);font-weight:600;justify-content:space-between;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .tooltip-item .lvl{color:#eaf2ff;font-weight:800;min-width:86px;text-align:left;flex:0 0 auto}
    .tooltip-item .reward{color:var(--muted);font-weight:600;text-align:right;margin-left:8px;flex:1 1 auto;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}

    /* Reputation: horizontal scrolling track like earlier versions */
    .rep-wrap { display:flex; flex-direction:column; gap:8px; }
    .rep-controls { display:flex; justify-content:flex-end; gap:8px; }
    .rep-track { display:flex; gap:8px; align-items:center; overflow-x:auto; overflow-y:hidden; padding:8px; border-radius:10px; background:rgba(255,255,255,0.01); -webkit-overflow-scrolling: touch; scroll-behavior: smooth; }
    .rep-track::-webkit-scrollbar { height:8px; }
    .rep-track::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); border-radius:10px; }
    .rep-step{flex:0 0 auto; min-width:48px;padding:8px;border-radius:10px;background:rgba(255,255,255,0.02);text-align:center;border:1px solid rgba(255,255,255,0.02);color:var(--muted);font-size:13px;cursor:pointer;height:40px;display:flex;align-items:center;justify-content:center}
    .rep-step.zero{background:rgba(246,211,101,0.08);color:var(--yellow);border:1px solid rgba(246,211,101,0.18)}
    .rep-step.positive{background:rgba(199,146,79,0.08);color:var(--gold);border:1px solid rgba(199,146,79,0.18)}
    .rep-step.negative{background:rgba(217,83,79,0.08);color:var(--red);border:1px solid rgba(217,83,79,0.18)}
    .rep-step.active{box-shadow:0 8px 20px rgba(0,0,0,0.5);transform:scale(1.05);font-weight:800}

    /* Dummy */
    .counters{display:flex;gap:8px;align-items:center;margin-top:6px}
    .counter{display:flex;flex-direction:column;align-items:center;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);min-width:64px}
    .counter .label{color:var(--muted);font-size:12px}
    .counter .value{font-weight:800;font-size:16px}
    .crystals{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .crystal{min-width:48px;padding:6px;border-radius:8px;text-align:center;font-weight:700;color:#061226}
    .crystal.red{background:var(--red);color:#fff}
    .crystal.blue{background:var(--blue);color:#021a2b}
    .crystal.green{background:var(--green);color:#052216}
    .crystal.white{background:var(--white);color:#021218}
    .deck-composition{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .deck-piece{display:flex;flex-direction:column;align-items:center;min-width:64px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.01)}
    textarea{width:100%;min-height:72px;margin-top:8px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.03);color:#eaf2ff}
    @media (max-width:420px){:root{--phone-width:94vw}}
  </style>
</head>
<body>
  <div class="shell">
    <div class="frame" role="application" aria-label="Mage Knight Companion">
      <header><h1>Mage Knight Companion</h1></header>

      <!-- Reputation (phone-friendly horizontal scroll) -->
      <section class="card" aria-labelledby="rep-title">
        <div class="card-title" id="rep-title">Reputation</div>
        <div class="card-sub">Quick reputation track ‚Äî swipe left/right to view</div>
        <div style="height:8px"></div>

        <div class="rep-wrap">
          <div class="rep-controls">
            <button id="rep-down" class="btn" aria-label="Decrease reputation">üëé</button>
            <button id="rep-up" class="btn primary" aria-label="Increase reputation">üëç</button>
          </div>

          <div style="display:flex;align-items:center;justify-content:space-between">
            <div style="text-align:left">
              <div class="muted">Current</div>
              <div id="reputation-value" class="stat-large">‚Äî</div>
            </div>
            <div style="width:8px"></div>
            <div style="flex:1">
              <div class="rep-track" id="rep-track" role="list" aria-label="Reputation track"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Fame (unchanged behaviour: commit on Enter/blur) -->
      <section class="card" aria-labelledby="fame-title">
        <div class="card-title" id="fame-title">Fame</div>
        <div class="card-sub">Click to edit; press Enter or click away to confirm</div>
        <div style="height:8px"></div>
        <div style="display:flex;gap:8px;align-items:center;position:relative">
          <input id="fame-input" type="number" min="0" step="1" value="0" aria-label="Fame value" />
          <div id="player-level" class="level-badge level-1" role="button" aria-pressed="false" tabindex="0">Player Level 1</div>
          <div id="level-tooltip" class="level-tooltip" role="dialog" aria-hidden="true">
            <div style="font-weight:800;margin-bottom:6px">Level rewards</div>
            <div class="tooltip-list" id="tooltip-list"></div>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="muted">Notes</div>
        <textarea id="volkare-text">General Volkare: Track story events or reminders here.</textarea>
      </section>

      <!-- Dummy Player (unchanged) -->
      <section class="card" aria-labelledby="dummy-title">
        <div class="card-title" id="dummy-title">Dummy Player</div>
        <div class="card-sub">Deck, crystals, draw & discard</div>

        <div style="height:8px"></div>
        <div style="display:flex;gap:12px;align-items:center">
          <div style="flex:1">
            <div class="muted">Name</div>
            <div id="dummy-name" class="stat-large">Dummy</div>
          </div>
          <div class="counter"><div class="label">Hand</div><div id="dummy-hand" class="value">0</div></div>
          <div class="counter"><div class="label">Discard</div><div id="dummy-discard" class="value">0</div></div>
          <div class="counter"><div class="label">Deck</div><div id="dummy-deck-count" class="value">16</div></div>
        </div>

        <div style="height:10px"></div>
        <div style="display:flex;gap:8px">
          <button id="draw-btn" class="btn primary">Draw 1</button>
          <button id="discard-btn" class="btn">Discard 1</button>
          <button id="shuffle-btn" class="btn">Shuffle</button>
          <button id="reset-deck" class="btn">Reset</button>
        </div>

        <div style="height:10px"></div>
        <div class="muted">Crystals (inventory)</div>
        <div class="crystals" id="crystal-list"></div>

        <div style="height:8px"></div>
        <div class="muted">Deck composition (remaining)</div>
        <div class="deck-composition" id="deck-composition"></div>

        <div style="height:8px"></div>
        <div class="muted">Dummy notes</div>
        <textarea id="dummy-notes"></textarea>
      </section>

      <footer style="text-align:center;color:var(--muted);font-size:12px;padding-top:6px">Phone layout ‚Ä¢ Swipe to scroll the reputation track</footer>
    </div>
  </div>

  <script>
    (function(){
      // Config (unchanged reputation/fame logic)
      const STORAGE_KEY = 'mk_mk_companion_phone_v2';
      const REP_TRACK = ["X","-5","-3","-2","-1","-1","0","0","0","+1","+1","+2","+2","+3","+5"];
      const DEFAULT_REP_INDEX = 7;
      const LEVEL_RANGES = [
        {level:1,min:0,max:2},{level:2,min:3,max:7},{level:3,min:8,max:14},
        {level:4,min:15,max:23},{level:5,min:24,max:34},{level:6,min:35,max:47},
        {level:7,min:48,max:62},{level:8,min:63,max:79},{level:9,min:80,max:98},
        {level:10,min:99,max:119}
      ];
      const LEVEL_REWARDS = {
        1:'Command Token',2:'Skill + Advanced Action',3:'Command Token',4:'Skill + Advanced Action',
        5:'Command Token',6:'Skill + Advanced Action',7:'Command Token',8:'Skill + Advanced Action',
        9:'Command Token',10:'Skill + Advanced Action'
      };

      // Dummy deck config
      const COLORS = ['red','blue','green','white'];
      const PER_COLOR = 4;

      // Utilities
      function clamp(n,min=0,max=999){return Math.max(min,Math.min(max,n))}
      function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}}

      function buildInitialDeck(){
        const d=[];
        COLORS.forEach(c=>{for(let i=0;i<PER_COLOR;i++)d.push(c)});
        shuffle(d);
        return d;
      }
      function initialCrystals(){
        const first = COLORS[Math.floor(Math.random()*COLORS.length)];
        let second = first;
        while(second===first) second = COLORS[Math.floor(Math.random()*COLORS.length)];
        const c={};COLORS.forEach(col=>c[col]=0); c[first]=2; c[second]=1; return c;
      }
      function getLevelForFame(fame){
        const f = Math.max(0,Math.floor(Number(fame)||0));
        for(const r of LEVEL_RANGES) if(f>=r.min && f<=r.max) return r.level;
        return LEVEL_RANGES[LEVEL_RANGES.length-1].level;
      }

      // State (keep fame/rep behaviour unchanged)
      const state = {
        repIndex: DEFAULT_REP_INDEX,
        fame: 0,
        previousLevel: 1,
        // dummy
        deck: buildInitialDeck(),
        discard: [],
        hand: [],
        crystals: initialCrystals(),
        volkareNotes: 'General Volkare: Track story events or reminders here.',
        dummyNotes: ''
      };
      let editing = false;
      let tempFame = null;

      // Elements
      const els = {
        reputationValue: document.getElementById('reputation-value'),
        repTrack: document.getElementById('rep-track'),
        repUp: document.getElementById('rep-up'),
        repDown: document.getElementById('rep-down'),
        fameInput: document.getElementById('fame-input'),
        playerLevel: document.getElementById('player-level'),
        tooltip: document.getElementById('level-tooltip'),
        tooltipList: document.getElementById('tooltip-list'),
        volkareText: document.getElementById('volkare-text'),
        // dummy
        dummyName: document.getElementById('dummy-name'),
        dummyHand: document.getElementById('dummy-hand'),
        dummyDiscard: document.getElementById('dummy-discard'),
        dummyDeckCount: document.getElementById('dummy-deck-count'),
        drawBtn: document.getElementById('draw-btn'),
        discardBtn: document.getElementById('discard-btn'),
        shuffleBtn: document.getElementById('shuffle-btn'),
        resetDeckBtn: document.getElementById('reset-deck'),
        crystalList: document.getElementById('crystal-list'),
        deckComposition: document.getElementById('deck-composition'),
        dummyNotes: document.getElementById('dummy-notes')
      };

      // Persistence
      function save(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){} }
      function load(){ try{ const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return; const p = JSON.parse(raw); Object.assign(state, p); }catch(e){} }

      // Reputation UI (horizontal scroll)
      function classify(lbl){ if(lbl==='0') return 'zero'; if(lbl==='X' || lbl.startsWith('-')) return 'negative'; if(lbl.startsWith('+')) return 'positive'; return '' }
      function colorForLabel(lbl){ if(lbl==='0') return getComputedStyle(document.documentElement).getPropertyValue('--yellow').trim(); if(lbl==='X' || lbl.startsWith('-')) return getComputedStyle(document.documentElement).getPropertyValue('--red').trim(); if(lbl.startsWith('+')) return getComputedStyle(document.documentElement).getPropertyValue('--gold').trim(); return getComputedStyle(document.documentElement).getPropertyValue('--muted').trim() }
      function buildRepTrack(){
        els.repTrack.innerHTML = '';
        REP_TRACK.forEach((lbl,i)=>{
          const b = document.createElement('button');
          b.type='button';
          b.className='rep-step '+classify(lbl);
          b.setAttribute('role','listitem');
          b.setAttribute('aria-label','Reputation '+lbl);
          b.textContent=lbl;
          b.addEventListener('click',()=>{
            state.repIndex = i;
            renderReputation();
            save();
            // scroll active into center
            setTimeout(()=>{ try{ b.scrollIntoView({inline:'center',behavior:'smooth',block:'nearest'}); }catch(e){} }, 80);
          });
          els.repTrack.appendChild(b);
        });
      }
      function renderReputation(){
        const lbl = REP_TRACK[state.repIndex];
        els.reputationValue.textContent = lbl;
        els.reputationValue.style.color = colorForLabel(lbl);
        const steps = els.repTrack.querySelectorAll('.rep-step');
        steps.forEach((s,i)=>s.classList.toggle('active', i===state.repIndex));
        const active = steps[state.repIndex];
        if(active){
          try{ active.scrollIntoView({inline:'center',behavior:'smooth',block:'nearest'}); }catch(e){}
        }
      }

      // Fame & level
      function renderFameAndLevel(){
        els.fameInput.value = editing && tempFame!==null ? tempFame : String(state.fame||0);
        const lvl = state.previousLevel;
        els.playerLevel.textContent = 'Player Level '+lvl;
        els.playerLevel.className = 'level-badge level-'+Math.max(1,Math.min(10,lvl));
      }
      function createTooltipItem(l,txt){
        const it=document.createElement('div'); it.className='tooltip-item';
        const a=document.createElement('div'); a.className='lvl'; a.textContent='Level '+l+':';
        const b=document.createElement('div'); b.className='reward'; b.textContent=txt;
        it.appendChild(a); it.appendChild(b); return it;
      }
      function buildFullTooltip(level){ els.tooltipList.innerHTML=''; for(let i=1;i<=level;i++) els.tooltipList.appendChild(createTooltipItem(i, LEVEL_REWARDS[i]||'‚Äî')); }
      function showGained(prev,newL){ els.tooltipList.innerHTML=''; for(let l=prev+1;l<=newL;l++) els.tooltipList.appendChild(createTooltipItem(l, LEVEL_REWARDS[l]||'‚Äî')); if(prev<newL){ els.tooltip.classList.add('visible'); els.tooltip.setAttribute('aria-hidden','false'); els.playerLevel.setAttribute('aria-pressed','true'); } }
      function closeTooltip(){ els.tooltip.classList.remove('visible'); els.tooltip.setAttribute('aria-hidden','true'); els.playerLevel.setAttribute('aria-pressed','false'); }
      function toggleTooltip(){ if(els.tooltip.classList.contains('visible')) closeTooltip(); else { buildFullTooltip(state.previousLevel); els.tooltip.classList.add('visible'); els.tooltip.setAttribute('aria-hidden','false'); els.playerLevel.setAttribute('aria-pressed','true'); } }

      // Fame input behaviour
      function startEditFame(){ editing=true; tempFame=String(state.fame||0); els.fameInput.classList.add('editing'); setTimeout(()=>{ try{ els.fameInput.select(); }catch(e){} },0) }
      function cancelEditFame(){ editing=false; tempFame=null; els.fameInput.classList.remove('editing'); renderFameAndLevel() }
      function commitEditFame(){ if(!editing) return; const raw = tempFame==='' ? '0' : (tempFame||'0'); const parsed = Math.max(0, Math.floor(Number(raw)||0)); const prev = state.previousLevel; const newL = getLevelForFame(parsed); state.fame = parsed; state.previousLevel = newL; if(newL>prev) showGained(prev,newL); editing=false; tempFame=null; els.fameInput.classList.remove('editing'); save(); renderFameAndLevel(); }

      // Dummy renderers & ops
      function renderDeckComposition(){ const counts = COLORS.reduce((a,c)=>{a[c]=0;return a},{});
        state.deck.forEach(c=>counts[c]=(counts[c]||0)+1);
        els.deckComposition.innerHTML=''; COLORS.forEach(c=>{ const p=document.createElement('div'); p.className='deck-piece'; const dot=document.createElement('div'); dot.style.width='14px';dot.style.height='14px';dot.style.borderRadius='50%';dot.style.marginBottom='6px'; dot.style.background = c==='red'? 'var(--red)' : c==='blue'? 'var(--blue)' : c==='green'? 'var(--green)' : 'var(--white)'; const lbl=document.createElement('div'); lbl.style.fontSize='12px'; lbl.style.color='var(--muted)'; lbl.textContent=c.charAt(0).toUpperCase()+c.slice(1); const n=document.createElement('div'); n.style.fontWeight='800'; n.style.marginTop='6px'; n.textContent=counts[c]||0; p.appendChild(dot); p.appendChild(lbl); p.appendChild(n); els.deckComposition.appendChild(p); }); }
      function renderCrystals(){ els.crystalList.innerHTML=''; COLORS.forEach(c=>{ const q=state.crystals[c]||0; const n=document.createElement('div'); n.className='crystal '+c; n.innerHTML=`<div style="font-size:12px;opacity:0.9">${q}√ó</div><div style="font-size:12px">${c.charAt(0).toUpperCase()+c.slice(1)}</div>`; els.crystalList.appendChild(n); }); }
      function renderDummyCounts(){ els.dummyHand.textContent=String(state.hand.length); els.dummyDiscard.textContent=String(state.discard.length); els.dummyDeckCount.textContent=String(state.deck.length) }

      function drawOne(){ if(state.deck.length===0 && state.discard.length>0){ state.deck = state.discard.slice(); state.discard = []; shuffle(state.deck); } if(state.deck.length===0) return; const c=state.deck.pop(); state.hand.push(c); save(); renderAll(); }
      function discardOne(){ if(state.hand.length===0) return; const c=state.hand.pop(); state.discard.push(c); save(); renderAll(); }
      function shuffleDeck(){ shuffle(state.deck); save(); renderAll(); }
      function resetDeck(){ state.deck = buildInitialDeck(); state.discard=[]; state.hand=[]; state.crystals = initialCrystals(); state.dummyNotes=''; save(); renderAll(); }

      // Master render
      function renderAll(){ renderReputation(); renderFameAndLevel(); els.volkareText.value = state.volkareNotes||''; els.dummyNotes.value = state.dummyNotes||''; renderDeckComposition(); renderCrystals(); renderDummyCounts() }

      // Wiring events
      els.repUp.addEventListener('click', ()=>{ state.repIndex = clamp(state.repIndex+1,0,REP_TRACK.length-1); renderReputation(); save(); });
      els.repDown.addEventListener('click', ()=>{ state.repIndex = clamp(state.repIndex-1,0,REP_TRACK.length-1); renderReputation(); save(); });

      buildRepTrack();

      // Fame input interactions
      els.fameInput.addEventListener('focus', ()=> startEditFame());
      els.fameInput.addEventListener('mouseup', (e)=>{ e.preventDefault(); try{ els.fameInput.select(); }catch(e){} });
      els.fameInput.addEventListener('touchstart', ()=> setTimeout(()=>{ try{ els.fameInput.select(); }catch(e){} },0), {passive:true});
      els.fameInput.addEventListener('input', (e)=>{ const raw = e.target.value; if(raw===''){ tempFame=''; return } const parsed = Number.isFinite(Number(raw))? Math.max(0, Math.floor(Number(raw)||0)) : 0; tempFame = String(parsed); e.target.value = tempFame; });
      els.fameInput.addEventListener('blur', ()=> commitEditFame());
      els.fameInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); commitEditFame(); els.fameInput.blur(); } else if(e.key==='Escape'){ e.preventDefault(); cancelEditFame(); els.fameInput.blur(); } });

      els.playerLevel.addEventListener('click', (e)=>{ e.stopPropagation(); toggleTooltip(); });
      els.playerLevel.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggleTooltip(); } });

      document.addEventListener('click', (e)=>{ const inside = e.target===els.playerLevel || els.playerLevel.contains(e.target) || els.tooltip.contains(e.target) || e.target===els.fameInput; if(!inside) closeTooltip(); });

      els.volkareText.addEventListener('input', (e)=>{ state.volkareNotes = e.target.value; save(); });

      // Dummy wiring
      els.drawBtn.addEventListener('click', ()=> drawOne());
      els.discardBtn.addEventListener('click', ()=> discardOne());
      els.shuffleBtn.addEventListener('click', ()=> shuffleDeck());
      els.resetDeckBtn.addEventListener('click', ()=> resetDeck());
      els.dummyNotes.addEventListener('input', (e)=>{ state.dummyNotes = e.target.value; save(); });

      // Init
      load();
      if(!Array.isArray(state.deck) || state.deck.length===0) state.deck = buildInitialDeck();
      if(!state.crystals || typeof state.crystals !== 'object') state.crystals = initialCrystals();
      if(typeof state.repIndex !== 'number') state.repIndex = DEFAULT_REP_INDEX;
      if(typeof state.fame !== 'number') state.fame = 0;
      if(typeof state.previousLevel !== 'number') state.previousLevel = getLevelForFame(state.fame||0);
      renderAll();

      // autosave
      setInterval(save,2000);

      // debugging
      window.__mk_state = state;

      // Helper functions used earlier in closures
      function buildInitialDeck(){ const d=[]; COLORS.forEach(c=>{ for(let i=0;i<PER_COLOR;i++) d.push(c); }); shuffle(d); return d; }
      function initialCrystals(){ const first = COLORS[Math.floor(Math.random()*COLORS.length)]; let second = first; while(second===first) second = COLORS[Math.floor(Math.random()*COLORS.length)]; const c={}; COLORS.forEach(col=>c[col]=0); c[first]=2; c[second]=1; return c; }
      function getLevelForFame(fame){ const f = Math.max(0,Math.floor(Number(fame)||0)); for(const r of LEVEL_RANGES) if(f>=r.min && f<=r.max) return r.level; return LEVEL_RANGES[LEVEL_RANGES.length-1].level; }

    })();
  </script>
</body>
</html>
