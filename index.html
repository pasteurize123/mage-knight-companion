<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mage Knight Companion â€” Dummy Player</title>
  <style>
    :root{
      --bg:#f4f4f4;
      --panel-bg:#ececec;
      --box-bg:#ffffff;
      --cell:#e8e8e8;
      --rep-min:44px;
      --overlay-bg: rgba(0,0,0,0.45);
      --gold: #ffd700;
      --yellow: #ffeb99;
      --red: #ff6b6b;
    }
    *{box-sizing:border-box}
    html, body { margin:0; padding:0; height:100%; }
    body{
      background:var(--bg);
      color:#111;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      font-size:14px;
      padding:12px;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    h1{font-size:18px;margin:0 0 12px;text-align:center}
    h2,h3{font-size:16px;margin:0}
    h3{font-weight:400;color:inherit}
    .container{display:flex;flex-direction:column;gap:12px;max-width:900px;margin:0 auto}
    .boxed { background:var(--panel-bg); border-radius:10px; padding:10px; }
    .box-inner { background:var(--box-bg); border-radius:8px; padding:10px; display:flex; flex-direction:column; gap:10px; }

    /* Reputation track */
    .rep-wrap{display:flex;flex-direction:column;gap:8px;width:100%;align-items:center}
    .rep-row{display:flex;gap:8px;align-items:center;justify-content:center}
    .rep-row .rep-cell{flex:0 0 auto;min-width:var(--rep-min);padding:6px 10px;background:var(--cell);border-radius:6px;text-align:center;cursor:pointer;font-size:14px;user-select:none}
    .rep-row.top .rep-cell.selected{background:var(--gold);color:#111;font-weight:700}
    .rep-row.mid .rep-cell.selected{background:var(--yellow);color:#111;font-weight:700}
    .rep-row.bot .rep-cell.selected{background:var(--red);color:#fff;font-weight:700}

    .fame-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .fame-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type=number], select, button { font-size:14px; }
    input[type=number]{width:120px;padding:8px;border-radius:6px;border:1px solid #ccc}
    .fame-result{font-weight:400;font-size:14px;padding:6px 8px;background:#fff;border-radius:6px}
    .fame-result strong{font-weight:700}
    .fame-btn{padding:6px 10px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer;font-size:14px}

    .combined-grid{display:flex;flex-direction:column;gap:8px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .cols{display:flex;gap:8px;align-items:flex-start;flex-wrap:wrap}
    .col{background:var(--box-bg);border-radius:8px;padding:8px;min-width:160px;flex:1}
    .smallbtn{font-size:14px;padding:6px 8px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer}
    .output{background:#fff;padding:8px;border-radius:6px;min-height:36px;font-size:14px;overflow:hidden}
    .stat{font-weight:700;font-size:14px;line-height:1;min-width:20px;display:inline-block;text-align:center}
    .inline-item{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:8px}

    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:var(--overlay-bg);z-index:50}
    .modal{background:#fff;border-radius:10px;padding:16px;max-width:480px;width:94%;box-shadow:0 8px 30px rgba(0,0,0,0.25)}
    .modal h3{margin:0 0 8px 0;font-size:16px}
    .modal p{margin:8px 0;font-size:14px}
    .choice-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .choice-btn{padding:8px 10px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer;font-size:14px}
    .choice-btn.selected{background:#eef6e9;border-color:#9fd49f}
    .modal-foot{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    @media (max-width:820px){ .cols{flex-direction:column} .col{min-width:0} }
    @media (max-width:420px){
      :root{--rep-min:32px}
      input[type=number]{width:90px;padding:6px}
      .rep-cell{font-size:13px;padding:5px 6px}
      .smallbtn{font-size:13px;padding:5px 6px}
      .stat{font-size:13px}
      h1{font-size:16px}
      h2,h3{font-size:15px}
    }
  </style>
</head>
<body>
  <h1>Mage Knight Companion</h1>

  <div class="container">

    <section class="boxed" aria-labelledby="rep-section">
      <div class="box-inner">
        <h2 id="rep-section">Reputation Track</h2>
        <div class="rep-wrap" id="rep-wrap" aria-label="Reputation three rows"></div>
      </div>
    </section>

    <section class="boxed" aria-labelledby="fame-section">
      <div class="box-inner">
        <h2 id="fame-section">Fame Track</h2>
        <div class="fame-row" role="group" aria-label="Fame input">
          <div class="fame-controls" style="flex:1;align-items:center">
            <h3 style="margin:0 8px 0 0">Fame</h3>
            <input id="fame-input" type="number" min="0" max="119" value="0" aria-label="Fame value" />
            <div class="fame-result" id="fame-result" aria-live="polite">Level: <strong id="fame-level">1</strong></div>
          </div>

          <div style="display:flex;align-items:center;gap:8px">
            <button class="fame-btn" data-inc="1">+1</button>
            <button class="fame-btn" data-inc="2">+2</button>
            <button class="fame-btn" data-inc="3">+3</button>
            <button class="fame-btn" data-inc="5">+5</button>
            <button class="fame-btn" data-inc="10">+10</button>
          </div>
        </div>
      </div>
    </section>

    <section class="boxed" aria-labelledby="combined-section">
      <div class="box-inner">
        <h2 id="combined-section">Dummy Player</h2>
        <div class="combined-grid">
          <div class="cols">
            <div class="col" aria-labelledby="crystal-title">
              <h3 id="crystal-title">Crystals</h3>
              <div class="inline-item">
                <div style="font-size:18px">ðŸ”´ <span class="stat" id="red">0</span></div>
                <div><button class="smallbtn" onclick="changeCrystal('red',1)">+</button><button class="smallbtn" onclick="changeCrystal('red',-1)">âˆ’</button></div>
                <div style="width:12px"></div>
                <div style="font-size:18px">ðŸ”µ <span class="stat" id="blue">0</span></div>
                <div><button class="smallbtn" onclick="changeCrystal('blue',1)">+</button><button class="smallbtn" onclick="changeCrystal('blue',-1)">âˆ’</button></div>
              </div>

              <div class="inline-item">
                <div style="font-size:18px">ðŸŸ¢ <span class="stat" id="green">0</span></div>
                <div><button class="smallbtn" onclick="changeCrystal('green',1)">+</button><button class="smallbtn" onclick="changeCrystal('green',-1)">âˆ’</button></div>
                <div style="width:12px"></div>
                <div style="font-size:18px">âšª <span class="stat" id="white">0</span></div>
                <div><button class="smallbtn" onclick="changeCrystal('white',1)">+</button><button class="smallbtn" onclick="changeCrystal('white',-1)">âˆ’</button></div>
              </div>
            </div>

            <div class="col" aria-labelledby="cards-title">
              <h3 id="cards-title">Cards</h3>
              <div class="inline-item">
                <div style="font-size:18px">ðŸ”´ <span class="stat" id="card-red">4</span></div>
                <div><button class="smallbtn" onclick="changeCard('Red',1)">+</button><button class="smallbtn" onclick="changeCard('Red',-1)">âˆ’</button></div>
                <div style="width:12px"></div>
                <div style="font-size:18px">ðŸ”µ <span class="stat" id="card-blue">4</span></div>
                <div><button class="smallbtn" onclick="changeCard('Blue',1)">+</button><button class="smallbtn" onclick="changeCard('Blue',-1)">âˆ’</button></div>
              </div>

              <div class="inline-item">
                <div style="font-size:18px">ðŸŸ¢ <span class="stat" id="card-green">4</span></div>
                <div><button class="smallbtn" onclick="changeCard('Green',1)">+</button><button class="smallbtn" onclick="changeCard('Green',-1)">âˆ’</button></div>
                <div style="width:12px"></div>
                <div style="font-size:18px">âšª <span class="stat" id="card-white">4</span></div>
                <div><button class="smallbtn" onclick="changeCard('White',1)">+</button><button class="smallbtn" onclick="changeCard('White',-1)">âˆ’</button></div>
              </div>
            </div>

            <div class="col">
              <div style="margin-top:8px;font-size:14px">Cards in deck: <strong id="deck-count" class="stat">0</strong></div>
            </div>
          </div>

          <div class="row" style="margin-top:6px;align-items:center">
            <button id="draw-btn" class="smallbtn" onclick="onDrawClick()">Draw</button>
            <div id="dummy-output" class="output" style="flex:1;margin-left:8px">Drawn symbols will appear here.</div>
          </div>

          <div style="margin-top:6px">
            <div id="discard-output" class="output">Discard pile is empty.</div>
            <div style="margin-top:8px;display:flex;justify-content:center">
              <button class="smallbtn" onclick="resetDeck()">Reset Deck</button>
            </div>
          </div>
        </div>
      </div>
    </section>

  </div>

  <!-- Single-level-up modal that shows all relevant prompts together -->
  <div id="level-modal" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="level-title">
      <h3 id="level-title">Level Up</h3>
      <div id="level-message" style="white-space:pre-wrap;font-size:14px;margin-top:8px"></div>
      <div class="modal-foot">
        <button id="level-ok" class="smallbtn">OK</button>
      </div>
    </div>
  </div>

  <!-- End round choices modal -->
  <div id="overlay-modal" class="overlay" role="dialog" aria-modal="true" aria-hidden="true" style="display:none">
    <div class="modal" role="document">
      <h3 id="modal-title">End Round â€” Choose Additions</h3>
      <div style="margin-bottom:6px">Choose one crystal to add to the dummy player</div>
      <div class="choice-row" id="crystal-choices">
        <button class="choice-btn" data-val="red">ðŸ”´</button>
        <button class="choice-btn" data-val="blue">ðŸ”µ</button>
        <button class="choice-btn" data-val="green">ðŸŸ¢</button>
        <button class="choice-btn" data-val="white">âšª</button>
      </div>
      <div style="margin-top:8px;margin-bottom:6px">Choose one card to add to the dummy player</div>
      <div class="choice-row" id="card-choices">
        <button class="choice-btn" data-val="Red">ðŸ”´</button>
        <button class="choice-btn" data-val="Blue">ðŸ”µ</button>
        <button class="choice-btn" data-val="Green">ðŸŸ¢</button>
        <button class="choice-btn" data-val="White">âšª</button>
      </div>
      <div class="modal-foot">
        <button class="smallbtn" id="modal-cancel">Cancel</button>
        <button class="smallbtn" id="modal-confirm" disabled>Confirm</button>
      </div>
    </div>
  </div>

  <script>
    let fame = 0;
    let crystals = { red: 0, blue: 0, green: 0, white: 0 };
    let cardCounts = { Red: 4, Blue: 4, Green: 4, White: 4 };
    let dummyDeck = [];
    let discardPile = [];
    let endRoundFlag = false;
    let lastShownLevel = 1;

    const repTop = ["0","+1","+1","+2","+2","+3","+5"];
    const repMid = ["0"];
    const repBot = ["0","-1","-1","-2","-3","-5","X"];

    const fameLevels = [
      {level:1, min:0,  max:2},
      {level:2, min:3,  max:7},
      {level:3, min:8,  max:14},
      {level:4, min:15, max:23},
      {level:5, min:24, max:34},
      {level:6, min:35, max:47},
      {level:7, min:48, max:62},
      {level:8, min:63, max:79},
      {level:9, min:80, max:98},
      {level:10,min:99, max:119}
    ];

    const levelPrompts = {
      2: "Draw skill and advanced action",
      3: "Flip level token to command token",
      4: "Draw skill and advanced action",
      5: "Flip level token to command token",
      6: "Draw skill and advanced action",
      7: "Flip level token to command token",
      8: "Draw skill and advanced action",
      9: "Flip level token to command token",
      10: "Draw skill and advanced action"
    };

    const colorSymbol = {
      Red: 'ðŸ”´', Blue: 'ðŸ”µ', Green: 'ðŸŸ¢', White: 'âšª',
      red: 'ðŸ”´', blue: 'ðŸ”µ', green: 'ðŸŸ¢', white: 'âšª'
    };

    const repWrap = document.getElementById('rep-wrap');
    const fameInput = document.getElementById('fame-input');
    const fameResult = document.getElementById('fame-result');
    const fameLevelEl = document.getElementById('fame-level');
    const fameButtons = document.querySelectorAll('.fame-btn');

    const dummyOutput = document.getElementById('dummy-output');
    const discardOutput = document.getElementById('discard-output');
    const drawBtn = document.getElementById('draw-btn');

    const levelModal = document.getElementById('level-modal');
    const levelMessage = document.getElementById('level-message');
    const levelOk = document.getElementById('level-ok');

    const overlayModal = document.getElementById('overlay-modal');
    const crystalChoices = document.getElementById('crystal-choices');
    const cardChoices = document.getElementById('card-choices');
    const modalConfirm = document.getElementById('modal-confirm');
    const modalCancel = document.getElementById('modal-cancel');

    let selectedCrystal = null;
    let selectedCardColor = null;

    function buildRepRows() {
      repWrap.innerHTML = '';
      const topRow = document.createElement('div'); topRow.className = 'rep-row top';
      repTop.forEach(label => {
        const el = document.createElement('div'); el.className = 'rep-cell'; el.textContent = label;
        el.addEventListener('click', () => selectRepCell(el));
        topRow.appendChild(el);
      });

      const midRow = document.createElement('div'); midRow.className = 'rep-row mid';
      repMid.forEach(label => {
        const el = document.createElement('div'); el.className = 'rep-cell'; el.textContent = label;
        el.addEventListener('click', () => selectRepCell(el));
        midRow.appendChild(el);
      });

      const botRow = document.createElement('div'); botRow.className = 'rep-row bot';
      repBot.forEach(label => {
        const el = document.createElement('div'); el.className = 'rep-cell'; el.textContent = label;
        el.addEventListener('click', () => selectRepCell(el));
        botRow.appendChild(el);
      });

      repWrap.appendChild(topRow);
      repWrap.appendChild(midRow);
      repWrap.appendChild(botRow);
    }

    function selectRepCell(cellEl) {
      const all = repWrap.querySelectorAll('.rep-cell');
      all.forEach(c => c.classList.remove('selected'));

      // mid row logic: left 0 -> bottom left, center 0 -> itself, right 0 -> top right
      const parentRow = cellEl.parentElement;
      if (parentRow.classList.contains('mid')) {
        const idx = Array.from(parentRow.children).indexOf(cellEl);
        if (idx === 0) {
          const botTarget = repWrap.querySelector('.rep-row.bot .rep-cell');
          if (botTarget) { botTarget.classList.add('selected'); return; }
        }
        if (idx === 1) { cellEl.classList.add('selected'); return; }
        if (idx === 2) {
          const topCells = repWrap.querySelectorAll('.rep-row.top .rep-cell');
          const topTarget = topCells[topCells.length - 1];
          if (topTarget) { topTarget.classList.add('selected'); return; }
        }
      }

      cellEl.classList.add('selected');
    }

    function getFameLevel(v) {
      const val = Math.max(0, Math.min(119, Math.floor(Number(v) || 0)));
      for (const b of fameLevels) if (val >= b.min && val <= b.max) return b.level;
      return 1;
    }

    // Show all relevant prompts in one modal when fame jumps multiple levels
    function handleLevelPrompts(prevLevel, newLevel) {
      const messages = [];
      for (let L = prevLevel + 1; L <= newLevel; L++) {
        if (levelPrompts[L]) messages.push(`Level ${L}: ${levelPrompts[L]}`);
      }
      if (messages.length === 0) return;
      levelMessage.textContent = messages.join('\n');
      levelModal.style.display = 'flex';
      levelModal.setAttribute('aria-hidden', 'false');
      lastShownLevel = Math.max(lastShownLevel, newLevel);
    }

    function hideLevelModal() {
      levelModal.style.display = 'none';
      levelModal.setAttribute('aria-hidden', 'true');
    }

    function updateFameUI() {
      const prevLevel = Number(fameLevelEl.textContent || 1);
      const level = getFameLevel(fame);
      fameLevelEl.textContent = level;
      fameResult.innerHTML = `Level: <strong id="fame-level">${level}</strong>`;
      fameInput.value = fame;
      if (level > prevLevel) handleLevelPrompts(prevLevel, level);
    }

    function setFame(v) {
      fame = Math.max(0, Math.min(119, Math.floor(Number(v) || 0)));
      updateFameUI();
    }

    fameInput.addEventListener('input', () => setFame(fameInput.value));
    fameButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const inc = parseInt(btn.dataset.inc || "0", 10);
        if (!isNaN(inc) && inc > 0) setFame(fame + inc);
      });
    });

    levelOk.addEventListener('click', () => hideLevelModal());

    // Crystals and card functions (unchanged)
    function changeCrystal(color, amount) {
      const key = color.toLowerCase();
      crystals[key] = Math.max(0, (crystals[key] || 0) + amount);
      document.getElementById(key).textContent = crystals[key];
    }

    function changeCard(color, amount) {
      cardCounts[color] = Math.max(0, (cardCounts[color] || 0) + amount);
      document.getElementById(`card-${color.toLowerCase()}`).textContent = cardCounts[color];
      if (amount > 0) {
        const cardName = `${color} Card`;
        const idx = Math.floor(Math.random() * (dummyDeck.length + 1));
        dummyDeck.splice(idx, 0, cardName);
      }
      if (amount < 0) {
        const cardName = `${color} Card`;
        const i = dummyDeck.findIndex(c => c === cardName);
        if (i !== -1) dummyDeck.splice(i, 1);
        else {
          const j = discardPile.findIndex(c => c === cardName);
          if (j !== -1) discardPile.splice(j, 1);
        }
      }
      updateDeckCount();
      updateDiscard();
    }

    function rebuildDeckFromCounts() {
      dummyDeck = [];
      Object.keys(cardCounts).forEach(color => {
        for (let i=0;i<cardCounts[color];i++) dummyDeck.push(`${color} Card`);
      });
      shuffle(dummyDeck);
      updateDeckCount();
    }

    function initializeDeck() {
      rebuildDeckFromCounts();
      discardPile = [];
      endRoundFlag = false;
      updateDrawButton();
      updateDiscard();
      dummyOutput.textContent = 'Deck initialized and shuffled.';
      setFame(0);
      lastShownLevel = 1;
      hideLevelModal();
    }
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

    function resetDeck(){ initializeDeck(); }
    function updateDrawButton(){ drawBtn.textContent = endRoundFlag ? 'End Round' : 'Draw'; }

    function onDrawClick(){
      if(endRoundFlag){ openEndRoundModal(); return; }
      const drawn = [];
      for(let i=0;i<3 && dummyDeck.length>0;i++) drawn.push(dummyDeck.pop());
      const last = drawn[drawn.length-1];
      if(last){
        const color = last.split(' ')[0].toLowerCase();
        const extra = crystals[color] || 0;
        for(let i=0;i<extra && dummyDeck.length>0;i++) drawn.push(dummyDeck.pop());
      }
      if(drawn.length === 0){
        endRoundFlag = true;
        updateDrawButton();
        dummyOutput.textContent = 'No cards drawn. End of round announced.';
        return;
      }
      discardPile.push(...drawn);
      const drawnSymbols = drawn.map(c => {
        const color = c.split(' ')[0];
        return colorSymbol[color] || c;
      });
      dummyOutput.textContent = drawnSymbols.join(' ');
      updateDeckCount();
      updateDiscard();
    }

    function openEndRoundModal(){
      selectedCrystal = null;
      selectedCardColor = null;
      modalConfirm.disabled = true;
      overlayModal.style.display = 'flex';
      overlayModal.setAttribute('aria-hidden', 'false');
      Array.from(crystalChoices.querySelectorAll('.choice-btn')).forEach(b => b.classList.remove('selected'));
      Array.from(cardChoices.querySelectorAll('.choice-btn')).forEach(b => b.classList.remove('selected'));
    }
    function closeModal(){ overlayModal.style.display = 'none'; overlayModal.setAttribute('aria-hidden', 'true'); }

    crystalChoices.addEventListener('click', (e) => {
      const btn = e.target.closest('.choice-btn');
      if(!btn) return;
      selectedCrystal = btn.dataset.val;
      Array.from(crystalChoices.querySelectorAll('.choice-btn')).forEach(b => b.classList.toggle('selected', b === btn));
      modalConfirm.disabled = !(selectedCrystal && selectedCardColor);
    });

    cardChoices.addEventListener('click', (e) => {
      const btn = e.target.closest('.choice-btn');
      if(!btn) return;
      selectedCardColor = btn.dataset.val;
      Array.from(cardChoices.querySelectorAll('.choice-btn')).forEach(b => b.classList.toggle('selected', b === btn));
      modalConfirm.disabled = !(selectedCrystal && selectedCardColor);
    });

    modalCancel.addEventListener('click', () => closeModal());

    modalConfirm.addEventListener('click', () => {
      if(!selectedCrystal || !selectedCardColor) return;
      changeCrystal(selectedCrystal, 1);
      changeCard(selectedCardColor, 1);
      if(discardPile.length > 0){
        dummyDeck.push(...discardPile);
        discardPile = [];
        shuffle(dummyDeck);
      }
      updateDeckCount();
      updateDiscard();
      dummyOutput.textContent = `End Round: added ${colorSymbol[selectedCardColor] || selectedCardColor} and ${colorSymbol[selectedCrystal] || selectedCrystal}. Deck reshuffled.`;
      endRoundFlag = false;
      updateDrawButton();
      closeModal();
    });

    function updateDeckCount(){ document.getElementById('deck-count').textContent = dummyDeck.length; }
    function updateDiscard(){
      if(discardPile.length===0){ discardOutput.textContent = 'Discard pile is empty.'; return; }
      const syms = discardPile.map(c => { const color = c.split(' ')[0]; return colorSymbol[color] || c; });
      discardOutput.textContent = `Discard (${discardPile.length}): ${syms.join(' ')}`;
    }

    window.addEventListener('load', ()=>{
      buildRepRows();
      // default select middle 0
      const midCell = repWrap.querySelector('.rep-row.mid .rep-cell');
      if (midCell) midCell.classList.add('selected');

      document.getElementById('card-red').textContent = cardCounts.Red;
      document.getElementById('card-blue').textContent = cardCounts.Blue;
      document.getElementById('card-green').textContent = cardCounts.Green;
      document.getElementById('card-white').textContent = cardCounts.White;
      initializeDeck();
    });

    // Expose functions for debugging if needed
    window.changeCrystal = changeCrystal;
    window.changeCard = changeCard;
    window.resetDeck = resetDeck;
    window.onDrawClick = onDrawClick;
    window.drawDummyCards = onDrawClick;
  </script>
</body>
</html>
