<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mage Knight Companion â€” Dummy Player</title>
  <style>
    :root{
      --bg:#f4f4f4;
      --panel-bg:#ececec;
      --box-bg:#ffffff;
      --cell:#e8e8e8;
      --sel-rep:#bfe7c7;
      --sel-fame:#ffdca3;
      --gap:10px;
      --rep-min:44px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      background:var(--bg);
      color:#111;
      padding:12px;
    }
    h1{font-size:18px;margin:0 0 12px;text-align:center}
    .container{display:flex;flex-direction:column;gap:12px;max-width:900px;margin:0 auto}

    /* boxed sections */
    .boxed {
      background:var(--panel-bg);
      border-radius:10px;
      padding:10px;
    }
    .box-inner {
      background:var(--box-bg);
      border-radius:8px;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    h2{font-size:14px;margin:0}

    /* Reputation 3 rows, centered inside box */
    .rep-wrap{display:flex;flex-direction:column;gap:8px;width:100%;align-items:center}
    .rep-row{display:flex;gap:8px;align-items:center;justify-content:center}
    .rep-row .rep-cell{flex:0 0 auto;min-width:var(--rep-min);padding:6px 10px;background:var(--cell);border-radius:6px;text-align:center;cursor:pointer;font-size:13px;user-select:none}
    .rep-cell.selected{background:var(--sel-rep);font-weight:700}

    /* Fame box */
    .fame-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type=number]{width:110px;padding:8px;border-radius:6px;border:1px solid #ccc;font-size:14px}
    .fame-result{font-weight:700;font-size:16px;padding:6px 8px;background:#fff;border-radius:6px}

    /* Combined controls area (Dummy Player) */
    .combined-grid{display:flex;flex-direction:column;gap:8px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .cols{display:flex;gap:8px;align-items:flex-start;flex-wrap:wrap}
    .col{background:var(--box-bg);border-radius:8px;padding:8px;min-width:160px;flex:1}
    .col h3{font-size:13px;margin:0 0 6px 0}
    .smallbtn{font-size:13px;padding:6px 8px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer}
    .output{background:#fff;padding:8px;border-radius:6px;min-height:36px;font-size:13px;overflow:hidden}
    .stat{font-weight:700}

    /* card count controls (same style as crystals) */
    .count-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:6px;font-size:14px}
    .count-btn{font-size:13px;padding:5px 8px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer}

    @media (max-width:820px){
      .cols{flex-direction:column}
      .col{min-width:0}
    }
    @media (max-width:420px){
      :root{--rep-min:32px}
      input[type=number]{width:88px;padding:6px}
      .fame-result{font-size:14px}
      .rep-cell{font-size:12px;padding:5px 6px}
      .smallbtn{font-size:12px;padding:5px 6px}
      .count-btn{font-size:12px;padding:4px 6px}
    }
  </style>
</head>
<body>
  <h1>Mage Knight Companion</h1>

  <div class="container">

    <!-- Reputation boxed section -->
    <section class="boxed" aria-labelledby="rep-section">
      <div class="box-inner">
        <h2 id="rep-section">Reputation Track</h2>

        <div class="rep-wrap" id="rep-wrap" aria-label="Reputation three rows">
          <!-- JS will insert three rows: positive / neutral / negative -->
        </div>

        <div style="text-align:center;font-size:13px">Selected: <strong id="rep-display">0</strong></div>
      </div>
    </section>

    <!-- Fame boxed section -->
    <section class="boxed" aria-labelledby="fame-section">
      <div class="box-inner">
        <h2 id="fame-section">Fame Track</h2>

        <div class="fame-row" role="group" aria-label="Fame input">
          <input id="fame-input" type="number" min="0" max="119" value="0" aria-label="Fame value" />
          <div class="fame-result" id="fame-result" aria-live="polite">Level 1</div>
          <div style="margin-left:auto;font-size:13px">Fame: <strong id="fame-display">0</strong></div>
        </div>
      </div>
    </section>

    <!-- Combined Dummy Player section (Crystals / Card counts / Deck / Draw / Discard) -->
    <section class="boxed" aria-labelledby="combined-section">
      <div class="box-inner">
        <h2 id="combined-section">Dummy Player</h2>

        <div class="combined-grid">
          <div class="cols">
            <!-- Crystals column -->
            <div class="col" aria-labelledby="crystal-title">
              <h3 id="crystal-title">Crystals</h3>
              <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
                <div>ðŸ”´ Red: <span class="stat" id="red">0</span></div>
                <div><button class="smallbtn" onclick="changeCrystal('red',1)">+ </button><button class="smallbtn" onclick="changeCrystal('red',-1)">âˆ’</button></div>
                <div style="width:8px"></div>
                <div>ðŸ”µ Blue: <span class="stat" id="blue">0</span></div>
                <div><button class="smallbtn" onclick="changeCrystal('blue',1)">+ </button><button class="smallbtn" onclick="changeCrystal('blue',-1)">âˆ’</button></div>
              </div>
              <div style="height:8px"></div>
              <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
                <div>ðŸŸ¢ Green: <span class="stat" id="green">0</span></div>
                <div><button class="smallbtn" onclick="changeCrystal('green',1)">+ </button><button class="smallbtn" onclick="changeCrystal('green',-1)">âˆ’</button></div>
                <div style="width:8px"></div>
                <div>âšª White: <span class="stat" id="white">0</span></div>
                <div><button class="smallbtn" onclick="changeCrystal('white',1)">+ </button><button class="smallbtn" onclick="changeCrystal('white',-1)">âˆ’</button></div>
              </div>
            </div>

            <!-- Card counts column (add/remove like crystals) -->
            <div class="col" aria-labelledby="cards-title">
              <h3 id="cards-title">Card Counts</h3>
              <div class="count-row">
                <div>ðŸ”´ Red Cards: <span class="stat" id="card-red">4</span></div>
                <div><button class="count-btn" onclick="changeCard('Red',1)">+ </button><button class="count-btn" onclick="changeCard('Red',-1)">âˆ’</button></div>
              </div>
              <div class="count-row">
                <div>ðŸ”µ Blue Cards: <span class="stat" id="card-blue">4</span></div>
                <div><button class="count-btn" onclick="changeCard('Blue',1)">+ </button><button class="count-btn" onclick="changeCard('Blue',-1)">âˆ’</button></div>
              </div>
              <div class="count-row">
                <div>ðŸŸ¢ Green Cards: <span class="stat" id="card-green">4</span></div>
                <div><button class="count-btn" onclick="changeCard('Green',1)">+ </button><button class="count-btn" onclick="changeCard('Green',-1)">âˆ’</button></div>
              </div>
              <div class="count-row">
                <div>âšª White Cards: <span class="stat" id="card-white">4</span></div>
                <div><button class="count-btn" onclick="changeCard('White',1)">+ </button><button class="count-btn" onclick="changeCard('White',-1)">âˆ’</button></div>
              </div>
            </div>

            <!-- Deck & Discard column -->
            <div class="col" aria-labelledby="deck-title">
              <h3 id="deck-title">Deck & Discard</h3>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="smallbtn" onclick="resetDeck()">Reset Deck</button>
                <button class="smallbtn" onclick="reshuffleDiscardIntoDeck()">Reshuffle Discard</button>
              </div>
              <div style="margin-top:8px;font-size:13px">Cards in deck: <strong id="deck-count">0</strong></div>
            </div>
          </div>

          <!-- Draw row -->
          <div class="row" style="margin-top:6px;align-items:center">
            <button class="smallbtn" onclick="drawDummyCards()">Draw</button>
            <div id="dummy-output" class="output" style="flex:1;margin-left:8px">Drawn cards will appear here.</div>
          </div>

          <!-- Discard below draw -->
          <div style="margin-top:6px">
            <div style="font-weight:700;margin-bottom:6px">Discard Pile</div>
            <div id="discard-output" class="output">Discard pile is empty.</div>
          </div>

        </div>
      </div>
    </section>

  </div>

  <script>
    // State
    let fame = 0;
    let crystals = { red: 0, blue: 0, green: 0, white: 0 };
    // cardCounts mirror crystals-style controls (start 4 each)
    let cardCounts = { Red: 4, Blue: 4, Green: 4, White: 4 };
    let dummyDeck = [];
    let discardPile = [];

    // Reputation rows content
    const repPositive = ["+1","+1","+2","+2","+3","+5"];
    const repNeutral = ["0","0","0"];
    const repNegative = ["-1","-1","-2","-3","-5","X"];

    // Fame level brackets
    const fameLevels = [
      {level:1, min:0,  max:2},
      {level:2, min:3,  max:7},
      {level:3, min:8,  max:14},
      {level:4, min:15, max:23},
      {level:5, min:24, max:34},
      {level:6, min:35, max:47},
      {level:7, min:48, max:62},
      {level:8, min:63, max:79},
      {level:9, min:80, max:98},
      {level:10,min:99, max:119}
    ];

    // DOM refs
    const repWrap = document.getElementById('rep-wrap');
    const repDisplayEl = document.getElementById('rep-display');
    const fameInput = document.getElementById('fame-input');
    const fameResult = document.getElementById('fame-result');
    const fameDisplayEl = document.getElementById('fame-display');
    const dummyOutput = document.getElementById('dummy-output');
    const discardOutput = document.getElementById('discard-output');

    // Build reputation rows inside the boxed area
    function buildRepRows() {
      repWrap.innerHTML = '';
      const topRow = document.createElement('div'); topRow.className = 'rep-row';
      repPositive.forEach(label => {
        const el = document.createElement('div'); el.className = 'rep-cell'; el.textContent = label;
        el.addEventListener('click', () => selectRep(el, label));
        topRow.appendChild(el);
      });
      const midRow = document.createElement('div'); midRow.className = 'rep-row';
      repNeutral.forEach(label => {
        const el = document.createElement('div'); el.className = 'rep-cell'; el.textContent = label;
        el.addEventListener('click', () => selectRep(el, label));
        midRow.appendChild(el);
      });
      const botRow = document.createElement('div'); botRow.className = 'rep-row';
      repNegative.forEach(label => {
        const el = document.createElement('div'); el.className = 'rep-cell'; el.textContent = label;
        el.addEventListener('click', () => selectRep(el, label));
        botRow.appendChild(el);
      });
      repWrap.appendChild(topRow);
      repWrap.appendChild(midRow);
      repWrap.appendChild(botRow);
    }

    function clearRepSelection() {
      Array.from(repWrap.querySelectorAll('.rep-cell')).forEach(c => c.classList.remove('selected'));
    }

    function selectRep(el, label) {
      clearRepSelection();
      el.classList.add('selected');
      repDisplayEl.textContent = label;
    }

    // Fame helpers
    function getFameLevel(v) {
      const val = Math.max(0, Math.min(119, Math.floor(Number(v) || 0)));
      for (const b of fameLevels) if (val >= b.min && val <= b.max) return b.level;
      return 1;
    }
    function updateFameFromInput() {
      const val = Math.max(0, Math.min(119, Math.floor(Number(fameInput.value) || 0)));
      fame = val;
      const level = getFameLevel(fame);
      fameResult.textContent = `Level ${level}`;
      fameDisplayEl.textContent = fame;
    }

    // Crystals
    function changeCrystal(color, amount) {
      const key = color.toLowerCase();
      crystals[key] = Math.max(0, crystals[key] + amount);
      document.getElementById(key).textContent = crystals[key];
    }

    // Card counts behave like crystals (same add/remove UI)
    function changeCard(color, amount) {
      cardCounts[color] = Math.max(0, (cardCounts[color] || 0) + amount);
      document.getElementById(`card-${color.toLowerCase()}`).textContent = cardCounts[color];
      // optionally update deck count if deck is not yet generated
    }

    // Build deck from current cardCounts
    function rebuildDeckFromCounts() {
      dummyDeck = [];
      Object.keys(cardCounts).forEach(color => {
        for (let i=0;i<cardCounts[color];i++) dummyDeck.push(`${color} Card`);
      });
      shuffle(dummyDeck);
      updateDeckCount();
    }

    // Deck & draw logic
    function initializeDeck() {
      rebuildDeckFromCounts();
      discardPile = [];
      updateDiscard();
      dummyOutput.textContent = 'Deck initialized and shuffled.';
    }
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
    function resetDeck(){ initializeDeck(); }
    function reshuffleDiscardIntoDeck(){ if(discardPile.length===0) return; dummyDeck.push(...discardPile); discardPile = []; shuffle(dummyDeck); updateDeckCount(); updateDiscard(); }

    function drawDummyCards(){
      const drawn = [];
      // draw 3 base
      for(let i=0;i<3 && dummyDeck.length>0;i++) drawn.push(dummyDeck.pop());
      // extra based on crystals matching last drawn color
      const last = drawn[drawn.length-1];
      if(last){
        const color = last.split(' ')[0].toLowerCase();
        const extra = crystals[color] || 0;
        for(let i=0;i<extra && dummyDeck.length>0;i++) drawn.push(dummyDeck.pop());
      }
      // if deck empty and discard exists, reshuffle discard into deck AFTER draw
      if(dummyDeck.length===0 && discardPile.length>0){
        const moved = discardPile.splice(0);
        dummyDeck.push(...moved);
        shuffle(dummyDeck);
      }
      discardPile.push(...drawn);
      dummyOutput.textContent = drawn.length===0 ? 'No cards drawn (deck empty).' : `Dummy draws: ${drawn.join(', ')}`;
      updateDeckCount(); updateDiscard();
    }

    function updateDeckCount(){ document.getElementById('deck-count').textContent = dummyDeck.length; }
    function updateDiscard(){ document.getElementById('discard-output').textContent = discardPile.length===0 ? 'Discard pile is empty.' : `Discard pile (${discardPile.length}): ${discardPile.join(', ')}`; }

    // Init
    fameInput.addEventListener('input', updateFameFromInput);
    window.addEventListener('load', ()=>{
      buildRepRows();
      // ensure card count elements reflect initial values
      document.getElementById('card-red').textContent = cardCounts.Red;
      document.getElementById('card-blue').textContent = cardCounts.Blue;
      document.getElementById('card-green').textContent = cardCounts.Green;
      document.getElementById('card-white').textContent = cardCounts.White;
      initializeDeck();
      // select center neutral 0 by default
      const midCells = repWrap.querySelectorAll('.rep-row')[1]?.querySelectorAll('.rep-cell');
      if(midCells && midCells[1]) midCells[1].click();
      setTimeout(()=>{ updateFameFromInput(); }, 40);
    });

    // Export functions for inline use
    window.changeCrystal = changeCrystal;
    window.changeCard = changeCard;
    window.resetDeck = resetDeck;
    window.drawDummyCards = drawDummyCards;
    window.reshuffleDiscardIntoDeck = reshuffleDiscardIntoDeck;
  </script>
</body>
</html>
