<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mage Knight Companion ‚Äî Independent Tracks</title>
  <style>
    :root{
      --rep-cell-w: 60px;
      --rep-gap: 6px;
      --fame-cell-w: 36px;
      --fame-gap: 6px;
      --level-gap: 12px;
    }

    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 18px; background: #f4f4f4; color:#222; }
    h1 { margin: 0 0 12px 0; font-size: 20px; }
    h2 { margin: 8px 0; font-size: 16px; }
    .section { margin-bottom: 18px; }
    button { margin: 4px; padding: 6px 10px; font-size: 13px; }
    .output { background: #fff; padding: 10px; border-radius: 6px; min-height:40px; }
    .track-container { background: #ececec; padding: 10px; border-radius: 8px; }

    /* Reputation track */
    .rep-row { display:flex; align-items:center; gap:10px; margin-bottom:12px; }
    .rep-grid { display: grid; grid-auto-flow: column; gap: var(--rep-gap); align-items: center; position: relative; }
    .rep-cell { width: var(--rep-cell-w); background:#ddd; padding:6px; text-align:center; border-radius:6px; font-size:13px; }

    /* Fame track grouped by level rows */
    .levels {
      display: flex;
      flex-direction: column;
      gap: var(--level-gap);
      position: relative;
      padding-bottom: 8px;
    }
    .level-row { display: flex; gap: var(--fame-gap); align-items: center; }
    .level-label { width: 72px; font-weight:600; font-size:13px; }
    .fame-cell { width: var(--fame-cell-w); min-width: var(--fame-cell-w); background:#e0e0e0; padding:6px; text-align:center; border-radius:6px; font-size:12px; }

    /* markers */
    .marker { position: absolute; transform: translate(-50%, -140%); pointer-events: none; font-size:20px; transition: left .16s linear, top .16s linear; }
    .rep-marker { position:absolute; transform: translate(-50%, -220%); font-size:20px; pointer-events:none; transition: left .16s linear, top .16s linear; }

    /* small helpers */
    .controls { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .crystal-row { margin-bottom:6px; }
    .legend { margin-top:8px; font-size:14px; }
    .fame-row-scroll { overflow-x: auto; padding-bottom:6px; }
    .fame-row-scroll::-webkit-scrollbar { height:10px; }
    .fame-row-scroll::-webkit-scrollbar-thumb { background:#c1c1c1; border-radius:6px; }
    .track-controls { display:flex; gap:8px; align-items:center; }
  </style>
</head>
<body>
  <h1>Mage Knight Dummy Player Companion</h1>

  <div class="track-container section">
    <h2>Reputation Track</h2>
    <div class="rep-row">
      <div class="track-controls">
        <button id="rep-decrease" onclick="changeReputation(-1)">‚àí</button>
        <button id="rep-increase" onclick="changeReputation(1)">+</button>
      </div>
      <div class="rep-grid" id="rep-grid" aria-hidden="false">
        <!-- rep cells inserted by JS -->
      </div>
      <div style="min-width:80px; text-align:center;">Current: <strong id="rep-display">0</strong></div>
    </div>

    <h2>Fame Track (by Level)</h2>
    <div style="position:relative;">
      <div id="fame-marker" class="marker">‚≠ê</div>
      <div id="rep-marker" class="rep-marker">üß≠</div>
      <div class="levels" id="levels-container">
        <!-- level rows inserted by JS -->
      </div>
    </div>

    <div class="legend">
      Fame Level: <strong id="fame-level">1</strong> &nbsp;|&nbsp; Fame: <strong id="fame-display">0</strong>
      <span style="float:right">
        <span class="track-controls">
          <button onclick="changeFame(-1)">‚àí</button>
          <button onclick="changeFame(1)">+</button>
        </span>
      </span>
    </div>
  </div>

  <div class="section">
    <h2>Crystals</h2>
    <div class="crystal-row">üî¥ Red: <span id="red">0</span>
      <button onclick="changeCrystal('red', 1)">‚ûï</button>
      <button onclick="changeCrystal('red', -1)">‚ûñ</button>
    </div>
    <div class="crystal-row">üîµ Blue: <span id="blue">0</span>
      <button onclick="changeCrystal('blue', 1)">‚ûï</button>
      <button onclick="changeCrystal('blue', -1)">‚ûñ</button>
    </div>
    <div class="crystal-row">üü¢ Green: <span id="green">0</span>
      <button onclick="changeCrystal('green', 1)">‚ûï</button>
      <button onclick="changeCrystal('green', -1)">‚ûñ</button>
    </div>
    <div class="crystal-row">‚ö™ White: <span id="white">0</span>
      <button onclick="changeCrystal('white', 1)">‚ûï</button>
      <button onclick="changeCrystal('white', -1)">‚ûñ</button>
    </div>
  </div>

  <div class="section">
    <h2>Dummy Deck</h2>
    <div class="controls">
      <button onclick="addCard('Red')">+ Red Card</button>
      <button onclick="addCard('Blue')">+ Blue Card</button>
      <button onclick="addCard('Green')">+ Green Card</button>
      <button onclick="addCard('White')">+ White Card</button>
      <button onclick="resetDeck()">Reset Deck</button>
      <button onclick="reshuffleDiscardIntoDeck()">Reshuffle Discard Into Deck</button>
      <div style="margin-left:6px">Cards left: <strong id="deck-count">0</strong></div>
    </div>
  </div>

  <div class="section">
    <h2>Draw</h2>
    <div class="controls">
      <button onclick="drawDummyCards()">Draw Dummy Cards</button>
      <div id="dummy-output" class="output">Drawn cards will appear here.</div>
    </div>
  </div>

  <div class="section">
    <h2>Discard Pile</h2>
    <div id="discard-output" class="output">Discard pile is empty.</div>
  </div>

  <script>
    // State
    let fame = 0;
    let reputationIndex = 7; // start at middle index (0..14) representing 0
    let crystals = { red: 0, blue: 0, green: 0, white: 0 };
    let dummyDeck = [];
    let discardPile = [];

    // Reputation values fixed
    const repValues = ["‚ÄìX", "‚Äì5", "‚Äì3", "‚Äì2", "‚Äì1", "‚Äì1", "0", "0", "0", "+1", "+1", "+2", "+2", "+3", "+5"];

    // Fame level brackets
    const fameLevels = [
      {level:1, min:0,  max:3  },
      {level:2, min:4,  max:7  },
      {level:3, min:8,  max:14 },
      {level:4, min:15, max:23 },
      {level:5, min:24, max:34 },
      {level:6, min:35, max:47 },
      {level:7, min:48, max:52 },
      {level:8, min:53, max:79 },
      {level:9, min:80, max:98 },
      {level:10,min:99, max:119}
    ];

    // DOM refs
    const repGrid = document.getElementById('rep-grid');
    const levelsContainer = document.getElementById('levels-container');
    const marker = document.getElementById('fame-marker');
    const repMarker = document.getElementById('rep-marker');
    const fameLevelEl = document.getElementById('fame-level');
    const fameDisplayEl = document.getElementById('fame-display');
    const repDisplayEl = document.getElementById('rep-display');

    // Build reputation UI
    repValues.forEach((v, idx) => {
      const c = document.createElement('div');
      c.className = 'rep-cell';
      c.textContent = v;
      c.dataset.index = idx;
      repGrid.appendChild(c);
    });

    // Build fame UI rows and keep references
    const fameCellRefs = []; // {levelIndex, value, el}
    fameLevels.forEach((lvl, levelIndex) => {
      const rowWrap = document.createElement('div');
      rowWrap.className = 'level-row';

      const label = document.createElement('div');
      label.className = 'level-label';
      label.textContent = `Level ${lvl.level}`;
      rowWrap.appendChild(label);

      const scrollWrap = document.createElement('div');
      scrollWrap.className = 'fame-row-scroll';
      scrollWrap.style.flex = '1';
      scrollWrap.style.overflowX = 'auto';

      const cellsContainer = document.createElement('div');
      cellsContainer.style.display = 'flex';
      cellsContainer.style.gap = 'var(--fame-gap)';
      cellsContainer.style.alignItems = 'center';
      cellsContainer.style.paddingBottom = '6px';

      for (let v = lvl.min; v <= lvl.max; v++) {
        const cell = document.createElement('div');
        cell.className = 'fame-cell';
        cell.textContent = v;
        cell.dataset.value = v;
        cellsContainer.appendChild(cell);
        fameCellRefs.push({ levelIndex, value: v, el: cell });
      }

      scrollWrap.appendChild(cellsContainer);
      rowWrap.appendChild(scrollWrap);
      levelsContainer.appendChild(rowWrap);
    });

    // locate fame position
    function locateFame(value) {
      value = Math.max(0, Math.min(119, value));
      for (let i=0;i<fameLevels.length;i++){
        const lvl = fameLevels[i];
        if (value >= lvl.min && value <= lvl.max) {
          return { levelIndex: i, level: lvl.level, min: lvl.min, max: lvl.max, indexInRow: value - lvl.min };
        }
      }
      return { levelIndex:0, level:1, indexInRow:0 };
    }

    // position fame marker above the correct cell
    function updateFameMarker() {
      const ref = fameCellRefs.find(r => r.value === fame);
      if (!ref) return;
      const containerRect = levelsContainer.getBoundingClientRect();
      const cellRect = ref.el.getBoundingClientRect();
      const left = (cellRect.left + cellRect.right) / 2 - containerRect.left;
      const rowEl = ref.el.closest('.level-row');
      const rowRect = rowEl.getBoundingClientRect();
      const top = rowRect.top - containerRect.top;
      marker.style.left = `${left}px`;
      marker.style.top = `${top}px`;
      // update displays
      const loc = locateFame(fame);
      fameLevelEl.textContent = loc.level;
      fameDisplayEl.textContent = fame;
      // scroll the row to center the cell
      const scrollWrap = ref.el.closest('.fame-row-scroll');
      if (scrollWrap) {
        const cellCenter = (cellRect.left + cellRect.right) / 2;
        const wrapRect = scrollWrap.getBoundingClientRect();
        const relative = cellCenter - wrapRect.left;
        const target = relative - wrapRect.width/2;
        scrollWrap.scrollLeft += target;
      }
    }

    // position reputation marker above selected rep cell
    function updateRepMarker() {
      const repCell = repGrid.querySelector(`.rep-cell[data-index="${reputationIndex}"]`);
      if (!repCell) return;
      const gridRect = repGrid.getBoundingClientRect();
      const cellRect = repCell.getBoundingClientRect();
      const left = (cellRect.left + cellRect.right)/2 - gridRect.left;
      // place repMarker above rep grid
      const top = repGrid.getBoundingClientRect().top - levelsContainer.getBoundingClientRect().top - 28; // lift above fame area
      repMarker.style.left = `${left}px`;
      repMarker.style.top = `${top}px`;
      // update rep display (middle index 7 maps to 0)
      // map index 0..14 to logical rep value display using repValues array
      repDisplayEl.textContent = repValues[reputationIndex];
    }

    // controls
    function changeFame(amount) {
      fame = Math.max(0, Math.min(119, fame + amount));
      updateFameMarker();
    }

    function changeReputation(amount) {
      reputationIndex = Math.max(0, Math.min(repValues.length - 1, reputationIndex + amount));
      updateRepMarker();
    }

    function changeCrystal(color, amount) {
      crystals[color] = Math.max(0, crystals[color] + amount);
      document.getElementById(color).textContent = crystals[color];
    }

    // Deck functions
    function initializeDeck() {
      dummyDeck = [
        ...Array(4).fill("Red Card"),
        ...Array(4).fill("Blue Card"),
        ...Array(4).fill("Green Card"),
        ...Array(4).fill("White Card")
      ];
      discardPile = [];
      shuffleArray(dummyDeck);
      updateDeckCount();
      updateDiscardPile();
      document.getElementById('dummy-output').textContent = 'Deck initialized and shuffled.';
    }

    function shuffleArray(a){
      for (let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
    }

    function addCard(color){
      dummyDeck.push(`${color} Card`);
      updateDeckCount();
    }
    function resetDeck(){ initializeDeck(); }

    function reshuffleDiscardIntoDeck(){
      if (discardPile.length === 0) { alert('Discard pile is empty.'); return; }
      dummyDeck.push(...discardPile);
      discardPile = [];
      shuffleArray(dummyDeck);
      updateDeckCount();
      updateDiscardPile();
    }

    function drawDummyCards(){
      const drawn = [];
      // draw 3
      for (let i=0;i<3 && dummyDeck.length>0;i++){
        drawn.push(dummyDeck.pop());
      }
      const last = drawn[drawn.length-1];
      if (last){
        const color = last.split(' ')[0].toLowerCase();
        const extra = crystals[color] || 0;
        for (let i=0;i<extra && dummyDeck.length>0;i++){
          drawn.push(dummyDeck.pop());
        }
      }
      // if deck empty and discard exists, reshuffle discard into deck AFTER the draw (current drawn go to discard)
      if (dummyDeck.length === 0 && discardPile.length > 0){
        const moved = discardPile.splice(0);
        dummyDeck.push(...moved);
        shuffleArray(dummyDeck);
      }
      discardPile.push(...drawn);
      document.getElementById('dummy-output').textContent = drawn.length === 0 ? 'No cards drawn (deck empty).' : `Dummy draws: ${drawn.join(', ')}`;
      updateDeckCount();
      updateDiscardPile();
    }

    function updateDeckCount(){ document.getElementById('deck-count').textContent = dummyDeck.length; }
    function updateDiscardPile(){
      document.getElementById('discard-output').textContent = discardPile.length === 0 ? 'Discard pile is empty.' : `Discard pile (${discardPile.length}): ${discardPile.join(', ')}`;
    }

    // initialize UI on load
    window.addEventListener('load', () => {
      initializeDeck();
      // ensure fame marker positioned
      setTimeout(() => {
        updateFameMarker();
        updateRepMarker();
      }, 60);
    });

    // expose functions for inline onclicks
    window.changeFame = changeFame;
    window.changeReputation = changeReputation;
    window.changeCrystal = changeCrystal;
    window.addCard = addCard;
    window.resetDeck = resetDeck;
    window.drawDummyCards = drawDummyCards;
    window.reshuffleDiscardIntoDeck = reshuffleDiscardIntoDeck;
  </script>
</body>
</html>
