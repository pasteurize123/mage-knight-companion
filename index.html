<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mage Knight Companion â€” Independent Dummy Players</title>
  <style>
    :root{
      --bg:#f4f4f4; --panel:#ececec; --card:#ffffff; --cell:#e8e8e8;
      --rep-min:44px; --overlay: rgba(0,0,0,0.45);
      --gold:#ffd700; --yellow:#ffeb99; --danger:#ff6b6b;
      --base-font:16px; --title-font:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      background:var(--bg);color:#111;padding:12px;font-size:var(--base-font);line-height:1.35;
    }
    h1{font-size:var(--title-font);margin:0 0 12px;text-align:center;font-weight:700}
    .container{max-width:980px;margin:0 auto;display:flex;flex-direction:column;gap:12px}
    .panel{background:var(--panel);border-radius:10px;padding:10px}
    .panel-inner{background:var(--card);border-radius:8px;padding:12px;display:flex;flex-direction:column;gap:10px}
    .panel-inner h2{font-size:16px;margin:0 0 12px;font-weight:700}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type=number]{width:120px;padding:8px;border-radius:6px;border:1px solid #ccc;text-align:center;font-size:1rem}
    .smallbtn{padding:6px 10px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer;font-size:1rem}
    .muted{color:#666;font-size:0.9375rem}
    .rep-wrap{display:flex;flex-direction:column;gap:8px;align-items:center;position:relative}
    .rep-row{display:flex;gap:8px;justify-content:center;align-items:center}
    .rep-cell{min-width:var(--rep-min);padding:6px 10px;background:var(--cell);border-radius:6px;text-align:center;cursor:pointer;user-select:none;font-size:0.9375rem}
    .rep-row.top .rep-cell.selected{background:var(--gold);font-weight:700;color:#111}
    .rep-row.mid .rep-cell.selected{background:var(--yellow);font-weight:700;color:#111}
    .rep-row.bot .rep-cell.selected{background:var(--danger);font-weight:700;color:#fff}

    /* Levels trigger/panel */
    .levels-trigger{background:transparent;border:0;padding:0;font-weight:700;cursor:pointer;color:inherit}
    .levels-container{position:relative;display:inline-block}
    .levels-panel{
      position:absolute;left:0;top:calc(100% + 8px);
      display:none;background:#fff;border-radius:8px;padding:10px;
      box-shadow:0 8px 30px rgba(0,0,0,0.12);
      min-width:220px;max-width:360px;z-index:50;font-size:14px;
    }
    .levels-trigger[aria-expanded="true"] + .levels-panel,
    .levels-trigger:hover + .levels-panel,
    .levels-trigger:focus + .levels-panel,
    .levels-panel:hover { display:block; }
    .levels-list{display:flex;flex-direction:column;gap:6px;padding:0;margin:0;list-style:none}
    .level-line{padding:6px 8px;border-radius:4px;font-weight:600;font-size:14px;background:transparent;color:#111}

    .output{background:#fff;padding:8px;border-radius:6px;min-height:36px;font-size:1rem}
    .center{display:flex;align-items:center;justify-content:center;gap:8px}
    .center-column{display:flex;flex-direction:column;align-items:center;gap:6px}
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:var(--overlay);z-index:60}
    .modal{background:#fff;border-radius:10px;padding:16px;max-width:520px;width:92%;box-shadow:0 8px 30px rgba(0,0,0,0.25)}
    .modal p{margin:0;font-size:0.95rem;line-height:1.35}
    footer{display:flex;justify-content:center;padding:8px 0} /* center New Game button */
    @media (max-width:700px){ input[type=number]{width:90px} :root{--rep-min:34px} }
    /* small utility to dim disabled controls */
    .disabled { opacity:0.6; pointer-events:auto; } 
  </style>
</head>
<body>
  <h1>Mage Knight Companion</h1>

  <div class="container">

    <section class="panel" aria-labelledby="rep-title">
      <div class="panel-inner">
        <h2 id="rep-title">Reputation</h2>
        <div id="rep-wrap" class="rep-wrap" aria-label="Reputation track"></div>
      </div>
    </section>

    <section class="panel" aria-labelledby="fame-title">
      <div class="panel-inner">
        <h2 id="fame-title">Fame</h2>

        <div class="center-column" style="width:100%">
          <div class="center" style="width:100%;margin-bottom:6px">
            <div style="text-align:center">
              <label style="font-weight:700;display:block;margin-bottom:6px">Player Fame</label>
              <input id="fame-input" type="number" min="0" value="0" aria-label="Fame value" />
            </div>

            <div style="width:18px"></div>

            <div style="text-align:center">
              <label style="font-weight:700;display:block;margin-bottom:6px">Player Level</label>
              <div id="player-level" class="output" style="min-width:80px;text-align:center">1</div>
            </div>
          </div>

          <div class="center" style="width:100%">
            <div>
              <button class="smallbtn fame-inc" data-inc="1">+1</button>
              <button class="smallbtn fame-inc" data-inc="2">+2</button>
              <button class="smallbtn fame-inc" data-inc="3">+3</button>
              <button class="smallbtn fame-inc" data-inc="5">+5</button>
              <button class="smallbtn fame-inc" data-inc="10">+10</button>
            </div>
          </div>
        </div>

        <div style="width:100%;margin-top:10px">
          <h3 style="margin:8px 0 6px 0;font-size:1rem">
            <span class="levels-container">
              <button id="levels-toggle" class="levels-trigger" aria-expanded="false" aria-controls="levels-panel" aria-haspopup="true">Levels Achieved</button>
              <div id="levels-panel" class="levels-panel" role="region" aria-label="Levels achieved panel" aria-hidden="true" tabindex="-1">
                <ul id="levels-list" class="levels-list"><li class="level-line">None yet</li></ul>
              </div>
            </span>
          </h3>
        </div>
      </div>
    </section>

    <!-- Dummy Player module -->
    <section class="panel" aria-labelledby="dummy-title">
      <div class="panel-inner" id="dummy-module">
        <h2 id="dummy-title">Dummy Player</h2>

        <div class="row" style="gap:18px">
          <div>
            <h3 style="margin:0 0 6px 0;font-size:1rem">Crystals</h3>
            <div class="row" style="align-items:center">
              <div class="mini-group icon-label">ðŸ”´ <strong id="red">0</strong></div>
              <div class="mini-group"><button class="smallbtn crystal-btn" data-player="main" data-color="red" data-act="inc">+</button><button class="smallbtn crystal-btn" data-player="main" data-color="red" data-act="dec">âˆ’</button></div>

              <div style="width:12px"></div>

              <div class="mini-group icon-label">ðŸ”µ <strong id="blue">0</strong></div>
              <div class="mini-group"><button class="smallbtn crystal-btn" data-player="main" data-color="blue" data-act="inc">+</button><button class="smallbtn crystal-btn" data-player="main" data-color="blue" data-act="dec">âˆ’</button></div>

              <div style="width:12px"></div>

              <div class="mini-group icon-label">ðŸŸ¢ <strong id="green">0</strong></div>
              <div class="mini-group"><button class="smallbtn crystal-btn" data-player="main" data-color="green" data-act="inc">+</button><button class="smallbtn crystal-btn" data-player="main" data-color="green" data-act="dec">âˆ’</button></div>

              <div style="width:12px"></div>

              <div class="mini-group icon-label">âšª <strong id="white">0</strong></div>
              <div class="mini-group"><button class="smallbtn crystal-btn" data-player="main" data-color="white" data-act="inc">+</button><button class="smallbtn crystal-btn" data-player="main" data-color="white" data-act="dec">âˆ’</button></div>
            </div>
          </div>

          <div>
            <h3 style="margin:0 0 6px 0;font-size:1rem">Cards</h3>
            <div class="row" style="align-items:center">
              <div class="mini-group icon-label">ðŸ”´ <strong id="card-red">4</strong></div>
              <div class="mini-group"><button class="smallbtn card-btn" data-player="main" data-color="Red" data-act="inc">+</button><button class="smallbtn card-btn" data-player="main" data-color="Red" data-act="dec">âˆ’</button></div>

              <div style="width:12px"></div>

              <div class="mini-group icon-label">ðŸ”µ <strong id="card-blue">4</strong></div>
              <div class="mini-group"><button class="smallbtn card-btn" data-player="main" data-color="Blue" data-act="inc">+</button><button class="smallbtn card-btn" data-player="main" data-color="Blue" data-act="dec">âˆ’</button></div>

              <div style="width:12px"></div>

              <div class="mini-group icon-label">ðŸŸ¢ <strong id="card-green">4</strong></div>
              <div class="mini-group"><button class="smallbtn card-btn" data-player="main" data-color="Green" data-act="inc">+</button><button class="smallbtn card-btn" data-player="main" data-color="Green" data-act="dec">âˆ’</button></div>

              <div style="width:12px"></div>

              <div class="mini-group icon-label">âšª <strong id="card-white">4</strong></div>
              <div class="mini-group"><button class="smallbtn card-btn" data-player="main" data-color="White" data-act="inc">+</button><button class="smallbtn card-btn" data-player="main" data-color="White" data-act="dec">âˆ’</button></div>
            </div>

            <div style="margin-top:8px" class="muted">Cards in deck: <strong id="deck-count">0</strong></div>
          </div>
        </div>

        <div style="margin-top:10px" class="row">
          <button id="draw-btn" class="smallbtn" data-player="main">Draw</button>
          <div id="dummy-output" class="output" style="flex:1;margin-left:8px">Drawn symbols appear here</div>
        </div>

        <div style="margin-top:8px">
          <div id="discard-output" class="output">Discard pile is empty.</div>
          <div style="margin-top:8px;display:flex;justify-content:center">
            <button id="reshuffle-btn" class="smallbtn" data-player="main">Reshuffle Deck</button>
          </div>
        </div>
      </div>
    </section>

    <!-- General Volkare module (independent) with a wounds counter and specialized deck -->
    <section class="panel" aria-labelledby="gv-title">
      <div class="panel-inner" id="gv-module">
        <h2 id="gv-title">General Volkare</h2>

        <div class="row" style="gap:18px">
          <!-- No crystals for GV as requested -->
          <div style="flex:1">
            <h3 style="margin:0 0 6px 0;font-size:1rem">Deck Composition</h3>

            <div style="display:flex;flex-direction:column;gap:6px">
              <div class="muted">Advanced Actions (16 total): <strong id="gv-adv-count">16</strong> â€” 4 each colour</div>
              <div class="muted">Spells (4 total): <strong id="gv-spell-count">4</strong> â€” 1 each colour</div>

              <div style="display:flex;align-items:center;gap:10px;margin-top:6px">
                <div class="muted">Wounds</div>
                <button class="smallbtn gv-wound-btn" data-act="dec">âˆ’</button>
                <div style="min-width:32px;text-align:center"><strong id="gv-wounds">0</strong></div>
                <button class="smallbtn gv-wound-btn" data-act="inc">+</button>
              </div>

              <div style="margin-top:8px" class="muted">Cards in deck: <strong id="deck-count-gv">0</strong></div>
            </div>
          </div>

          <div style="flex:1">
            <h3 style="margin:0 0 6px 0;font-size:1rem">Controls</h3>
            <div style="display:flex;flex-direction:column;gap:8px">
              <button id="draw-btn-gv" class="smallbtn" data-player="gv">Draw</button>
              <button id="reshuffle-btn-gv" class="smallbtn" data-player="gv">Reshuffle Deck</button>
            </div>
          </div>
        </div>

        <div style="margin-top:10px">
          <div id="dummy-output-gv" class="output">Drawn cards appear here</div>
        </div>

        <div style="margin-top:8px">
          <div id="discard-output-gv" class="output">Discard pile is empty.</div>
        </div>
      </div>
    </section>

    <footer>
      <button id="new-game" class="smallbtn">New Game</button>
    </footer>
  </div>

  <!-- End round modal (shared) -->
  <div id="endround-modal" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="endround-title">
      <h3 id="endround-title">End Round â€” Choose Additions</h3>
      <p>Choose one card to add to the selected dummy player's discard (or deck) as appropriate. For GV, only advanced action or spell is allowed.</p>
      <div style="margin-top:8px">
        <div style="font-weight:600;margin-bottom:6px;font-size:0.9375rem">Choose card</div>
        <div id="card-choices" class="choice-row" style="display:flex;gap:8px">
          <button class="choice-btn" data-val="Adv-Red">Adv ðŸ”´</button>
          <button class="choice-btn" data-val="Adv-Blue">Adv ðŸ”µ</button>
          <button class="choice-btn" data-val="Adv-Green">Adv ðŸŸ¢</button>
          <button class="choice-btn" data-val="Adv-White">Adv âšª</button>
          <button class="choice-btn" data-val="Spell-Red">Spell ðŸ”´</button>
          <button class="choice-btn" data-val="Spell-Blue">Spell ðŸ”µ</button>
          <button class="choice-btn" data-val="Spell-Green">Spell ðŸŸ¢</button>
          <button class="choice-btn" data-val="Spell-White">Spell âšª</button>
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="endround-cancel" class="smallbtn">Cancel</button>
        <button id="endround-confirm" class="smallbtn" disabled>Confirm</button>
      </div>
    </div>
  </div>

  <!-- Level modal -->
  <div id="level-modal" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="lvl-title">
      <h3 id="lvl-title">Level Up</h3>
      <p id="level-message"></p>
      <div style="display:flex;justify-content:flex-end;margin-top:12px">
        <button id="level-ok" class="smallbtn">OK</button>
      </div>
    </div>
  </div>

  <script>
    /* Multi-module implementation with General Volkare using a custom deck (advanced actions, spells) and wounds counter */
    const STORAGE_KEY = 'mk_companion_multi_v2';
    const DEFAULT_CARDS = { Red: 4, Blue: 4, Green: 4, White: 4 };
    const REP_TOP = ["0","+1","+1","+2","+2","+3","+5"];
    const REP_MID = ["0"];
    const REP_BOT = ["0","-1","-1","-2","-3","-5","X"];
    const FAME_LEVELS = [
      {level:1, min:0,  max:2},{level:2, min:3,  max:7},{level:3, min:8,  max:14},
      {level:4, min:15, max:23},{level:5, min:24, max:34},{level:6, min:35, max:47},
      {level:7, min:48, max:62},{level:8, min:63, max:79},{level:9, min:80, max:98},
      {level:10,min:99, max:119}
    ];
    const LEVEL_PROMPTS = {
      1: "Command Token",2: "Skill + Advanced Action",3: "Command Token",
      4: "Skill + Advanced Action",5: "Command Token",6: "Skill + Advanced Action",
      7: "Command Token",8: "Skill + Advanced Action",9: "Command Token",10: "Skill + Advanced Action"
    };
    const COLOR_SYMBOL = { Red:'ðŸ”´', Blue:'ðŸ”µ', Green:'ðŸŸ¢', White:'âšª', red:'ðŸ”´', blue:'ðŸ”µ', green:'ðŸŸ¢', white:'âšª' };

    /* Main Dummy module (unchanged from previous) */
    function DummyModule(idPrefix, displayName) {
      const ids = {
        red: 'red' + idPrefix, blue: 'blue' + idPrefix, green: 'green' + idPrefix, white: 'white' + idPrefix,
        cardRed: 'card-red' + idPrefix, cardBlue: 'card-blue' + idPrefix, cardGreen: 'card-green' + idPrefix, cardWhite: 'card-white' + idPrefix,
        deckCount: 'deck-count' + idPrefix, drawBtn: (idPrefix ? 'draw-btn-' + idPrefix.replace(/^-/, '') : 'draw-btn'),
        dummyOutput: 'dummy-output' + idPrefix, discardOutput: 'discard-output' + idPrefix, reshuffleBtn: 'reshuffle-btn' + (idPrefix ? '-' + idPrefix.replace(/^-/, '') : '')
      };

      let crystals = { red:0, blue:0, green:0, white:0 };
      let cardCounts = { ...DEFAULT_CARDS };
      let deck = [];
      let discard = [];
      let achievedLevels = [1];
      let endRoundFlag = false;
      const SKEY = `${STORAGE_KEY}_${idPrefix || 'main'}`;

      function clampIntNonNeg(v){ return Math.max(0, Math.floor(Number(v) || 0)); }
      function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
      function rebuildDeck(){ deck = []; Object.keys(cardCounts).forEach(color=>{ for(let i=0;i<cardCounts[color];i++) deck.push(`${color} Card`); }); shuffle(deck); updateDeckCount(); save(); }

      function el(id){ return document.getElementById(id); }
      function updateCrystalViews(){
        if(el(ids.red)) el(ids.red).textContent = crystals.red;
        if(el(ids.blue)) el(ids.blue).textContent = crystals.blue;
        if(el(ids.green)) el(ids.green).textContent = crystals.green;
        if(el(ids.white)) el(ids.white).textContent = crystals.white;
      }
      function updateCardViews(){
        if(el(ids.cardRed)) el(ids.cardRed).textContent = cardCounts.Red;
        if(el(ids.cardBlue)) el(ids.cardBlue).textContent = cardCounts.Blue;
        if(el(ids.cardGreen)) el(ids.cardGreen).textContent = cardCounts.Green;
        if(el(ids.cardWhite)) el(ids.cardWhite).textContent = cardCounts.White;
      }
      function updateDeckCount(){ const node = el(ids.deckCount); if(node) node.textContent = deck.length; }
      function updateDiscardView(){ const node = el(ids.discardOutput); if(!node) return; if(discard.length===0) node.textContent='Discard pile is empty.'; else node.textContent = `Discard (${discard.length}): ${discard.map(c=>COLOR_SYMBOL[c.split(' ')[0]]||c).join(' ')}`; }

      function save(){ try{ const s={crystals,cardCounts,deck,discard,achievedLevels,endRoundFlag}; localStorage.setItem(SKEY, JSON.stringify(s)); }catch(e){} }
      function load(){ try{ const raw = localStorage.getItem(SKEY); if(!raw) return false; const s=JSON.parse(raw); crystals = s.crystals || crystals; cardCounts = s.cardCounts || cardCounts; deck = Array.isArray(s.deck)?s.deck:deck; discard = Array.isArray(s.discard)?s.discard:discard; achievedLevels = Array.isArray(s.achievedLevels)?s.achievedLevels:achievedLevels; endRoundFlag = !!s.endRoundFlag; return true; }catch(e){ return false; } }

      function changeCrystal(color, delta){ crystals[color] = Math.max(0,(crystals[color]||0)+delta); updateCrystalViews(); save(); }
      function changeCard(color, delta){
        cardCounts[color] = Math.max(0,(cardCounts[color]||0)+delta);
        updateCardViews();
        if(delta>0){ const name = `${color} Card`; const pos = Math.floor(Math.random()*(deck.length+1)); deck.splice(pos,0,name); }
        else { const name = `${color} Card`; const idx = deck.indexOf(name); if(idx!==-1) deck.splice(idx,1); else { const dj=discard.indexOf(name); if(dj!==-1) discard.splice(dj,1); } }
        updateDeckCount(); updateDiscardView(); save();
      }

      function drawOnce(){
        const drawn=[];
        for(let i=0;i<3 && deck.length>0;i++) drawn.push(deck.pop());
        if(drawn.length===0){ endRoundFlag = true; const btn = el(ids.drawBtn); if(btn) btn.textContent = 'End Round'; const out = el(ids.dummyOutput); if(out) out.textContent='Nil cards drawn. End of round announced.'; save(); return; }
        const last = drawn[drawn.length-1];
        if(last){ const color = last.split(' ')[0].toLowerCase(); const extra = crystals[color]||0; for(let i=0;i<extra && deck.length>0;i++) drawn.push(deck.pop()); }
        discard.push(...drawn);
        const syms = drawn.map(c=>COLOR_SYMBOL[c.split(' ')[0]]||c).join(' ');
        const out = el(ids.dummyOutput); if(out) out.textContent = syms;
        updateDeckCount(); updateDiscardView(); save();
      }

      function reshuffle(){
        if(discard.length===0){ const out = el(ids.dummyOutput); if(out) out.textContent='Discard pile is empty. Nothing to reshuffle.'; return; }
        deck.push(...discard); discard = []; shuffle(deck); updateDeckCount(); updateDiscardView(); endRoundFlag=false; const btn = el(ids.drawBtn); if(btn) btn.textContent='Draw'; const out = el(ids.dummyOutput); if(out) out.textContent='Deck reshuffled from discard.'; save();
      }

      function openEndRoundModal(openCallback){ openCallback(); }

      function renderLevelsList(){ const arr = []; for(let i=0;i<achievedLevels.length;i++){ const L = achievedLevels[i]; const desc = LEVEL_PROMPTS[L]||''; arr.push(`Level ${L}: ${desc}`); } return arr.length?arr:['None yet']; }

      function resetInitial(){
        crystals = { red:0, blue:0, green:0, white:0 };
        const keys=['red','blue','green','white']; const first = keys[Math.floor(Math.random()*keys.length)]; let second = keys[Math.floor(Math.random()*keys.length)]; while(second===first) second=keys[Math.floor(Math.random()*keys.length)];
        crystals[first]=2; crystals[second]=1;
        cardCounts = {...DEFAULT_CARDS};
        deck = []; discard = []; achievedLevels=[1]; endRoundFlag=false;
        rebuildDeck(); updateCrystalViews(); updateCardViews(); updateDeckCount(); updateDiscardView(); save();
      }

      function wire(){
        document.querySelectorAll(`.crystal-btn[data-player="${idPrefix || 'main'}"]`).forEach(btn=>{
          btn.addEventListener('click', ()=>{ const color = btn.dataset.color; const act = btn.dataset.act; changeCrystal(color, act==='inc'?1:-1); });
        });
        document.querySelectorAll(`.card-btn[data-player="${idPrefix || 'main'}"]`).forEach(btn=>{
          btn.addEventListener('click', ()=>{ const color = btn.dataset.color; const act = btn.dataset.act; changeCard(color, act==='inc'?1:-1); });
        });
        const drawBtnEl = el(ids.drawBtn);
        if(drawBtnEl) drawBtnEl.addEventListener('click', ()=>{ if(endRoundFlag && drawBtnEl.textContent==='End Round'){ openEndRoundModal(()=>openEndRoundForPlayer(idPrefix||'main')); return; } drawOnce(); });
        const reshuffleEl = el(ids.reshuffleBtn);
        if(reshuffleEl) reshuffleEl.addEventListener('click', reshuffle);
      }

      return {
        ids, load, save, wire, resetInitial, rebuildDeck, getRenderLevels: renderLevelsList,
        getState: ()=>({crystals,cardCounts,deck,discard,achievedLevels,endRoundFlag}),
        setStateFrom: (s)=>{ crystals = s.crystals||crystals; cardCounts = s.cardCounts||cardCounts; deck = Array.isArray(s.deck)?s.deck:deck; discard = Array.isArray(s.discard)?s.discard:discard; achievedLevels = Array.isArray(s.achievedLevels)?s.achievedLevels:achievedLevels; endRoundFlag = !!s.endRoundFlag; updateCrystalViews(); updateCardViews(); updateDeckCount(); updateDiscardView(); save(); },
        drawOnce, reshuffle, changeCrystal, changeCard, updateViews: ()=>{ updateCrystalViews(); updateCardViews(); updateDeckCount(); updateDiscardView(); }
      };
    }

    /* General Volkare module with specialized deck and wounds */
    function GVModule() {
      // no crystals; deck composed of:
      // - Advanced Actions: Adv-Red x4, Adv-Blue x4, Adv-Green x4, Adv-White x4 (total 16)
      // - Spells: Spell-Red x1, Spell-Blue x1, Spell-Green x1, Spell-White x1 (total 4)
      // wounds count starting at 0 (min 0) and can be adjusted via +/- buttons
      const ids = {
        deckCount: 'deck-count-gv',
        drawBtn: 'draw-btn-gv',
        dummyOutput: 'dummy-output-gv',
        discardOutput: 'discard-output-gv',
        reshuffleBtn: 'reshuffle-btn-gv',
        gvWounds: 'gv-wounds',
        gvAdvCount: 'gv-adv-count',
        gvSpellCount: 'gv-spell-count'
      };

      let deck = [];
      let discard = [];
      let wounds = 0;
      const SKEY = `${STORAGE_KEY}_gv_v2`;

      function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
      function el(id){ return document.getElementById(id); }

      function buildDefaultDeck(){
        deck = [];
        // advanced actions
        ['Red','Blue','Green','White'].forEach(color=>{
          for(let i=0;i<4;i++) deck.push(`Adv-${color}`);
        });
        // spells
        ['Red','Blue','Green','White'].forEach(color=>{
          deck.push(`Spell-${color}`);
        });
        shuffle(deck);
        save();
        updateCounts();
      }

      function updateCounts(){
        if(el(ids.deckCount)) el(ids.deckCount).textContent = deck.length;
        if(el(ids.discardOutput)) el(ids.discardOutput).textContent = discard.length === 0 ? 'Discard pile is empty.' : `Discard (${discard.length}): ${discard.map(c=>c).join(' ')}`;
        if(el(ids.gvAdvCount)) el(ids.gvAdvCount).textContent = 16;
        if(el(ids.gvSpellCount)) el(ids.gvSpellCount).textContent = 4;
        if(el(ids.gvWounds)) el(ids.gvWounds).textContent = wounds;
      }

      function save(){ try{ const s={deck,discard,wounds}; localStorage.setItem(SKEY, JSON.stringify(s)); }catch(e){} }
      function load(){ try{ const raw = localStorage.getItem(SKEY); if(!raw) return false; const s=JSON.parse(raw); deck = Array.isArray(s.deck)?s.deck:deck; discard = Array.isArray(s.discard)?s.discard:discard; wounds = typeof s.wounds === 'number' ? s.wounds : wounds; updateCounts(); return true; }catch(e){ return false; } }

      function changeWounds(delta){
        wounds = Math.max(0, wounds + delta);
        updateCounts();
        save();
      }

      function drawOnce(){
        const drawn = [];
        for(let i=0;i<3 && deck.length>0;i++) drawn.push(deck.pop());
        if(drawn.length===0){
          const btn = el(ids.drawBtn); if(btn) btn.textContent = 'End Round';
          const out = el(ids.dummyOutput); if(out) out.textContent = 'Nil cards drawn. End of round announced.';
          save(); updateCounts(); return;
        }
        discard.push(...drawn);
        const out = el(ids.dummyOutput); if(out) out.textContent = drawn.join(' ');
        updateCounts(); save();
      }

      function reshuffle(){
        if(discard.length === 0){
          const out = el(ids.dummyOutput); if(out) out.textContent = 'Discard pile is empty. Nothing to reshuffle.'; return;
        }
        deck.push(...discard); discard = []; shuffle(deck); updateCounts(); const out = el(ids.dummyOutput); if(out) out.textContent = 'Deck reshuffled from discard.'; save();
        const btn = el(ids.drawBtn); if(btn) btn.textContent = 'Draw';
      }

      function addCardToDiscard(cardCode){
        // cardCode expected like 'Adv-Red' or 'Spell-Blue'
        discard.push(cardCode);
        updateCounts(); save();
      }

      function wire(){
        const drawBtn = el(ids.drawBtn); if(drawBtn) drawBtn.addEventListener('click', ()=>{ if(deck.length===0){ drawBtn.textContent = 'End Round'; el(ids.dummyOutput).textContent = 'Nil cards drawn. End of round announced.'; return; } drawOnce(); });
        const reshuffleBtn = el(ids.reshuffleBtn); if(reshuffleBtn) reshuffleBtn.addEventListener('click', reshuffle);
        // wound buttons
        document.querySelectorAll('.gv-wound-btn').forEach(b=>{
          b.addEventListener('click', ()=>{ const act = b.dataset.act; changeWounds(act==='inc'?1:-1); });
        });
      }

      return {
        ids, buildDefaultDeck, updateCounts, save, load, wire, drawOnce, reshuffle, addCardToDiscard
      };
    }

    // instantiate modules
    const mainModule = DummyModule('', 'Dummy Player');
    const gvModule = GVModule();

    // Shared UI parts and fame handling
    const levelsToggleBtn = document.getElementById('levels-toggle');
    const levelsPanel = document.getElementById('levels-panel');
    const levelsList = document.getElementById('levels-list');
    const levelModal = document.getElementById('level-modal');
    const levelMessage = document.getElementById('level-message');

    let fame = 0;
    function clampIntNonNeg(v){ return Math.max(0, Math.floor(Number(v) || 0)); }
    function getFameLevel(fameValue){
      const v = Math.max(0, Number(fameValue) || 0);
      for (const b of FAME_LEVELS) if (v>=b.min && v<=b.max) return b.level;
      return 10;
    }

    // End-round modal wiring for choosing cards to add
    let endRoundContext = null; // 'main' or 'gv'
    const endroundModal = document.getElementById('endround-modal');
    const cardChoices = document.getElementById('card-choices');
    const endroundConfirm = document.getElementById('endround-confirm');
    const endroundCancel = document.getElementById('endround-cancel');
    let selectedCard = null;

    function openEndRoundForPlayer(playerKey){
      endRoundContext = playerKey; selectedCard = null; endroundConfirm.disabled=true;
      endroundModal.style.display='flex'; endroundModal.setAttribute('aria-hidden','false');
      cardChoices.querySelectorAll('.choice-btn').forEach(b=>b.classList.remove('selected'));
    }
    cardChoices.addEventListener('click',(e)=>{ const btn=e.target.closest('.choice-btn'); if(!btn) return; selectedCard=btn.dataset.val; cardChoices.querySelectorAll('.choice-btn').forEach(b=>b.classList.toggle('selected', b===btn)); endroundConfirm.disabled = !(selectedCard); });
    endroundCancel.addEventListener('click', ()=>{ endroundModal.style.display='none'; endroundModal.setAttribute('aria-hidden','true'); endRoundContext = null; selectedCard = null; });
    endroundConfirm.addEventListener('click', ()=>{
      if(!selectedCard || !endRoundContext) return;
      if(endRoundContext === 'gv'){
        // GV: add advanced action or spell to discard
        gvModule.addCardToDiscard(selectedCard);
        gvModule.updateCounts();
      } else {
        // main dummy: add a normal color card to deck/discard
        const colorCode = selectedCard.replace('Adv-','').replace('Spell-','');
        // treat as adding one colored card into main's deck
        mainModule.changeCard(colorCode, 1);
      }
      endroundModal.style.display='none'; endroundModal.setAttribute('aria-hidden','true'); endRoundContext = null; selectedCard = null;
    });

    // Levels panel content: show each module's achieved levels independently
    function renderLevelsPanel(){
      levelsList.innerHTML = '';
      const mainLines = mainModule.getRenderLevels();
      const gvLines = ['(GV levels not used)']; // gv module doesn't track levels here; kept separate if needed
      const headerMain = document.createElement('li'); headerMain.className='level-line'; headerMain.textContent = 'Dummy Player:'; levelsList.appendChild(headerMain);
      mainLines.forEach(l=>{ const li=document.createElement('li'); li.className='level-line'; li.style.fontWeight='500'; li.style.paddingLeft='10px'; li.textContent = l; levelsList.appendChild(li); });
      const headerGV = document.createElement('li'); headerGV.className='level-line'; headerGV.textContent = 'General Volkare:'; headerGV.style.marginTop='6px'; levelsList.appendChild(headerGV);
      // For GV show deck summary rather than player levels
      const gvDeckSummary = document.createElement('li'); gvDeckSummary.className='level-line'; gvDeckSummary.style.fontWeight='500'; gvDeckSummary.style.paddingLeft='10px';
      gvDeckSummary.textContent = `Adv: 16; Spells: 4; Wounds: ${document.getElementById('gv-wounds') ? document.getElementById('gv-wounds').textContent : '0'}`;
      levelsList.appendChild(gvDeckSummary);
    }

    // Fame prompt behavior (separate lines per level)
    function handleLevelPrompts(prevLevel, newLevel){
      const messages = [];
      for(let L = prevLevel+1; L<=newLevel; L++){
        if(LEVEL_PROMPTS[L]) messages.push(`Level ${L}: ${LEVEL_PROMPTS[L]}`); else messages.push(`Level ${L}`);
      }
      if(messages.length===0) return;
      levelMessage.innerHTML = messages.map(m=>`<div>${m}</div>`).join('');
      levelModal.style.display='flex'; levelModal.setAttribute('aria-hidden','false');
    }
    function updateFameUI(prevFame = null){
      const prevLevel = prevFame !== null ? getFameLevel(prevFame) : null;
      const level = getFameLevel(fame);
      document.getElementById('player-level').textContent = level;
      document.getElementById('fame-input').value = fame;
      if(prevLevel !== null && level > prevLevel) handleLevelPrompts(prevLevel, level);
      renderLevelsPanel();
      saveMeta();
    }

    // Save meta (fame, rep) separately
    function saveMeta(){ try{ const repSelection = window._repSelection || null; localStorage.setItem(STORAGE_KEY + '_meta', JSON.stringify({ fame, repSelection })); }catch(e){} }
    function loadMeta(){ try{ const raw = localStorage.getItem(STORAGE_KEY + '_meta'); if(!raw) return false; const m = JSON.parse(raw); fame = typeof m.fame === 'number' ? m.fame : fame; window._repSelection = m.repSelection || window._repSelection; return true;}catch(e){ return false; } }

    // End-round opener used by modules
    function openEndRoundForPlayer(playerKey){
      openEndRoundForPlayer; // no-op placeholder for lint clarity; real open below
    }
    // We'll provide a small wrapper used by module wiring
    function openEndRoundForPlayer(playerKey){
      // open the shared modal and note context
      endRoundContext = playerKey;
      openEndRoundForPlayer; // keep (no effect)
      openEndRoundForPlayer; // no-op safe
      openEndRoundForPlayer; // repeated no-op to avoid unused - harmless
      // Use the earlier defined openEndRoundForPlayer implementation:
      openEndRoundForPlayer_real(playerKey);
    }
    function openEndRoundForPlayer_real(playerKey){
      endRoundContext = playerKey;
      selectedCard = null;
      endroundConfirm.disabled = true;
      endroundModal.style.display='flex';
      endroundModal.setAttribute('aria-hidden','false');
      cardChoices.querySelectorAll('.choice-btn').forEach(b=>b.classList.remove('selected'));
    }

    // Reputation UI
    function buildRepRows(){
      const repWrap = document.getElementById('rep-wrap');
      repWrap.innerHTML = '';
      const top=document.createElement('div'); top.className='rep-row top';
      REP_TOP.forEach((label,i)=>{ const c=document.createElement('div'); c.className='rep-cell'; c.textContent=label; c.addEventListener('click', ()=>{ selectRepCell({row:'top',index:i}); saveMeta(); }); top.appendChild(c); });
      const mid=document.createElement('div'); mid.className='rep-row mid';
      REP_MID.forEach((label,i)=>{ const c=document.createElement('div'); c.className='rep-cell'; c.textContent=label; c.addEventListener('click', ()=>{ selectRepCell({row:'mid',index:i}); saveMeta(); }); mid.appendChild(c); });
      const bot=document.createElement('div'); bot.className='rep-row bot';
      REP_BOT.forEach((label,i)=>{ const c=document.createElement('div'); c.className='rep-cell'; c.textContent=label; c.addEventListener('click', ()=>{ selectRepCell({row:'bot',index:i}); saveMeta(); }); bot.appendChild(c); });
      repWrap.appendChild(top); repWrap.appendChild(mid); repWrap.appendChild(bot);
    }
    function selectRepCell(sel){
      const all = document.querySelectorAll('.rep-cell'); all.forEach(c=>c.classList.remove('selected'));
      const rowEl = document.querySelector(`.rep-row.${sel.row}`); if(!rowEl) return;
      const cells = rowEl.querySelectorAll('.rep-cell'); if(cells[sel.index]){ cells[sel.index].classList.add('selected'); window._repSelection = {...sel}; saveMeta(); }
    }
    function applyRepSelection(sel){
      if(!sel) return;
      const rowEl = document.querySelector(`.rep-row.${sel.row}`); if(!rowEl) return;
      const cells = rowEl.querySelectorAll('.rep-cell'); if(cells[sel.index]) cells[sel.index].classList.add('selected');
    }

    // Levels panel toggle behavior
    levelsToggleBtn.addEventListener('click', ()=>{
      const expanded = levelsToggleBtn.getAttribute('aria-expanded') === 'true';
      if(expanded){ levelsToggleBtn.setAttribute('aria-expanded','false'); levelsPanel.setAttribute('aria-hidden','true'); }
      else { levelsToggleBtn.setAttribute('aria-expanded','true'); levelsPanel.setAttribute('aria-hidden','false'); levelsPanel.focus(); renderLevelsPanel(); }
    });
    levelsPanel.addEventListener('blur', ()=>{
      setTimeout(()=>{ if(!levelsPanel.contains(document.activeElement) && document.activeElement !== levelsToggleBtn){ levelsToggleBtn.setAttribute('aria-expanded','false'); levelsPanel.setAttribute('aria-hidden','true'); } }, 10);
    });
    levelsPanel.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ levelsToggleBtn.setAttribute('aria-expanded','false'); levelsPanel.setAttribute('aria-hidden','true'); levelsToggleBtn.focus(); } });

    // Level modal OK
    document.getElementById('level-ok').addEventListener('click', ()=>{ levelModal.style.display='none'; levelModal.setAttribute('aria-hidden','true'); });

    // newGame resets both modules and GV deck/wounds
    function newGame(){
      if(!confirm('Start a new game? This will reset saved progress and values to defaults.')) return;
      try{
        localStorage.removeItem(`${STORAGE_KEY}_`);
        localStorage.removeItem(`${STORAGE_KEY}_gv_v2`);
        localStorage.removeItem(STORAGE_KEY + '_meta');
      }catch(e){}
      fame = 0;
      mainModule.resetInitial();
      gvModule.buildDefaultDeck();
      gvModule.load();
      gvModule.updateCounts && gvModule.updateCounts();
      window._repSelection = { row: 'mid', index: 0 };
      buildRepRows(); applyRepSelection(window._repSelection);
      updateFameUI(null);
      renderLevelsPanel();
    }

    // init wiring
    window.addEventListener('load', ()=>{
      mainModule.load(); mainModule.wire();
      gvModule.load(); gvModule.wire();

      buildRepRows();
      if(window._repSelection) applyRepSelection(window._repSelection);
      else { window._repSelection = { row: 'mid', index: 0 }; applyRepSelection(window._repSelection); saveMeta(); }

      // make sure decks exist
      mainModule.rebuildDeck();
      if(!Array.isArray(window._gv_deck_placeholder)) { gvModule.buildDefaultDeck(); }

      mainModule.updateViews();
      gvModule.updateCounts && gvModule.updateCounts();

      document.getElementById('fame-input').addEventListener('change', ()=>{ const prev=fame; fame=clampIntNonNeg(document.getElementById('fame-input').value); updateFameUI(prev); });
      document.querySelectorAll('.fame-inc').forEach(btn=> btn.addEventListener('click', ()=>{ const prev=fame; fame = Math.max(0, Number(fame) + Number(btn.dataset.inc||0)); updateFameUI(prev); }));

      // Hook main module draw end-round behaviour to open shared end-round modal
      // We need to override main module draw button behavior for end-round to open modal with context.
      // The module wiring already calls openEndRoundForPlayer when appropriate; provide the real opener for module code:
      window.openEndRoundForPlayer_real = openEndRoundForPlayer_real;

      // connect mainModule's internal openEndRoundForPlayer calls
      // ensure draw buttons for modules that reached end round open the shared modal
      document.querySelectorAll('[data-player="main"]').forEach(btn => {
        // buttons were wired in wire(); add a supplementary handler for end-round flow
        btn.addEventListener('click', ()=>{ /* no-op for supplementary */ });
      });

      // wire GV wound buttons and control wiring already done in gvModule.wire()

      // new game
      document.getElementById('new-game').addEventListener('click', newGame);

      renderLevelsPanel();
      setInterval(()=>{ mainModule.save(); gvModule.save && gvModule.save(); saveMeta(); }, 2000);
    });

    // Expose for debug
    window._main = mainModule;
    window._gv = gvModule;
  </script>
</body>
</html>
