<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mage Knight Companion â€” Dummy Player (Symbols)</title>
  <style>
    :root{
      --bg:#f4f4f4;
      --panel-bg:#ececec;
      --box-bg:#ffffff;
      --cell:#e8e8e8;
      --sel-rep:#bfe7c7;
      --sel-fame:#ffdca3;
      --gap:10px;
      --rep-min:44px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      background:var(--bg);
      color:#111;
      padding:12px;
    }
    h1{font-size:18px;margin:0 0 12px;text-align:center}
    .container{display:flex;flex-direction:column;gap:12px;max-width:900px;margin:0 auto}

    .boxed { background:var(--panel-bg); border-radius:10px; padding:10px; }
    .box-inner { background:var(--box-bg); border-radius:8px; padding:10px; display:flex; flex-direction:column; gap:10px; }
    h2{font-size:14px;margin:0}

    .rep-wrap{display:flex;flex-direction:column;gap:8px;width:100%;align-items:center}
    .rep-row{display:flex;gap:8px;align-items:center;justify-content:center}
    .rep-row .rep-cell{flex:0 0 auto;min-width:var(--rep-min);padding:6px 10px;background:var(--cell);border-radius:6px;text-align:center;cursor:pointer;font-size:13px;user-select:none}
    .rep-cell.selected{background:var(--sel-rep);font-weight:700}

    .fame-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type=number]{width:110px;padding:8px;border-radius:6px;border:1px solid #ccc;font-size:14px}
    .fame-result{font-weight:700;font-size:16px;padding:6px 8px;background:#fff;border-radius:6px}

    .combined-grid{display:flex;flex-direction:column;gap:8px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .cols{display:flex;gap:8px;align-items:flex-start;flex-wrap:wrap}
    .col{background:var(--box-bg);border-radius:8px;padding:8px;min-width:160px;flex:1}
    .col h3{font-size:13px;margin:0 0 6px 0}
    .smallbtn{font-size:13px;padding:6px 8px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer}
    .output{background:#fff;padding:8px;border-radius:6px;min-height:36px;font-size:13px;overflow:hidden}
    .stat{font-weight:700}

    .inline-item{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:8px}

    @media (max-width:820px){ .cols{flex-direction:column} .col{min-width:0} }
    @media (max-width:420px){
      :root{--rep-min:32px}
      input[type=number]{width:88px;padding:6px}
      .fame-result{font-size:14px}
      .rep-cell{font-size:12px;padding:5px 6px}
      .smallbtn{font-size:12px;padding:5px 6px}
    }
  </style>
</head>
<body>
  <h1>Mage Knight Companion</h1>

  <div class="container">

    <section class="boxed" aria-labelledby="rep-section">
      <div class="box-inner">
        <h2 id="rep-section">Reputation Track</h2>

        <div class="rep-wrap" id="rep-wrap" aria-label="Reputation three rows"></div>

        <div style="text-align:center;font-size:13px">Selected: <strong id="rep-display">0</strong></div>
      </div>
    </section>

    <section class="boxed" aria-labelledby="fame-section">
      <div class="box-inner">
        <h2 id="fame-section">Fame Track</h2>

        <div class="fame-row" role="group" aria-label="Fame input">
          <input id="fame-input" type="number" min="0" max="119" value="0" aria-label="Fame value" />
          <div class="fame-result" id="fame-result" aria-live="polite">Level 1</div>
          <div style="margin-left:auto;font-size:13px">Fame: <strong id="fame-display">0</strong></div>
        </div>
      </div>
    </section>

    <section class="boxed" aria-labelledby="combined-section">
      <div class="box-inner">
        <h2 id="combined-section">Dummy Player</h2>

        <div class="combined-grid">
          <div class="cols">
            <div class="col" aria-labelledby="crystal-title">
              <h3 id="crystal-title">Crystals</h3>
              <div class="inline-item">
                <div style="font-size:18px">ðŸ”´ <span class="stat" id="red">0</span></div>
                <div><button class="smallbtn" onclick="changeCrystal('red',1)">+</button><button class="smallbtn" onclick="changeCrystal('red',-1)">âˆ’</button></div>

                <div style="width:12px"></div>

                <div style="font-size:18px">ðŸ”µ <span class="stat" id="blue">0</span></div>
                <div><button class="smallbtn" onclick="changeCrystal('blue',1)">+</button><button class="smallbtn" onclick="changeCrystal('blue',-1)">âˆ’</button></div>
              </div>

              <div class="inline-item">
                <div style="font-size:18px">ðŸŸ¢ <span class="stat" id="green">0</span></div>
                <div><button class="smallbtn" onclick="changeCrystal('green',1)">+</button><button class="smallbtn" onclick="changeCrystal('green',-1)">âˆ’</button></div>

                <div style="width:12px"></div>

                <div style="font-size:18px">âšª <span class="stat" id="white">0</span></div>
                <div><button class="smallbtn" onclick="changeCrystal('white',1)">+</button><button class="smallbtn" onclick="changeCrystal('white',-1)">âˆ’</button></div>
              </div>
            </div>

            <div class="col" aria-labelledby="cards-title">
              <h3 id="cards-title">Cards</h3>
              <div class="inline-item">
                <div style="font-size:18px">ðŸ”´ <span class="stat" id="card-red">4</span></div>
                <div><button class="smallbtn" onclick="changeCard('Red',1)">+</button><button class="smallbtn" onclick="changeCard('Red',-1)">âˆ’</button></div>

                <div style="width:12px"></div>

                <div style="font-size:18px">ðŸ”µ <span class="stat" id="card-blue">4</span></div>
                <div><button class="smallbtn" onclick="changeCard('Blue',1)">+</button><button class="smallbtn" onclick="changeCard('Blue',-1)">âˆ’</button></div>
              </div>

              <div class="inline-item">
                <div style="font-size:18px">ðŸŸ¢ <span class="stat" id="card-green">4</span></div>
                <div><button class="smallbtn" onclick="changeCard('Green',1)">+</button><button class="smallbtn" onclick="changeCard('Green',-1)">âˆ’</button></div>

                <div style="width:12px"></div>

                <div style="font-size:18px">âšª <span class="stat" id="card-white">4</span></div>
                <div><button class="smallbtn" onclick="changeCard('White',1)">+</button><button class="smallbtn" onclick="changeCard('White',-1)">âˆ’</button></div>
              </div>
            </div>

            <div class="col" aria-labelledby="deck-title">
              <h3 id="deck-title">Deck & Discard</h3>
              <div style="margin-top:8px;font-size:13px">Cards in deck: <strong id="deck-count">0</strong></div>
            </div>
          </div>

          <div class="row" style="margin-top:6px;align-items:center">
            <button id="draw-btn" class="smallbtn" onclick="onDrawClick()">Draw</button>
            <div id="dummy-output" class="output" style="flex:1;margin-left:8px">Drawn symbols will appear here.</div>
          </div>

          <div style="margin-top:6px">
            <div style="font-weight:700;margin-bottom:6px">Discard Pile</div>
            <div id="discard-output" class="output">Discard pile is empty.</div>

            <div style="margin-top:8px;display:flex;justify-content:center">
              <button class="smallbtn" onclick="resetDeck()">Reset Deck</button>
            </div>
          </div>

        </div>
      </div>
    </section>

  </div>

  <script>
    // State
    let fame = 0;
    let crystals = { red: 0, blue: 0, green: 0, white: 0 };
    let cardCounts = { Red: 4, Blue: 4, Green: 4, White: 4 };
    let dummyDeck = [];
    let discardPile = [];
    let endRoundMode = false; // true when button should be "End Round" (i.e. next draw would produce 0)

    const repPositive = ["+1","+1","+2","+2","+3","+5"];
    const repNeutral = ["0","0","0"];
    const repNegative = ["-1","-1","-2","-3","-5","X"];

    const fameLevels = [
      {level:1, min:0,  max:2},
      {level:2, min:3,  max:7},
      {level:3, min:8,  max:14},
      {level:4, min:15, max:23},
      {level:5, min:24, max:34},
      {level:6, min:35, max:47},
      {level:7, min:48, max:62},
      {level:8, min:63, max:79},
      {level:9, min:80, max:98},
      {level:10,min:99, max:119}
    ];

    const colorSymbol = {
      Red: 'ðŸ”´', Blue: 'ðŸ”µ', Green: 'ðŸŸ¢', White: 'âšª',
      red: 'ðŸ”´', blue: 'ðŸ”µ', green: 'ðŸŸ¢', white: 'âšª'
    };

    const repWrap = document.getElementById('rep-wrap');
    const repDisplayEl = document.getElementById('rep-display');
    const fameInput = document.getElementById('fame-input');
    const fameResult = document.getElementById('fame-result');
    const fameDisplayEl = document.getElementById('fame-display');
    const dummyOutput = document.getElementById('dummy-output');
    const discardOutput = document.getElementById('discard-output');
    const drawBtn = document.getElementById('draw-btn');

    function buildRepRows() {
      repWrap.innerHTML = '';
      const topRow = document.createElement('div'); topRow.className = 'rep-row';
      repPositive.forEach(label => {
        const el = document.createElement('div'); el.className = 'rep-cell'; el.textContent = label;
        el.addEventListener('click', () => selectRep(el, label));
        topRow.appendChild(el);
      });
      const midRow = document.createElement('div'); midRow.className = 'rep-row';
      repNeutral.forEach(label => {
        const el = document.createElement('div'); el.className = 'rep-cell'; el.textContent = label;
        el.addEventListener('click', () => selectRep(el, label));
        midRow.appendChild(el);
      });
      const botRow = document.createElement('div'); botRow.className = 'rep-row';
      repNegative.forEach(label => {
        const el = document.createElement('div'); el.className = 'rep-cell'; el.textContent = label;
        el.addEventListener('click', () => selectRep(el, label));
        botRow.appendChild(el);
      });
      repWrap.appendChild(topRow);
      repWrap.appendChild(midRow);
      repWrap.appendChild(botRow);
    }

    function clearRepSelection() {
      Array.from(repWrap.querySelectorAll('.rep-cell')).forEach(c => c.classList.remove('selected'));
    }

    function selectRep(el, label) {
      clearRepSelection();
      el.classList.add('selected');
      repDisplayEl.textContent = label;
    }

    function getFameLevel(v) {
      const val = Math.max(0, Math.min(119, Math.floor(Number(v) || 0)));
      for (const b of fameLevels) if (val >= b.min && val <= b.max) return b.level;
      return 1;
    }
    function updateFameFromInput() {
      const val = Math.max(0, Math.min(119, Math.floor(Number(fameInput.value) || 0)));
      fame = val;
      const level = getFameLevel(fame);
      fameResult.textContent = `Level ${level}`;
      fameDisplayEl.textContent = fame;
    }

    function changeCrystal(color, amount) {
      const key = color.toLowerCase();
      crystals[key] = Math.max(0, (crystals[key] || 0) + amount);
      document.getElementById(key).textContent = crystals[key];
    }

    function changeCard(color, amount) {
      cardCounts[color] = Math.max(0, (cardCounts[color] || 0) + amount);
      document.getElementById(`card-${color.toLowerCase()}`).textContent = cardCounts[color];
    }

    function rebuildDeckFromCounts() {
      dummyDeck = [];
      Object.keys(cardCounts).forEach(color => {
        for (let i=0;i<cardCounts[color];i++) dummyDeck.push(`${color} Card`);
      });
      shuffle(dummyDeck);
      updateDeckCount();
    }

    function initializeDeck() {
      rebuildDeckFromCounts();
      discardPile = [];
      endRoundMode = false;
      updateDrawButton();
      updateDiscard();
      dummyOutput.textContent = 'Deck initialized and shuffled.';
    }
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

    function resetDeck(){
      initializeDeck();
    }

    function updateDrawButton(){
      drawBtn.textContent = endRoundMode ? 'End Round' : 'Draw';
    }

    // Called by the Draw/End Round button
    function onDrawClick(){
      if(endRoundMode){
        // End Round: move discard into deck, shuffle, clear discard, revert button
        if(discardPile.length > 0){
          dummyDeck.push(...discardPile);
          discardPile = [];
          shuffle(dummyDeck);
        }
        endRoundMode = false;
        updateDeckCount();
        updateDiscard();
        dummyOutput.textContent = 'Round ended. Deck reshuffled.';
        updateDrawButton();
        return;
      }

      // Normal draw
      const drawn = [];
      for(let i=0;i<3 && dummyDeck.length>0;i++){
        drawn.push(dummyDeck.pop());
      }

      // extra draws based on crystals matching last drawn color
      const last = drawn[drawn.length-1];
      if(last){
        const color = last.split(' ')[0].toLowerCase();
        const extra = crystals[color] || 0;
        for(let i=0;i<extra && dummyDeck.length>0;i++) drawn.push(dummyDeck.pop());
      }

      // If this draw produced zero drawn cards -> switch to End Round mode and change message
      if(drawn.length === 0){
        endRoundMode = true;
        updateDrawButton();
        dummyOutput.textContent = 'No cards drawn. End of round announced.';
        return;
      }

      // Otherwise, append drawn to discard and display symbols.
      discardPile.push(...drawn);
      const drawnSymbols = drawn.map(c => {
        const color = c.split(' ')[0];
        return colorSymbol[color] || c;
      });
      dummyOutput.textContent = drawnSymbols.join(' ');

      // If the draw emptied the deck (but at least one card was drawn), keep button as Draw.
      // Only a subsequent Draw attempt (which would draw 0) will flip button to End Round.
      updateDeckCount();
      updateDiscard();
    }

    function updateDeckCount(){ document.getElementById('deck-count').textContent = dummyDeck.length; }
    function updateDiscard(){
      if(discardPile.length===0){
        discardOutput.textContent = 'Discard pile is empty.';
        return;
      }
      const syms = discardPile.map(c => {
        const color = c.split(' ')[0];
        return colorSymbol[color] || c;
      });
      discardOutput.textContent = `Discard (${discardPile.length}): ${syms.join(' ')}`;
    }

    // Init
    fameInput.addEventListener('input', updateFameFromInput);
    window.addEventListener('load', ()=>{
      buildRepRows();
      document.getElementById('card-red').textContent = cardCounts.Red;
      document.getElementById('card-blue').textContent = cardCounts.Blue;
      document.getElementById('card-green').textContent = cardCounts.Green;
      document.getElementById('card-white').textContent = cardCounts.White;
      initializeDeck();
      const midCells = repWrap.querySelectorAll('.rep-row')[1]?.querySelectorAll('.rep-cell');
      if(midCells && midCells[1]) midCells[1].click();
      setTimeout(()=>{ updateFameFromInput(); }, 40);
    });

    // Expose for buttons
    window.changeCrystal = changeCrystal;
    window.changeCard = changeCard;
    window.resetDeck = resetDeck;
    window.onDrawClick = onDrawClick;
    window.drawDummyCards = onDrawClick; // backward compatibility
  </script>
</body>
</html>
